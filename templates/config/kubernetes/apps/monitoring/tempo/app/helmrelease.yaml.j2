#% if monitoring_enabled | default(false) and tracing_enabled | default(false) %#
---
# Note: Tempo's Helm chart does not support OCI registry (GitHub Issue #3068).
# Using HelmRepository (grafana) from Alloy deployment.
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
spec:
  chart:
    spec:
      chart: tempo
      version: "1.24.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: monitoring
  interval: 1h
  timeout: 10m
  values:
    # ==========================================================================
    # TEMPO SINGLE BINARY MODE (Recommended for homelab)
    # ==========================================================================
    # For production/scale: use tempo-distributed chart instead
    tempo:
      # Server configuration
      server:
        http_listen_port: 3200
        grpc_listen_port: 9095

      # Storage configuration (filesystem for homelab)
      storage:
        trace:
          backend: local
          local:
            path: /var/tempo/traces
          wal:
            path: /var/tempo/wal

      # Retention
      compactor:
        compaction:
          block_retention: "#{ trace_retention | default('72h') }#"

      # Distributor - receive traces
      distributor:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "0.0.0.0:4317"
              http:
                endpoint: "0.0.0.0:4318"
          # Zipkin receiver for Envoy Gateway (alternative to OTLP)
          zipkin:
            endpoint: "0.0.0.0:9411"

      # Query frontend
      query_frontend:
        search:
          max_duration: 0

      #| =========================================================================== #|
      #| Metrics Generator Configuration (UNDER tempo: key)                          #|
      #| Enables TraceQL metrics queries like { } | rate()                           #|
      #| Reference: https://grafana.com/docs/tempo/latest/metrics-from-traces/       #|
      #| =========================================================================== #|
      metricsGenerator:
        enabled: true
        remoteWriteUrl: "http://kube-prometheus-stack-prometheus:9090/api/v1/write"

      #| =========================================================================== #|
      #| Overrides: Enable local-blocks processor for TraceQL metrics               #|
      #| MUST use NEW format (defaults.metrics_generator.processors) consistently   #|
      #| Mixing formats triggers legacyConfig parsing error                         #|
      #| Reference: https://github.com/grafana/tempo/tree/main/example/docker-compose #|
      #| =========================================================================== #|
      overrides:
        defaults:
          metrics_generator:
            #| Enable processors for TraceQL metrics queries like { } | rate() #|
            processors:
              - local-blocks
              - service-graphs
              - span-metrics

    # Persistence
    persistence:
      enabled: true
      storageClassName: "#{ storage_class | default('local-path') }#"
      size: "#{ trace_storage_size | default('10Gi') }#"

    # Resources (homelab-appropriate)
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

    # Health probes for reliability
    readinessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 15
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 45
      periodSeconds: 30
      timeoutSeconds: 5

    # ServiceMonitor for Prometheus to scrape Tempo metrics
    serviceMonitor:
      enabled: true
#% endif %#