# Remaining Implementation Assessment

> **Document Version:** 2.7.0
> **Assessment Date:** January 2026
> **Last Updated:** January 7, 2026
> **Status:** Living Document
> **Sources:**
>
> - [k8s-at-home-remaining-implementation.md](../guides/k8s-at-home-remaining-implementation.md)
> - [gitops-components-implementation.md](../guides/gitops-components-implementation.md)
> - [envoy-gateway-observability-security.md](../guides/envoy-gateway-observability-security.md)
> - [envoy-gateway-examples-analysis.md](./envoy-gateway-examples-analysis.md)
> - [envoy-gateway-oidc-integration.md](./envoy-gateway-oidc-integration.md)
>
> **Implementation Guides:**
>
> - [VolSync with RustFS](../guides/volsync-rustfs-implementation.md)
> - [Talos Backup with RustFS](../guides/talos-backup-rustfs-implementation.md)
> - [JWT SecurityPolicy](../guides/completed/jwt-securitypolicy-implementation.md)
> - [tuppr Verification](../guides/tuppr-verification-guide.md)
> - [Native OIDC SecurityPolicy](../guides/completed/native-oidc-securitypolicy-implementation.md)
> - [OAuth2-Proxy ext_authz](../guides/oauth2-proxy-ext-authz-implementation.md)
> - [gRPC Routing](../guides/grpc-routing-implementation.md)
> - [Keycloak OIDC Provider](../guides/completed/keycloak-implementation.md)
> - [CloudNativePG Operator](../guides/completed/cnpg-implementation.md)
>
> **Shared Infrastructure (Deploy First):**
>
> - CloudNativePG → Keycloak (database dependency)
> - Keycloak → JWT SecurityPolicy, OIDC SecurityPolicy (OIDC provider dependency)

---

## Executive Summary

This document tracks **remaining work only**. Completed components are documented in their respective source guides with updated status.

### Quick Status

| Category | Items |
| -------- | ----- |
| **Deployed ✅** | Keycloak (January 7, 2026), JWT SecurityPolicy (January 7, 2026), OIDC SSO (January 7, 2026) |
| **Verified ✅** | CloudNativePG (operational, January 6, 2026), Talos Backup (operational, January 6, 2026), tuppr (operational, January 6, 2026) |
| **Templates Needed** | VolSync (~2 hours) |
| **Adopt When Needed** | gRPC Routing (~1-2 hours per service) |

---

## Remaining Work

### 1. VolSync (PVC Backup) - TEMPLATES NEEDED

> Source: [k8s-at-home-remaining-implementation.md](../guides/k8s-at-home-remaining-implementation.md#phase-2-volsync-pvc-backup)
> **Implementation Guide:** [volsync-rustfs-implementation.md](../guides/volsync-rustfs-implementation.md)

**Status:** Templates do not exist. Variables defined in `cluster.yaml` but commented out.

**Required Work:**

1. Create `templates/config/kubernetes/apps/storage/volsync/` directory structure
2. Create template files per implementation guide:
   - `ks.yaml.j2` - Flux Kustomization
   - `app/kustomization.yaml.j2`
   - `app/helmrelease.yaml.j2`
   - `app/ocirepository.yaml.j2`
   - `app/secret.sops.yaml.j2` - Restic credentials for RustFS
3. Update `templates/config/kubernetes/apps/storage/kustomization.yaml.j2` to include VolSync conditional
4. Configure `volsync_*` variables in `cluster.yaml`
5. Create RustFS access key via Console UI for `volsync-backups` bucket

**Effort:** ~2 hours

---

### 2. Talos Backup - ✅ DEPLOYED AND OPERATIONAL

> Source: [gitops-components-implementation.md](../guides/gitops-components-implementation.md#12-talos-backup)
> **Implementation Guide:** [talos-backup-rustfs-implementation.md](../guides/talos-backup-rustfs-implementation.md)

**Status:** Fully deployed and operational (January 6, 2026). Using internal RustFS backend.

**Verification Results:**

| Check | Status | Details |
| ----- | ------ | ------- |
| Kustomization | ✅ | Ready=True, Applied revision |
| HelmRelease | ✅ | Ready=True, Helm upgrade v2 succeeded |
| CronJob | ✅ | Active, schedule `0 */6 * * *` (every 6 hours) |
| S3 credentials secret | ✅ | `talos-backup-s3-credentials` created (SOPS) |
| Talos API secret | ✅ | `talos-backup-secrets` auto-generated by ServiceAccount |
| RustFS connectivity | ✅ | Internal endpoint via `.svc.cluster.local` |

**Implementation Completed:**

- ✅ All talos-backup templates wrapped with `talos_backup_enabled` conditional
- ✅ HelmRelease supports internal RustFS (`S3_FORCE_PATH_STYLE`, `S3_USE_SSL`)
- ✅ Kustomization depends on RustFS when `backup_s3_internal` is true
- ✅ `backup_s3_internal` derived variable added to `plugin.py`
- ✅ RustFS bucket setup job creates `etcd-backups` bucket
- ✅ `cluster.sample.yaml` documents both RustFS and R2 options
- ✅ Secret renamed to `talos-backup-s3-credentials` to avoid collision with Talos ServiceAccount auto-generated secret

**Secret Naming Convention:**

| Secret | Owner | Purpose |
| ------ | ----- | ------- |
| `talos-backup-secrets` | Talos ServiceAccount controller | Talos API access tokens (auto-generated) |
| `talos-backup-s3-credentials` | Flux Kustomization (SOPS) | S3 access keys + Age public key |

**Effort:** Completed

---

### 3. JWT SecurityPolicy (API Auth) - ✅ DEPLOYED AND OPERATIONAL

> Source: [envoy-gateway-observability-security.md](../guides/envoy-gateway-observability-security.md#phase-2-jwt-securitypolicy)
> **Implementation Guide:** [jwt-securitypolicy-implementation.md](../guides/completed/jwt-securitypolicy-implementation.md)

**Status:** Fully deployed and operational (January 7, 2026). Using Keycloak as OIDC provider.

**Use Case:** API/service-to-service authentication via Bearer tokens (stateless JWT validation).

**Verification Results:**

| Check | Status | Details |
| ----- | ------ | ------- |
| SecurityPolicy | ✅ | `jwt-auth` deployed in network namespace |
| OIDC Issuer | ✅ | `https://sso.matherly.net/realms/matherlynet` |
| JWKS URI | ✅ | `https://sso.matherly.net/realms/matherlynet/protocol/openid-connect/certs` |
| Claims Forwarding | ✅ | sub, email, groups, preferred_username, realm_access.roles |
| Cache Duration | ✅ | 300s JWKS cache |

**Configuration in cluster.yaml:**

```yaml
oidc_issuer_url: "https://sso.matherly.net/realms/matherlynet"
oidc_jwks_uri: "https://sso.matherly.net/realms/matherlynet/protocol/openid-connect/certs"
```

**Usage:** Label HTTPRoutes with `security: jwt-protected` to enable JWT validation.

**Effort:** Completed

---

### 4. tuppr - ✅ VERIFIED AND OPERATIONAL

> Source: [gitops-components-implementation.md](../guides/gitops-components-implementation.md#11-talos-upgrade-controller-tuppr)
> **Verification Guide:** [tuppr-verification-guide.md](../guides/tuppr-verification-guide.md)

**Status:** Fully verified and operational (January 6, 2026).

**Verification Results:**

| Check | Status | Details |
| ------- | -------- | --------- |
| Talos API patch | ✅ | `kubernetesTalosAPIAccess` enabled with `os:admin`, `os:etcd:backup` roles |
| tuppr pod | ✅ | Running in `system-upgrade` namespace |
| CRDs | ✅ | `talosupgrades.tuppr.home-operations.com`, `kubernetesupgrades.tuppr.home-operations.com` |
| TalosUpgrade CR | ✅ | Phase: Completed, Version: v1.12.0 |
| KubernetesUpgrade CR | ✅ | Phase: Completed, Version: v1.35.0 |
| Health checks | ✅ | All 6 nodes showing Ready=True |
| Logs | ✅ | No errors, reconciling successfully |

**Notes:**

- ServiceMonitor not created despite `enabled: true` - chart issue (non-blocking)
- Upgrade automation ready for next version bump in `cluster.yaml`

**Effort:** Completed

---

### 5. CloudNativePG Operator - ✅ DEPLOYED AND OPERATIONAL

> **Implementation Guide:** [cnpg-implementation.md](../guides/completed/cnpg-implementation.md)

**Status:** Fully deployed and operational (January 6, 2026). Shared infrastructure ready for Keycloak.

**Use Case:** Production-grade PostgreSQL operator providing automated HA, backups, and monitoring for database-dependent applications (Keycloak, future apps).

**Verification Results:**

| Check | Status | Details |
| ----- | ------ | ------- |
| Kustomization | ✅ | Ready=True, Applied revision |
| HelmRelease | ✅ | cloudnative-pg@0.27.0, Helm install succeeded |
| Operator Pod | ✅ | Running (1/1) in cnpg-system namespace |
| CRDs Installed | ✅ | 10 CRDs (clusters, backups, poolers, etc.) |
| PostgreSQL Clusters | ✅ | `keycloak-postgres` running in identity namespace (1/1 Ready) |

**Implementation Completed:**

- ✅ All cnpg-system templates created with `cnpg_enabled` conditional
- ✅ Derived variables added to `plugin.py`: `cnpg_enabled`, `cnpg_backup_enabled`, `cnpg_pgvector_enabled`
- ✅ Root kustomization updated to include cnpg-system
- ✅ CUE schema validation for CNPG configuration variables
- ✅ `cluster.sample.yaml` and GitHub test files updated with CNPG options
- ✅ RustFS IAM instructions documented for CNPG backups (`databases` group, `cnpg-backup` user)
- ✅ pgvector extension support documented (ImageVolume pattern for K8s 1.35+)
- ✅ Backup infrastructure templates created:
  - `secret-backup.sops.yaml.j2` - CNPG S3 backup credentials (conditional on `cnpg_backup_enabled`)
  - RustFS bucket setup job updated to create `cnpg-backups` bucket
  - Kustomization updated to include backup secret when enabled
- ✅ Observability templates created (conditional on `monitoring_enabled`):
  - `servicemonitor.yaml.j2` - Prometheus metrics scraping for operator
  - `prometheusrule.yaml.j2` - Alerts for cluster health, replication, backups
  - `dashboard-configmap.yaml.j2` - Grafana dashboard (auto-provisioned via sidecar)

**cluster.yaml variables:**

```yaml
cnpg_enabled: true                     # Enable operator deployment
cnpg_postgres_image: "ghcr.io/cloudnative-pg/postgresql:18.1-standard-trixie"
cnpg_storage_class: ""                 # Defaults to storage_class
cnpg_backup_enabled: false             # Enable S3 backups to RustFS
cnpg_priority_class: "system-cluster-critical"
cnpg_control_plane_only: true          # Schedule operator on control-plane
```

**Effort:** Completed

**Dependency Chain:** CloudNativePG ✅ → Keycloak → JWT/OIDC SecurityPolicy

---

### 6. Keycloak OIDC Provider - ✅ DEPLOYED AND OPERATIONAL

> **Implementation Guide:** [keycloak-implementation.md](../guides/completed/keycloak-implementation.md)

**Status:** Fully deployed and operational (January 7, 2026). Using CNPG PostgreSQL backend with Google IdP enabled.

**Use Case:** Self-hosted OIDC/OAuth2 provider enabling JWT SecurityPolicy (API auth) and OIDC SecurityPolicy (web SSO).

**Verification Results:**

| Check | Status | Details |
| ----- | ------ | ------- |
| Keycloak Pod | ✅ | `keycloak-0` running in identity namespace |
| Keycloak Operator | ✅ | Running (1/1) in identity namespace |
| PostgreSQL (CNPG) | ✅ | `keycloak-postgres-1` healthy (1/1 Ready) |
| Realm Import | ✅ | `matherlynet-realm` job completed |
| HTTPRoute | ✅ | `sso.matherly.net` accessible |
| Google IdP | ✅ | Social login enabled |
| OIDC SSO | ✅ | `oidc-sso` SecurityPolicy protecting Grafana, Hubble, RustFS |

**Configuration in cluster.yaml:**

```yaml
keycloak_enabled: true
keycloak_subdomain: "sso"              # Creates sso.matherly.net
keycloak_realm: "matherlynet"
keycloak_db_mode: "cnpg"               # Using CloudNativePG
keycloak_monitoring_enabled: true
google_idp_enabled: true               # Social login
oidc_sso_enabled: true                 # OIDC SSO SecurityPolicy active
```

**Protected Applications:**

- Grafana (`grafana.matherly.net`)
- Hubble UI (`hubble.matherly.net`)
- RustFS Console (`rustfs.matherly.net`)

**Optional Enhancement: OpenTelemetry Tracing**

- Keycloak 26.5.0 has full OpenTelemetry support (graduated from preview)
- Can export traces to existing Tempo deployment (`tempo.monitoring.svc:4317`)
- New variables: `keycloak_tracing_enabled`, `keycloak_tracing_sample_rate`
- See: [Keycloak Implementation Guide - Tracing Section](../guides/completed/keycloak-implementation.md#opentelemetry-tracing-integration)

**Effort:** Completed

**Dependency Chain:** CloudNativePG ✅ → Keycloak ✅ → JWT/OIDC SecurityPolicy ✅

---

### 7. gRPC Routing - ADOPT WHEN NEEDED

> **Implementation Guide:** [grpc-routing-implementation.md](../guides/grpc-routing-implementation.md)

**Status:** Pattern documented. Adopt when first gRPC service is deployed.

**Use Case:** Native gRPC traffic management via Gateway API GRPCRoute (GA since v1.1.0).

**Key Features:**

- Service/method-level routing matching
- Traffic splitting for canary deployments
- Request mirroring for shadow testing
- Header-based routing (gRPC metadata)
- JWT authentication works; OIDC (session-based) does NOT work for gRPC

**Required Work (When First gRPC Service Deployed):**

1. Add gRPC listener to internal Gateway:

   ```yaml
   - name: grpc
     protocol: HTTPS
     port: 443
     hostname: "grpc.${SECRET_DOMAIN}"
     allowedRoutes:
       kinds:
         - kind: GRPCRoute
   ```

2. Create GRPCRoute per service following template pattern
3. (Optional) Configure cluster-level variables

**cluster.yaml variables (optional):**

```yaml
grpc_gateway_enabled: false            # Enable gRPC listener on Gateway
grpc_hostname: "grpc.matherly.net"     # gRPC services hostname
grpc_default_port: 50051               # Default gRPC port
```

**Per-Service Template Pattern:**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: <service>
spec:
  parentRefs:
    - name: envoy-internal
      namespace: network
  hostnames:
    - "grpc.${SECRET_DOMAIN}"
  rules:
    - matches:
        - method:
            service: "<package>.<Service>"
      backendRefs:
        - name: <service>
          port: 50051
```

**Effort:** ~1-2 hours per gRPC service

**Note:** Hostname uniqueness enforced between GRPCRoute and HTTPRoute - use dedicated gRPC hostname.

---

## Priority Order

### Medium Priority (Templates Needed)

1. **VolSync Implementation** (~2 hours) - Only if PVC backups needed

### Low Priority (Adopt When Needed)

1. **gRPC Routing** - When first gRPC service deployed

### In Progress (Research Phase)

1. **Grafana Native SSO** - Research complete, implementation not started
   - See: [grafana-sso-authentication-integration-jan-2026.md](./grafana-sso-authentication-integration-jan-2026.md)

### Completed ✅

1. **CloudNativePG Operator** - Deployed January 6, 2026 (shared PostgreSQL infrastructure)
2. **Talos Backup Deployment** - Deployed January 6, 2026 (etcd disaster recovery)
3. **tuppr Deployment Verification** - Verified January 6, 2026
4. **Keycloak OIDC Provider** - Deployed January 7, 2026 (identity/SSO infrastructure)
5. **JWT SecurityPolicy** - Deployed January 7, 2026 (API authentication)
6. **OIDC SSO SecurityPolicy** - Deployed January 7, 2026 (web application SSO)

---

## Future Considerations

These are optional enhancements documented in source guides:

| Item | Source Guide | Implementation Guide | Notes |
| ---- | ------------ | -------------------- | ----- |
| **Native OIDC SecurityPolicy** | envoy-gateway-oidc-integration | [native-oidc-securitypolicy-implementation.md](../guides/completed/native-oidc-securitypolicy-implementation.md) | Web SSO (session-based) - templates documented |
| **OAuth2-Proxy ext_authz** | envoy-gateway-oidc-integration | [oauth2-proxy-ext-authz-implementation.md](../guides/oauth2-proxy-ext-authz-implementation.md) | Claims forwarding to backends |
| **gRPC Routing** | envoy-gateway-examples-analysis | [grpc-routing-implementation.md](../guides/grpc-routing-implementation.md) | Adopt when gRPC services deployed |
| Shared bjw-s Repository | k8s-at-home-remaining | - | Only for multiple bjw-s apps |
| ClusterSecretStore Templates | k8s-at-home-remaining | - | 1Password/Bitwarden/Vault |
| OTel Metrics Sink | envoy-gateway-examples-analysis | - | Unified observability (optional) |
| TCP/TLS Passthrough | envoy-gateway-examples-analysis | - | Adopt when needed |
| Merged Gateways | envoy-gateway-examples-analysis | - | Evaluate for resource optimization |

### OIDC Authentication Options (When Provider Available)

The project supports three OIDC authentication approaches:

1. **JWT SecurityPolicy** (Item #3 above) - For API/service-to-service auth
   - Template exists: `securitypolicy-jwt.yaml.j2`
   - Validates Bearer tokens, extracts claims to headers
   - **Guide:** [jwt-securitypolicy-implementation.md](../guides/completed/jwt-securitypolicy-implementation.md)

2. **Native OIDC SecurityPolicy** - For web browser SSO
   - Template patterns documented in implementation guide
   - Session-based auth with cookies, login redirect flow
   - **Guide:** [native-oidc-securitypolicy-implementation.md](../guides/completed/native-oidc-securitypolicy-implementation.md)

3. **OAuth2-Proxy ext_authz** - For advanced claims forwarding
   - Deploys OAuth2-Proxy with ext_authz filter
   - Forwards user info as X-Auth-Request-* headers
   - **Guide:** [oauth2-proxy-ext-authz-implementation.md](../guides/oauth2-proxy-ext-authz-implementation.md)

---

## Document Update Log

| Date | Version | Changes |
| ---- | ------- | ------- |
| 2026-01-06 | 1.0.0 | Initial assessment (k8s-at-home patterns) |
| 2026-01-06 | 1.1.0 | Added GitOps components assessment |
| 2026-01-06 | 1.2.0 | Added Envoy Gateway assessment; refactored to remaining-work-only format |
| 2026-01-06 | 1.3.0 | Added Envoy Gateway examples analysis; updated source doc with current status |
| 2026-01-06 | 1.4.0 | Added OIDC integration analysis; clarified JWT vs OIDC SSO distinction |
| 2026-01-06 | 1.5.0 | Added 7 new implementation guides: VolSync/RustFS, Talos Backup/RustFS, JWT SecurityPolicy, tuppr verification, Native OIDC, OAuth2-Proxy ext_authz, gRPC Routing |
| 2026-01-06 | 1.6.0 | Added Keycloak OIDC Provider implementation guide; updated JWT SecurityPolicy effort estimate |
| 2026-01-06 | 1.7.0 | Added CloudNativePG Operator implementation guide for shared PostgreSQL clusters |
| 2026-01-06 | 1.8.0 | Enhanced CNPG guide with pgvector extension support via Kubernetes ImageVolume |
| 2026-01-06 | 1.9.0 | Added detailed sub-sections for CloudNativePG (#5), Keycloak (#6), and gRPC Routing (#7); updated Quick Status and Priority Order to reflect shared infrastructure dependencies |
| 2026-01-06 | 2.0.0 | tuppr deployment verified operational; section #4 updated with verification results table; added to "Completed ✅" in Priority Order |
| 2026-01-06 | 2.1.0 | Talos Backup templates enhanced: conditional wrapping, RustFS internal support, `backup_s3_internal` derived variable, etcd-backups bucket in setup job; section #2 updated to "TEMPLATES COMPLETE, CONFIG READY" |
| 2026-01-06 | 2.2.0 | Talos Backup deployed and operational: fixed secret naming collision (`talos-backup-secrets` → `talos-backup-s3-credentials`), added verification results table, moved to "Completed ✅" |
| 2026-01-06 | 2.3.0 | CloudNativePG deployed and operational: templates created, derived variables added, CUE schema validation, RustFS IAM instructions documented, moved to "Completed ✅" |
| 2026-01-06 | 2.4.0 | CNPG backup infrastructure: added `secret-backup.sops.yaml.j2` template, updated RustFS bucket setup job to create `cnpg-backups` bucket, updated kustomization to include backup secret when `cnpg_backup_enabled` is true |
| 2026-01-06 | 2.5.0 | CNPG observability: added ServiceMonitor, PrometheusRule (7 alerts), and Grafana dashboard ConfigMap templates (conditional on `monitoring_enabled`) |
| 2026-01-06 | 2.6.0 | Keycloak OIDC Provider templates complete: 11 template files created, plugin.py updated with derived variables, CUE schema validation added, cluster.sample.yaml updated; ready for deployment |
| 2026-01-07 | 2.7.0 | **Major audit update:** Keycloak deployed and operational (CNPG mode, Google IdP enabled); JWT SecurityPolicy deployed; OIDC SSO SecurityPolicy deployed (protecting Grafana, Hubble, RustFS); Updated sections #3, #5, #6 with verification results; Updated Quick Status and Priority Order; Added Grafana Native SSO to In Progress |
