#% if obot_enabled | default(false) %#
---
#| ============================================================================= #|
#| OBOT MCP GATEWAY - AI Agent Platform with MCP Server Hosting                  #|
#| Uses jrmatherly/obot-entraid fork with Keycloak authentication provider       #|
#| REF: https://docs.obot.ai/                                                     #|
#| REF: https://github.com/jrmatherly/obot-entraid                               #|
#| REF: docs/research/obot-mcp-gateway-integration-jan-2026.md                   #|
#| ============================================================================= #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obot
  namespace: ai-system
spec:
  chartRef:
    kind: OCIRepository
    name: obot
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    #| ========================================================================= #|
    #| Image Configuration - jrmatherly/obot-entraid fork                        #|
    #| ========================================================================= #|
    image:
      repository: ghcr.io/jrmatherly/obot-entraid
      tag: v#{ obot_version | default('0.2.30') }#
      pullPolicy: IfNotPresent

    #| ========================================================================= #|
    #| Deployment Configuration                                                   #|
    #| ========================================================================= #|
    replicaCount: #{ obot_replicas | default(1) }#

#% if obot_workspace_provider | default('directory') == 's3' %#
    updateStrategy: RollingUpdate
#% else %#
    #| Recreate required for directory workspace provider (single PVC) #|
    updateStrategy: Recreate
#% endif %#

    #| ========================================================================= #|
    #| Service Configuration                                                      #|
    #| ========================================================================= #|
    service:
      type: ClusterIP
      port: 80

    #| Disable built-in ingress - use Gateway API HTTPRoute instead #|
    ingress:
      enabled: false

    #| ========================================================================= #|
    #| Extra Environment Variables from Secrets                                   #|
    #| Sensitive values from obot-secret (SOPS-encrypted) override chart config   #|
    #| ========================================================================= #|
    extraEnvFrom:
      - secretRef:
          name: obot-secret

    #| ========================================================================= #|
    #| Init Container - Wait for PostgreSQL to be ready                          #|
    #| Prevents app startup failures when DB isn't ready yet                     #|
    #| ========================================================================= #|
    initContainers:
      wait-for-postgres:
        image: ghcr.io/cloudnative-pg/postgresql:18.1-standard-trixie
        command:
          - /bin/sh
          - -c
          - |
            echo "Waiting for PostgreSQL to be ready..."
            until pg_isready -h obot-postgresql-rw.ai-system.svc.cluster.local -p 5432 -U #{ obot_postgres_user | default('obot') }#; do
              echo "PostgreSQL not ready, waiting..."
              sleep 2
            done
            echo "PostgreSQL is ready!"
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

    #| ========================================================================= #|
    #| Environment Configuration                                                  #|
    #| NOTE: Some secrets must be in config section for envFrom to work          #|
    #| (envFrom doesn't support $(VAR) interpolation)                            #|
    #| ========================================================================= #|
    config:
      #| Core server settings #|
      OBOT_SERVER_HOSTNAME: "https://#{ obot_hostname }#"
      #| DSN with embedded password (required because envFrom doesn't interpolate $(VAR)) #|
      OBOT_SERVER_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:#{ obot_db_password }#@obot-postgresql-rw.ai-system.svc.cluster.local:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
      OBOT_SERVER_MCPRUNTIME_BACKEND: "kubernetes"
      OBOT_SERVER_ENABLE_AUTHENTICATION: true

#% if obot_admin_emails | default('') %#
      #| Admin access (full platform access) #|
      OBOT_SERVER_AUTH_ADMIN_EMAILS: "#{ obot_admin_emails }#"
#% endif %#
#% if obot_owner_emails | default('') %#
      #| Owner access (highest privilege level) #|
      OBOT_SERVER_AUTH_OWNER_EMAILS: "#{ obot_owner_emails }#"
#% endif %#
      #| NOTE: OBOT_BOOTSTRAP_TOKEN provided via extraEnvFrom from obot-secret #|

#% if obot_keycloak_enabled | default(false) %#
      #| ======================================================================= #|
      #| Keycloak Auth Provider - jrmatherly/obot-entraid fork variables         #|
      #| NOTE: CLIENT_SECRET and COOKIE_SECRET from obot-secret via extraEnvFrom #|
      #| REF: https://github.com/jrmatherly/obot-entraid/blob/main/tools/keycloak-auth-provider/KEYCLOAK_SETUP.md #|
      #| ======================================================================= #|
      OBOT_SERVER_AUTH_PROVIDER: "keycloak"
      #| Base URL without /realms/{realm} - fork constructs issuer URL internally #|
      OBOT_KEYCLOAK_AUTH_PROVIDER_URL: "#{ obot_keycloak_base_url }#"
      OBOT_KEYCLOAK_AUTH_PROVIDER_REALM: "#{ obot_keycloak_realm }#"
      #| Allow all email domains (explicitly configured for clarity) #|
      OBOT_AUTH_PROVIDER_EMAIL_DOMAINS: "#{ obot_allowed_email_domains | default('*') }#"
      OBOT_KEYCLOAK_AUTH_PROVIDER_CLIENT_ID: "#{ obot_keycloak_client_id | default('obot') }#"
      #| Server URL - Required by keycloak-auth-provider tool for redirect URI construction #|
      #| REF: https://github.com/jrmatherly/obot-entraid/blob/main/tools/keycloak-auth-provider/main.go #|
      OBOT_SERVER_URL: "https://#{ obot_hostname }#"
      #| PostgreSQL session storage - avoids 4KB cookie limit that causes multi-cookie #|
      #| session failures with large Keycloak tokens (roles/groups)                    #|
      #| REF: https://github.com/obot-platform/obot/pull/5348                          #|
      OBOT_AUTH_PROVIDER_POSTGRES_CONNECTION_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:#{ obot_db_password }#@obot-postgresql-rw.ai-system.svc.cluster.local:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
#% if obot_keycloak_allowed_groups | default('') %#
      #| Optional: Restrict access to specific Keycloak groups #|
      OBOT_KEYCLOAK_AUTH_PROVIDER_ALLOWED_GROUPS: "#{ obot_keycloak_allowed_groups }#"
#% endif %#
#% if obot_keycloak_allowed_roles | default('') %#
      #| Optional: Restrict access to specific Keycloak roles #|
      OBOT_KEYCLOAK_AUTH_PROVIDER_ALLOWED_ROLES: "#{ obot_keycloak_allowed_roles }#"
#% endif %#
#% elif obot_entra_tenant_id | default('') %#
      #| ======================================================================= #|
      #| Entra ID (Azure AD) Auth Provider - Alternative to Keycloak            #|
      #| NOTE: CLIENT_ID and CLIENT_SECRET from obot-secret via extraEnvFrom    #|
      #| ======================================================================= #|
      OBOT_SERVER_AUTH_PROVIDER: "entra-id"
      OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID: "#{ obot_entra_tenant_id }#"
#% endif %#

      #| ======================================================================= #|
      #| Encryption Configuration                                                #|
      #| NOTE: Key must be in config for init container to read from obot-config #|
      #| ======================================================================= #|
#% if obot_encryption_provider | default('custom') == 'custom' %#
      OBOT_SERVER_ENCRYPTION_PROVIDER: "custom"
      #| Encryption key required by encryptionsetup init container #|
      OBOT_SERVER_ENCRYPTION_KEY: "#{ obot_encryption_key }#"
      #| Path to encryption config file (generated by encryptionsetup init container) #|
      OBOT_SERVER_ENCRYPTION_CONFIG_FILE: "/config/encryption.yaml"
#% endif %#

      #| ======================================================================= #|
      #| Tool Registry and Update Settings                                       #|
      #| ======================================================================= #|
      OBOT_SERVER_TOOL_REGISTRIES: "/obot-tools/tools"
      OBOT_SERVER_DISABLE_UPDATE_CHECK: "true"

#% if litellm_enabled | default(false) %#
      #| ======================================================================= #|
      #| LiteLLM Integration - Route LLM requests through proxy gateway          #|
      #| ======================================================================= #|
      OBOT_SERVER_LLM_BASE_URL: "http://litellm.ai-system.svc.cluster.local:4000/v1"
#% endif %#

#% if obot_tracing_enabled | default(false) %#
      #| ======================================================================= #|
      #| OpenTelemetry Tracing - Export to Tempo                                 #|
      #| NOTE: Tempo only supports traces, not metrics. The "failed to upload    #|
      #| metrics" error in logs is expected and non-fatal - traces still work.   #|
      #| ======================================================================= #|
      OBOT_SERVER_OTEL_BASE_EXPORT_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4317"
      OBOT_SERVER_OTEL_SAMPLE_PROB: "#{ obot_otel_sample_prob | default('0.1') }#"
#% endif %#

#% if obot_workspace_provider | default('directory') == 's3' %#
      #| ======================================================================= #|
      #| S3 Workspace Provider - For multi-replica deployments                   #|
      #| NOTE: AWS credentials from obot-secret via extraEnvFrom                 #|
      #| ======================================================================= #|
      OBOT_WORKSPACE_PROVIDER_TYPE: "s3"
      WORKSPACE_PROVIDER_S3_BUCKET: "#{ obot_s3_bucket }#"
      WORKSPACE_PROVIDER_S3_BASE_ENDPOINT: "#{ obot_s3_endpoint | default('http://rustfs-svc.storage.svc.cluster.local:9000') }#"
      AWS_REGION: "#{ obot_s3_region | default('us-east-1') }#"
      WORKSPACE_PROVIDER_S3_USE_PATH_STYLE: "true"
#% endif %#

    #| ========================================================================= #|
    #| Persistence Configuration                                                  #|
    #| ========================================================================= #|
#% if obot_workspace_provider | default('directory') == 's3' %#
    #| S3 workspace provider - no PVC needed #|
    persistence:
      enabled: false
#% else %#
    #| Directory workspace provider - requires PVC #|
    persistence:
      enabled: true
      storageClass: #{ obot_storage_class | default(storage_class) | default('local-path') }#
      size: #{ obot_storage_size | default('20Gi') }#
      accessMode: ReadWriteOnce
#% endif %#

    #| ========================================================================= #|
    #| MCP Runtime Configuration                                                  #|
    #| ========================================================================= #|
    mcpNamespace:
      name: #{ obot_mcp_namespace | default('obot-mcp') }#
      #| Namespace created by separate Kustomization #|
      create: false

    #| Default resource limits for dynamically spawned MCP servers #|
    mcpServerDefaults:
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL

    #| ========================================================================= #|
    #| Resource Configuration                                                     #|
    #| ========================================================================= #|
    resources:
      requests:
        cpu: "#{ obot_cpu_request | default('500m') }#"
        memory: "#{ obot_memory_request | default('1Gi') }#"
      limits:
        cpu: "#{ obot_cpu_limit | default('2000m') }#"
        memory: "#{ obot_memory_limit | default('4Gi') }#"

    #| ========================================================================= #|
    #| Security Context                                                           #|
    #| ========================================================================= #|
    podSecurityContext:
      fsGroup: 1000

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL

    #| ========================================================================= #|
    #| Health Probes                                                              #|
    #| ========================================================================= #|
    livenessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 15
      failureThreshold: 5
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    #| ========================================================================= #|
    #| Service Account and RBAC                                                   #|
    #| ========================================================================= #|
    serviceAccount:
      create: true
      name: obot

    rbac:
      create: true

#% if network_policies_enabled | default(false) %#
    #| ========================================================================= #|
    #| Network Policy Labels                                                      #|
    #| ========================================================================= #|
    podLabels:
      network.cilium.io/api-access: "true"
#% endif %#
#% endif %#
