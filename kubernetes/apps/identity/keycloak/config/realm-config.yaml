---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
  namespace: identity
data:
  realm.yaml: |
    realm: matherlynet
    enabled: true
    displayName: "Matherlynet Realm"

    ssoSessionIdleTimeout: 1800
    ssoSessionMaxLifespan: 36000
    accessTokenLifespan: 300
    accessTokenLifespanForImplicitFlow: 900

    offlineSessionIdleTimeout: 604800  # 7 days in seconds (7 * 24 * 60 * 60)
    offlineSessionMaxLifespan: 2592000  # 30 days in seconds (30 * 24 * 60 * 60)

    registrationAllowed: false
    resetPasswordAllowed: true
    rememberMe: true
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false


    bruteForceProtected: true
    permanentLockout: false
    maxFailureWaitSeconds: 900
    minimumQuickLoginWaitSeconds: 60
    waitIncrementSeconds: 60
    quickLoginCheckMilliSeconds: 1000
    maxDeltaTimeSeconds: 43200
    failureFactor: 5

    eventsEnabled: true
    eventsListeners:
      - "jboss-logging"
    adminEventsEnabled: true
    adminEventsDetailsEnabled: true

    enabledEventTypes:
      - "LOGIN"
      - "LOGIN_ERROR"
      - "LOGOUT"
      - "LOGOUT_ERROR"
      - "CODE_TO_TOKEN"
      - "CODE_TO_TOKEN_ERROR"
      - "REFRESH_TOKEN"
      - "REFRESH_TOKEN_ERROR"
      - "UPDATE_PASSWORD"
      - "UPDATE_PASSWORD_ERROR"
      - "REGISTER"
      - "REGISTER_ERROR"
      - "IDENTITY_PROVIDER_LOGIN"
      - "IDENTITY_PROVIDER_LOGIN_ERROR"
      - "UPDATE_PROFILE"
      - "UPDATE_PROFILE_ERROR"

    eventsExpiration: 604800  # days converted to seconds

    roles:
      realm:
        - name: "admin"
          description: "Full administrative access to all applications and settings"
        - name: "operator"
          description: "Operational access - manage services, view logs, restart pods"
        - name: "developer"
          description: "Development access - CI/CD, debugging tools, dev environments"
        - name: "viewer"
          description: "Read-only access to dashboards and status pages"
        - name: "user"
          description: "Basic authenticated user access to standard applications"

    groups:
      - name: "admin"
        path: "/admin"
        attributes:
          description: ["Platform administrators with full access"]
        realmRoles:
          - "admin"
      - name: "developer"
        path: "/developer"
        attributes:
          description: ["Development team with edit access"]
        realmRoles:
          - "developer"
      - name: "operator"
        path: "/operator"
        attributes:
          description: ["Operations/SRE team with operational access"]
        realmRoles:
          - "operator"
      - name: "viewer"
        path: "/viewer"
        attributes:
          description: ["Read-only access to dashboards and metrics"]
        realmRoles:
          - "viewer"

    clientScopes:
      - name: "groups"
        description: "OpenID Connect scope for group membership claims"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "Your group memberships"
        protocolMappers:
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"


      - name: "mcp:tools"
        description: "Access to MCP server tools"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "Access to MCP server tools"
        protocolMappers:
          - name: "mcp-audience"
            protocol: "openid-connect"
            protocolMapper: "oidc-audience-mapper"
            consentRequired: false
            config:
              included.custom.audience: "https://mcp.matherly.net"
              id.token.claim: "true"
              access.token.claim: "true"

      - name: "mcp:prompts"
        description: "Access to MCP server prompts"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "Access to MCP server prompts"

      - name: "mcp:resources"
        description: "Access to MCP server resources"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "Access to MCP server resources"

    clients:
      - clientId: "$(env:OIDC_CLIENT_ID)"
        name: "Envoy Gateway SSO"
        description: "OIDC client for Envoy Gateway SecurityPolicy - enables browser SSO across all protected applications"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:OIDC_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://hubble.matherly.net/oauth2/callback"
          - "https://grafana.matherly.net/oauth2/callback"
          - "https://rustfs.matherly.net/oauth2/callback"
        webOrigins:
          - "https://hubble.matherly.net"
          - "https://grafana.matherly.net"
          - "https://rustfs.matherly.net"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: >-
            https://hubble.matherly.net/*##https://grafana.matherly.net/*##https://rustfs.matherly.net/*
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
        optionalClientScopes:
          - "address"
          - "phone"
      - clientId: "$(env:GRAFANA_CLIENT_ID)"
        name: "Grafana"
        description: "OIDC client for Grafana native OAuth - provides RBAC and role-based access control"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:GRAFANA_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://grafana.matherly.net/login/generic_oauth"
        webOrigins:
          - "https://grafana.matherly.net"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://grafana.matherly.net/*"
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
          - "groups"
        optionalClientScopes:
          - "address"
          - "phone"
        protocolMappers:
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
      - clientId: "$(env:LANGFUSE_CLIENT_ID)"
        name: "Langfuse"
        description: "OIDC client for Langfuse LLM Observability - enables SSO for tracing, prompts, and evaluation"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:LANGFUSE_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://langfuse.matherly.net/api/auth/callback/keycloak"
        webOrigins:
          - "https://langfuse.matherly.net"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://langfuse.matherly.net/*"
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
        optionalClientScopes:
          - "address"
          - "phone"
      - clientId: "$(env:OBOT_CLIENT_ID)"
        name: "Obot MCP Gateway"
        description: "OIDC client for Obot MCP Gateway - enables SSO for AI agent platform with MCP server hosting"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:OBOT_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://obot.matherly.net/*"
          - "https://obot.matherly.net/oauth2/callback"
        webOrigins:
          - "https://obot.matherly.net"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://obot.matherly.net/*"
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
          - "groups"
        optionalClientScopes:
          - "address"
          - "phone"
        protocolMappers:
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
      - clientId: "$(env:MCP_CONTEXT_FORGE_CLIENT_ID)"
        name: "MCP Context Forge"
        description: "OIDC client for MCP Context Forge Gateway - enables SSO for multi-tenant MCP server registry"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:MCP_CONTEXT_FORGE_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://mcp.matherly.net/*"
          - "https://mcp.matherly.net/auth/callback"
        webOrigins:
          - "https://mcp.matherly.net"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://mcp.matherly.net/*"
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
          - "groups"
        optionalClientScopes:
          - "address"
          - "phone"
        protocolMappers:
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
      - clientId: "$(env:KUBERNETES_CLIENT_ID)"
        name: "Kubernetes API Server"
        description: "OIDC client for Kubernetes API Server authentication - enables kubectl and web UI access via OIDC tokens"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:KUBERNETES_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "http://localhost:8000/*"
          - "http://localhost:18000/*"
          - "https://headlamp.matherly.net/oidc-callback"
        webOrigins:
          - "+"
        attributes:
          pkce.code.challenge.method: ""
          post.logout.redirect.uris: "http://localhost:8000/*"
        defaultClientScopes:
          - "profile"
          - "email"
          - "offline_access"
          - "groups"  # Critical for RBAC group membership
        optionalClientScopes:
          - "address"
          - "phone"
        protocolMappers:
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: "email"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-property-mapper"
            consentRequired: false
            config:
              user.attribute: "email"
              claim.name: "email"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
              jsonType.label: "String"
          - name: "email_verified"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-property-mapper"
            consentRequired: false
            config:
              user.attribute: "emailVerified"
              claim.name: "email_verified"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
              jsonType.label: "boolean"

    identityProviders:
      - alias: "google"
        displayName: "Google"
        providerId: "google"
        enabled: true
        trustEmail: true
        storeToken: true
        linkOnly: false
        firstBrokerLoginFlowAlias: "first broker login"
        config:
          clientId: "$(env:GOOGLE_CLIENT_ID)"
          clientSecret: "$(env:GOOGLE_CLIENT_SECRET)"
          defaultScope: "openid profile email"
          syncMode: "IMPORT"

    identityProviderMappers:
      - name: "google-default-role"
        identityProviderAlias: "google"
        identityProviderMapper: "oidc-hardcoded-role-idp-mapper"
        config:
          syncMode: "INHERIT"
          role: "admin"

