#| =========================================================================== #|
#| CENTRALIZED HTTPROUTES - All web UIs routed through Envoy Gateway          #|
#| =========================================================================== #|
#| HTTPRoutes are centralized in the 'network' namespace to enable:            #|
#|   - Consistent SecurityPolicy application (OIDC/JWT protection)             #|
#|   - Simplified route management                                             #|
#|   - Cross-namespace backend references via ReferenceGrant                   #|
#|                                                                             #|
#| Routes may attach to:                                                       #|
#|   - envoy-internal: LAN-only access (UniFi DNS)                             #|
#|   - envoy-external: Public access (Cloudflare DNS + Tunnel)                 #|
#|   - Both: Split-horizon DNS (prevents asymmetric routing)                   #|
#|                                                                             #|
#| OIDC-PROTECTED ROUTES (label: security: oidc-protected):                    #|
#|   Routes with this label use Envoy Gateway SecurityPolicy for SSO.          #|
#|   Uses SPLIT-PATH architecture to avoid hairpin NAT/TLS issues:             #|
#|   - authorizationEndpoint: External URL (user browser → Keycloak)           #|
#|   - tokenEndpoint: Internal service (Envoy → keycloak-service:8080)         #|
#|   REF: docs/guides/completed/native-oidc-securitypolicy-implementation.md   #|
#|                                                                             #|
#| Routes that should NOT be centralized (Keycloak, webhooks) remain in        #|
#| their original namespaces for independent lifecycle management.             #|
#| =========================================================================== #|

#| =========================================================================== #|
#| HUBBLE UI - Cilium network observability dashboard                          #|
#| Internal only: No external access needed for network debugging              #|
#| =========================================================================== #|
#% if hubble_enabled | default(false) %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: hubble-ui
  namespace: network
  labels:
#% if oidc_sso_enabled | default(false) %#
    security: oidc-protected
#% endif %#
spec:
  hostnames:
    - "#{ hubble_subdomain | default('hubble') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| Internal gateway: UniFi DNS creates record (direct LAN access) #|
    - name: envoy-internal
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        - name: hubble-ui
          namespace: kube-system
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#

#| =========================================================================== #|
#| GRAFANA - Metrics visualization dashboard                                   #|
#| Internal only: Sensitive operational data, LAN access sufficient            #|
#| =========================================================================== #|
#% if monitoring_enabled | default(false) and monitoring_stack == 'prometheus' %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grafana
  namespace: network
  labels:
#% if oidc_sso_enabled | default(false) %#
    security: oidc-protected
#% endif %#
spec:
  hostnames:
    - "#{ grafana_subdomain | default('grafana') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| Internal gateway: UniFi DNS creates record (direct LAN access) #|
    - name: envoy-internal
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        - name: kube-prometheus-stack-grafana
          namespace: #{ observability_namespace | default('monitoring') }#
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#

#| =========================================================================== #|
#| RUSTFS CONSOLE - S3-compatible object storage management UI                 #|
#| Internal only: Infrastructure admin tool, LAN access only                   #|
#| NOTE: RustFS does not support OIDC SSO (as of 1.0.0-alpha.79)               #|
#|       Uses native authentication - separate credentials from Keycloak       #|
#|       REF: https://github.com/rustfs/rustfs/issues/726 (OIDC feature request) #|
#| =========================================================================== #|
#% if rustfs_enabled | default(false) %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: rustfs-console
  namespace: network
  #| No OIDC protection - RustFS uses built-in authentication #|
spec:
  hostnames:
    - "#{ rustfs_subdomain | default('rustfs') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| Internal gateway: UniFi DNS creates record (direct LAN access) #|
    - name: envoy-internal
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        - name: rustfs-svc
          namespace: storage
          port: 9001
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#

#| =========================================================================== #|
#| LITELLM - Unified LLM API Gateway                                           #|
#| Both gateways: Split-horizon DNS (prevents asymmetric routing)              #|
#|   - External users: Cloudflare DNS → envoy-external → LiteLLM               #|
#|   - Internal users: UniFi DNS → envoy-internal → LiteLLM                    #|
#| LiteLLM uses native SSO - no gateway-level OIDC protection needed           #|
#| REF: docs/research/litellm-proxy-gateway-integration-jan-2026.md            #|
#| =========================================================================== #|
#% if litellm_enabled | default(false) %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: litellm
  namespace: network
  #| No OIDC protection - LiteLLM uses native SSO via GENERIC_* env vars #|
spec:
  hostnames:
    - "#{ litellm_subdomain | default('litellm') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| External gateway: Cloudflare DNS creates record (public access via tunnel) #|
    - name: envoy-external
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        - name: litellm
          namespace: ai-system
          port: 4000
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#

#| =========================================================================== #|
#| LANGFUSE - LLM observability platform                                       #|
#| Both gateways: Split-horizon DNS (prevents asymmetric routing)              #|
#|   - External users: Cloudflare DNS → envoy-external → Langfuse              #|
#|   - Internal users: UniFi DNS → envoy-internal → Langfuse                   #|
#| NOTE: NO security label - Langfuse handles its own authentication via native #|
#|       SSO (AUTH_KEYCLOAK_*). Gateway OIDC would cause dual authentication.   #|
#| REF: docs/research/langfuse-seamless-sso-integration-jan-2026.md            #|
#| =========================================================================== #|
#% if langfuse_enabled | default(false) %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: langfuse
  namespace: network
  #| No OIDC protection - Langfuse uses native SSO via AUTH_KEYCLOAK_* env vars #|
spec:
  hostnames:
    - "#{ langfuse_subdomain | default('langfuse') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| External gateway: Cloudflare DNS creates record (public access via tunnel) #|
    - name: envoy-external
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        #| Langfuse web service from Helm chart #|
        - name: langfuse-web
          namespace: ai-system
          port: 3000
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#

#| =========================================================================== #|
#| OBOT - MCP Gateway and AI Agent Platform                                    #|
#| Both gateways: Split-horizon DNS (prevents asymmetric routing)              #|
#|   - External users: Cloudflare DNS → envoy-external → Obot                  #|
#|   - Internal users: UniFi DNS → envoy-internal → Obot                       #|
#| NOTE: NO security label - Obot uses native SSO via Keycloak auth provider   #|
#|       (OBOT_KEYCLOAK_AUTH_PROVIDER_*). Gateway OIDC would cause dual auth.  #|
#| REF: docs/research/obot-mcp-gateway-integration-jan-2026.md                 #|
#| =========================================================================== #|
#% if obot_enabled | default(false) %#
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: obot
  namespace: network
  #| No OIDC protection - Obot uses native SSO via OBOT_KEYCLOAK_AUTH_PROVIDER_* #|
spec:
  hostnames:
    - "#{ obot_subdomain | default('obot') }#.${SECRET_DOMAIN}"
  parentRefs:
    #| External gateway: Cloudflare DNS creates record (public access via tunnel) #|
    - name: envoy-external
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        #| Obot service from Helm chart (service port 80 → container port 8080) #|
        - name: obot-obot
          namespace: ai-system
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /
#% endif %#
