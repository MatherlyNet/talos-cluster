#% if langfuse_enabled | default(false) %#
---
#| ============================================================================= #|
#| LANGFUSE HELM RELEASE                                                         #|
#| LLM observability platform - tracing, prompts, evaluation, analytics          #|
#| REF: https://langfuse.com/self-hosting/deployment/kubernetes-helm            #|
#| REF: https://github.com/langfuse/langfuse-k8s/blob/main/charts/langfuse      #|
#| REF: docs/research/langfuse-llm-observability-integration-jan-2026.md        #|
#| ============================================================================= #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
  namespace: ai-system
spec:
  chart:
    spec:
      chart: langfuse
      version: "#{ langfuse_chart_version | default('*') }#"
      sourceRef:
        kind: HelmRepository
        name: langfuse
        namespace: ai-system
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    #| ========================================================================= #|
    #| Core Application Configuration                                           #|
    #| ========================================================================= #|
    langfuse:
      nextauth:
        url: "https://#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#"
        secret:
          value: ""
          secretKeyRef:
            name: langfuse-credentials
            key: NEXTAUTH_SECRET
      salt:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: SALT
      encryptionKey:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: ENCRYPTION_KEY

#% if langfuse_init_user_email | default('') and langfuse_init_user_password | default('') and langfuse_init_org_id | default('') %#
      #| ======================================================================= #|
      #| Headless Initialization - Bootstrap Initial Admin                      #|
      #| Creates admin account on first startup; credentials used only once     #|
      #| REF: https://langfuse.com/self-hosting/headless-initialization         #|
      #| ======================================================================= #|
      additionalEnv:
        #| Organization ID - Required for headless initialization #|
        - name: LANGFUSE_INIT_ORG_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_ID
        - name: LANGFUSE_INIT_ORG_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_NAME
        #| Initial admin user credentials (from SOPS-encrypted secret) #|
        - name: LANGFUSE_INIT_USER_EMAIL
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_EMAIL
        - name: LANGFUSE_INIT_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_PASSWORD
        - name: LANGFUSE_INIT_USER_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_NAME
#% if langfuse_disable_signup | default(false) %#
        #| Disable self-registration when using SSO as primary auth #|
        - name: AUTH_DISABLE_SIGNUP
          value: "true"
#% endif %#
#% if langfuse_default_org_role | default('') %#
        #| ===================================================================== #|
        #| Auto-Provisioning - Default access for new SSO users                 #|
        #| Assigns new users to default org/project with specified roles        #|
        #| REF: https://langfuse.com/self-hosting/automated-provisioning        #|
        #| ===================================================================== #|
        - name: LANGFUSE_DEFAULT_ORG_ROLE
          value: "#{ langfuse_default_org_role }#"
#% endif %#
#% if langfuse_default_project_role | default('') %#
        - name: LANGFUSE_DEFAULT_PROJECT_ROLE
          value: "#{ langfuse_default_project_role }#"
#% endif %#
#% endif %#

#% if langfuse_sso_enabled | default(false) %#
      #| ======================================================================= #|
      #| Keycloak SSO Configuration                                             #|
      #| ======================================================================= #|
      auth:
        #| Keep username/password as fallback for admin access #|
        disableUsernamePassword: false
        additionalProviders:
          - id: keycloak
            name: "Keycloak"
            clientId: "langfuse"
            clientSecret:
              secretKeyRef:
                name: langfuse-keycloak-credentials
                key: client-secret
            issuer: "#{ keycloak_issuer_url }#"
            allowDangerousEmailAccountLinking: true
#% endif %#

    #| ========================================================================= #|
    #| PostgreSQL - Use External CNPG Cluster                                   #|
    #| ========================================================================= #|
    postgresql:
      deploy: false
      host: "langfuse-postgresql-rw.ai-system.svc.cluster.local"
      port: 5432
      auth:
        username: "langfuse"
        existingSecret: "langfuse-postgresql-credentials"
        secretKeys:
          userPasswordKey: "password"
        database: "langfuse"

    #| ========================================================================= #|
    #| Redis - Use External Dragonfly                                           #|
    #| ========================================================================= #|
    redis:
      deploy: false
#% if dragonfly_enabled | default(false) %#
      host: "dragonfly.cache.svc.cluster.local"
      port: 6379
#% if dragonfly_acl_enabled | default(false) %#
      auth:
        username: "langfuse"
        existingSecret: "langfuse-redis-credentials"
        existingSecretPasswordKey: "password"
#% endif %#
#% endif %#

    #| ========================================================================= #|
    #| ClickHouse - Bundled for Analytics                                       #|
    #| ========================================================================= #|
    clickhouse:
      deploy: true
      replicaCount: #{ langfuse_clickhouse_replicas | default(1) }#
      persistence:
        enabled: true
        size: "#{ langfuse_clickhouse_storage | default('20Gi') }#"
        storageClass: "#{ cnpg_storage_class | default(storage_class) | default('local-path') }#"
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          memory: "4Gi"
      auth:
        existingSecret: "langfuse-clickhouse-credentials"
        existingSecretKey: "password"
      #| ZooKeeper persistence for ClickHouse cluster coordination #|
      zookeeper:
        persistence:
          enabled: true
          size: "#{ langfuse_zookeeper_storage | default('8Gi') }#"
          storageClass: "#{ cnpg_storage_class | default(storage_class) | default('local-path') }#"

    #| ========================================================================= #|
    #| S3 Storage - Use External RustFS                                         #|
    #| ========================================================================= #|
#% if rustfs_enabled | default(false) %#
    s3:
      deploy: false
      bucket: "langfuse-events"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
#% else %#
    s3:
      deploy: true
#% endif %#

    #| ========================================================================= #|
    #| Ingress / Gateway API                                                    #|
    #| ========================================================================= #|
    ingress:
      enabled: false

    #| ========================================================================= #|
    #| Resource Allocation                                                      #|
    #| ========================================================================= #|
    web:
      replicaCount: #{ langfuse_web_replicas | default(1) }#
      resources:
        requests:
          cpu: "#{ langfuse_web_cpu_request | default('200m') }#"
          memory: "#{ langfuse_web_memory_request | default('512Mi') }#"
        limits:
          memory: "#{ langfuse_web_memory_limit | default('2Gi') }#"

    worker:
      replicaCount: #{ langfuse_worker_replicas | default(1) }#
      resources:
        requests:
          cpu: "#{ langfuse_worker_cpu_request | default('200m') }#"
          memory: "#{ langfuse_worker_memory_request | default('512Mi') }#"
        limits:
          memory: "#{ langfuse_worker_memory_limit | default('2Gi') }#"

#% if langfuse_tracing_enabled | default(false) %#
    #| ========================================================================= #|
    #| OpenTelemetry Observability                                              #|
    #| ========================================================================= #|
    otel:
      enabled: true
      endpoint: "http://tempo.monitoring.svc.cluster.local:4318"
      serviceName: "langfuse"
      samplingRatio: "#{ langfuse_trace_sampling_ratio | default('0.1') }#"
#% endif %#
#% endif %#
