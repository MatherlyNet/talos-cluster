---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
  namespace: ai-system
spec:
  chart:
    spec:
      chart: langfuse
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: langfuse
        namespace: ai-system
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    langfuse:
      nextauth:
        url: "https://langfuse.matherly.net"
        secret:
          value: ""
          secretKeyRef:
            name: langfuse-credentials
            key: NEXTAUTH_SECRET
      salt:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: SALT
      encryptionKey:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: ENCRYPTION_KEY

      auth:
        disableUsernamePassword: false
        additionalProviders:
          - id: keycloak
            name: "Keycloak"
            clientId: "langfuse"
            clientSecret:
              secretKeyRef:
                name: langfuse-keycloak-credentials
                key: client-secret
            issuer: "https://sso.matherly.net/realms/matherlynet"
            allowDangerousEmailAccountLinking: true

    postgresql:
      deploy: false
      host: "langfuse-postgresql-rw.ai-system.svc.cluster.local"
      port: 5432
      auth:
        username: "langfuse"
        existingSecret: "langfuse-postgresql-credentials"
        secretKeys:
          userPasswordKey: "password"
        database: "langfuse"

    redis:
      deploy: false
      host: "dragonfly.cache.svc.cluster.local"
      port: 6379
      auth:
        username: "langfuse"
        existingSecret: "langfuse-redis-credentials"
        existingSecretPasswordKey: "password"

    clickhouse:
      deploy: true
      replicaCount: 1
      persistence:
        enabled: true
        size: "20Gi"
        storageClass: "proxmox-zfs"
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          memory: "4Gi"
      auth:
        existingSecret: "langfuse-clickhouse-credentials"
        existingSecretKey: "password"

    s3:
      deploy: false
      bucket: "langfuse-events"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY

    ingress:
      enabled: false

    web:
      replicaCount: 1
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          memory: "2Gi"

    worker:
      replicaCount: 1
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          memory: "2Gi"

    otel:
      enabled: true
      endpoint: "http://tempo.monitoring.svc.cluster.local:4318"
      serviceName: "langfuse"
      samplingRatio: "0.1"
