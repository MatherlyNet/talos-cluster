# Renovate Manifest Regeneration Workflow - Optional Enhancements

**Version:** 1.0.0
**Date:** January 14, 2026
**Status:** üìã **FUTURE IMPLEMENTATION** (After Base Workflow Testing)
**Base Workflow:** `.github/workflows/renovate-manifest-regen.yaml`

---

## Overview

This document provides ready-to-implement enhancements for the Renovate Manifest Regeneration workflow. These enhancements should be implemented **AFTER** the base workflow has been tested and validated in production use.

### Prerequisites

Before implementing any enhancements:

- [x] Base workflow implemented (‚úÖ Complete - `.github/workflows/renovate-manifest-regen.yaml`)
- [ ] Base workflow tested via manual trigger
- [ ] Base workflow enabled for automatic execution
- [ ] Base workflow running successfully for 3-5 Renovate PRs
- [ ] Team feedback collected on base workflow
- [ ] No workflow loops or failures in base workflow

**‚ö†Ô∏è DO NOT IMPLEMENT** these enhancements until all prerequisites are met.

---

## Enhancement Summary

| Enhancement | Benefit | Complexity | Risk | Priority |
| ------------- | --------- | ------------ | ------ | ---------- |
| **1. PR Comment Summary** | Better PR visibility | Low | Low | High |
| **2. Tofu Plan Output** | Review infrastructure changes in PR | Medium | Medium | High |
| **3. Slack/Discord Notifications** | Alert on failures | Low | Low | Medium |
| **4. Metrics Dashboard** | Track performance over time | Medium | Medium | Low |

### Recommended Implementation Order

1. **First:** PR Comment Summary (Enhancement 1)
2. **Second:** Tofu Plan Output (Enhancement 2)
3. **Third:** Slack/Discord Notifications (Enhancement 3)
4. **Fourth:** Metrics Dashboard (Enhancement 4)

---

## Enhancement 1: PR Comment Summary

### Description

Add a comment to the PR after the workflow completes with a summary of what was regenerated, including:
- List of modified files
- Workflow run link
- Status (success/no changes)
- Next steps for reviewer

### Benefits

- **Visibility:** Reviewers immediately see what was regenerated
- **Traceability:** Direct link to workflow run for debugging
- **Guidance:** Clear next steps for reviewing infrastructure changes
- **Transparency:** Team understands automation behavior

### Risk Assessment

**Risk Level:** üü¢ Low

- Minimal code changes (1 new step)
- No impact on core workflow logic
- Uses standard GitHub API
- Easily reversible
- No external dependencies

### Implementation

#### Step 1: Add Comment Step to Workflow

Add this step to the `regenerate-manifests` job in `.github/workflows/renovate-manifest-regen.yaml` after the "Commit generated files" step (around line 233):

```yaml
      # ------------------------------------------------------------------------
      # Step 7: Comment on PR with Summary
      # ------------------------------------------------------------------------
      - name: Comment on PR
        if: always()  # Run even if no changes
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }};
            const changed = '${{ steps.configure.outputs.changed }}' === 'true';
            const workflowUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            let body;

            if (changed) {
              body = `## ü§ñ Manifest Regeneration Complete ‚úÖ

**Status:** Generated files updated and committed

The workflow has regenerated infrastructure manifests from template changes and committed them to this PR.

### What Was Regenerated

The following directories may contain updated files:
- \`infrastructure/\` - OpenTofu/Terraform configurations
- \`talos/\` - Talos machine configurations
- \`bootstrap/\` - Bootstrap Kubernetes resources
- \`kubernetes/\` - Kubernetes manifests (if modified)

**Review the [Files Changed](${context.payload.pull_request.html_url}/files) tab to see exactly what was updated.**

### Next Steps for Reviewer

1. **Review Generated Changes:** Check the Files Changed tab for \`infrastructure/\`, \`talos/\`, \`bootstrap/\` updates
2. **Preview Infrastructure Changes:** Run \`task infra:plan\` locally to see OpenTofu plan output
3. **Verify Template Logic:** Ensure generated files match expected template rendering
4. **Approve When Ready:** Generated files are automatically in sync with templates

### Workflow Details

- **Triggered by:** ${context.payload.sender.login}
- **Workflow run:** [View logs](${workflowUrl})
- **Commit:** See above ‚¨ÜÔ∏è

---

*This comment was automatically generated by the [Renovate Manifest Regeneration workflow](${workflowUrl}).*`;
            } else {
              body = `## ü§ñ Manifest Regeneration Complete ‚ÑπÔ∏è

**Status:** No changes needed

Template changes did not result in modifications to generated files. This is normal for certain types of template updates (e.g., comments, formatting, conditional logic that didn't trigger).

### Workflow Details

- **Triggered by:** ${context.payload.sender.login}
- **Workflow run:** [View logs](${workflowUrl})

---

*This comment was automatically generated by the [Renovate Manifest Regeneration workflow](${workflowUrl}).*`;
            }

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
```

#### Step 2: Update Workflow Summary Step

Replace the existing "Workflow summary" step (lines 237-263) with this enhanced version:

```yaml
      # ------------------------------------------------------------------------
      # Step 6: Summary (Updated)
      # ------------------------------------------------------------------------
      - name: Workflow summary
        run: |
          echo "## Manifest Regeneration Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.configure.outputs.changed }}" == "true" ]]; then
            echo "‚úÖ **Generated files updated and committed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Regenerated manifests have been committed to this PR branch." >> $GITHUB_STEP_SUMMARY
            echo "A comment has been added to the PR with details." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **No changes needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Template changes did not result in modifications to generated files." >> $GITHUB_STEP_SUMMARY
            echo "A comment has been added to the PR with details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered By" >> $GITHUB_STEP_SUMMARY
          echo "- **Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "- **PR Number:** #${{ github.event.inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          fi
```

### Testing Procedure

1. **Manual Trigger Test:**
   ```bash
   # Trigger workflow on test PR
   gh workflow run "Renovate Manifest Regeneration" -f pr_number=123

   # Wait for completion
   sleep 60

   # Check for PR comment
   gh pr view 123 --json comments --jq '.comments[-1].body'
   # Should show comment with summary
   ```

2. **Verify Comment Contents:**
   - [ ] Comment appears on PR
   - [ ] Status correctly reflects changes (‚úÖ or ‚ÑπÔ∏è)
   - [ ] Workflow run link works
   - [ ] File change link works
   - [ ] Formatting renders correctly (markdown)

3. **Test Both Scenarios:**
   - [ ] With changes: Verify "Generated files updated" message
   - [ ] Without changes: Verify "No changes needed" message

### Activation

Once tested and validated:

```bash
# Changes are already in workflow file from implementation
git add .github/workflows/renovate-manifest-regen.yaml
git commit -m "feat(ci): add PR comment summary to Renovate workflow"
git push
```

### Rollback

To remove this enhancement:

```bash
# Comment out or remove the "Comment on PR" step
# Revert the workflow summary step to original version
git revert <commit-hash>
git push
```

### Monitoring

After activation, verify:
- [ ] Comments appear on all Renovate PRs with template changes
- [ ] Comment format is correct and readable
- [ ] No duplicate comments on workflow re-runs
- [ ] Links in comments are valid

---

## Enhancement 2: Tofu Plan Output

### Description

Run `task infra:plan` after regenerating manifests and include the OpenTofu plan output in the PR comment. This allows reviewers to see infrastructure changes directly in the PR without running commands locally.

### Benefits

- **Immediate Review:** See infrastructure changes without local setup
- **Diff Visibility:** Understand what will change in Proxmox/infrastructure
- **Safety:** Review before merge prevents unexpected infrastructure changes
- **Audit Trail:** Plan output preserved in PR comments

### Risk Assessment

**Risk Level:** üü° Medium

**Risks:**
- Longer workflow runtime (+2-5 minutes)
- Requires infrastructure/ directory validation
- Plan output may be very large (comment size limits)
- May expose sensitive data in plan output (need sanitization)
- OpenTofu state access required

**Mitigations:**
- Add timeout limits
- Truncate large plan outputs
- Sanitize sensitive data before posting
- Use collapsible markdown sections
- Make this step optional (continue on error)

### Implementation

#### Step 1: Add Plan Generation Step

Add this step to the `regenerate-manifests` job after the "Run task configure" step (around line 208):

```yaml
      # ------------------------------------------------------------------------
      # Step 5: Generate OpenTofu Plan (Optional)
      # ------------------------------------------------------------------------
      - name: Generate infrastructure plan
        id: tofu-plan
        if: steps.configure.outputs.changed == 'true'
        continue-on-error: true  # Don't fail workflow if plan fails
        working-directory: infrastructure
        run: |
          echo "::group::Running task infra:plan"

          # Initialize OpenTofu (required for plan)
          task infra:init

          # Generate plan and save output
          task infra:plan > plan_output.txt 2>&1 || true

          echo "::endgroup::"

          # Check if plan succeeded
          if [[ -f plan_output.txt ]]; then
            # Truncate if too large (max 60000 chars for GitHub comment)
            if [[ $(wc -c < plan_output.txt) -gt 60000 ]]; then
              echo "plan_truncated=true" >> $GITHUB_OUTPUT
              head -c 60000 plan_output.txt > plan_output_truncated.txt
              echo "" >> plan_output_truncated.txt
              echo "... (output truncated, view full plan in workflow logs)" >> plan_output_truncated.txt
              mv plan_output_truncated.txt plan_output.txt
            else
              echo "plan_truncated=false" >> $GITHUB_OUTPUT
            fi

            # Save plan for next step
            {
              echo 'plan_output<<PLAN_OUTPUT_EOF'
              cat plan_output.txt
              echo 'PLAN_OUTPUT_EOF'
            } >> $GITHUB_OUTPUT

            echo "plan_generated=true" >> $GITHUB_OUTPUT
          else
            echo "plan_generated=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------------------
      # Step 6: Commit Generated Files (Same as before)
      # ------------------------------------------------------------------------
      - name: Commit generated files
        if: steps.configure.outputs.changed == 'true'
        run: |
          # ... (existing commit step, unchanged)
```

#### Step 2: Update PR Comment to Include Plan

Update the PR comment step (from Enhancement 1) to include plan output:

```yaml
      # ------------------------------------------------------------------------
      # Step 8: Comment on PR with Summary + Plan
      # ------------------------------------------------------------------------
      - name: Comment on PR
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }};
            const changed = '${{ steps.configure.outputs.changed }}' === 'true';
            const planGenerated = '${{ steps.tofu-plan.outputs.plan_generated }}' === 'true';
            const planTruncated = '${{ steps.tofu-plan.outputs.plan_truncated }}' === 'true';
            const planOutput = `${{ steps.tofu-plan.outputs.plan_output }}`;
            const workflowUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            let body;

            if (changed) {
              body = `## ü§ñ Manifest Regeneration Complete ‚úÖ

**Status:** Generated files updated and committed

The workflow has regenerated infrastructure manifests from template changes and committed them to this PR.

### What Was Regenerated

The following directories may contain updated files:
- \`infrastructure/\` - OpenTofu/Terraform configurations
- \`talos/\` - Talos machine configurations
- \`bootstrap/\` - Bootstrap Kubernetes resources
- \`kubernetes/\` - Kubernetes manifests (if modified)

**Review the [Files Changed](${context.payload.pull_request.html_url}/files) tab to see exactly what was updated.**`;

              // Add plan output if available
              if (planGenerated) {
                body += `

### üìã OpenTofu Plan Output

<details>
<summary>Click to expand infrastructure plan${planTruncated ? ' (truncated)' : ''}</summary>

\`\`\`hcl
${planOutput}
\`\`\`

${planTruncated ? `‚ö†Ô∏è **Plan output was truncated.** [View full output in workflow logs](${workflowUrl})` : ''}

</details>`;
              } else {
                body += `

### üìã OpenTofu Plan Output

‚ö†Ô∏è Plan generation failed or was skipped. [View workflow logs](${workflowUrl}) for details.`;
              }

              body += `

### Next Steps for Reviewer

1. **Review Generated Changes:** Check the Files Changed tab for \`infrastructure/\`, \`talos/\`, \`bootstrap/\` updates
2. **Review Infrastructure Plan:** ${planGenerated ? 'See plan output above ‚¨ÜÔ∏è' : 'Run `task infra:plan` locally to preview changes'}
3. **Verify Template Logic:** Ensure generated files match expected template rendering
4. **Approve When Ready:** Generated files are automatically in sync with templates

### Workflow Details

- **Triggered by:** ${context.payload.sender.login}
- **Workflow run:** [View logs](${workflowUrl})
- **Commit:** See above ‚¨ÜÔ∏è

---

*This comment was automatically generated by the [Renovate Manifest Regeneration workflow](${workflowUrl}).*`;
            } else {
              body = `## ü§ñ Manifest Regeneration Complete ‚ÑπÔ∏è

**Status:** No changes needed

Template changes did not result in modifications to generated files. This is normal for certain types of template updates (e.g., comments, formatting, conditional logic that didn't trigger).

### Workflow Details

- **Triggered by:** ${context.payload.sender.login}
- **Workflow run:** [View logs](${workflowUrl})

---

*This comment was automatically generated by the [Renovate Manifest Regeneration workflow](${workflowUrl}).*`;
            }

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
```

#### Step 3: Add Infrastructure Backend Configuration

Ensure OpenTofu backend is properly configured for CI/CD access. Update `templates/config/infrastructure/tofu/backend.tf.j2` if needed:

```hcl
terraform {
  backend "s3" {
    # Configuration should already be present
    # Verify R2 credentials are available in GitHub Actions environment
    # via secrets or other secure mechanism
  }
}
```

**Note:** If using R2 backend, ensure `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are available as GitHub Actions secrets.

### Testing Procedure

1. **Local Plan Test:**
   ```bash
   # Verify plan works locally first
   cd infrastructure
   task infra:init
   task infra:plan
   # Should succeed without errors
   ```

2. **Workflow Test with Plan:**
   ```bash
   # Trigger on test PR with infrastructure changes
   gh workflow run "Renovate Manifest Regeneration" -f pr_number=123

   # Monitor run
   gh run watch

   # Check PR comment for plan output
   gh pr view 123 --json comments --jq '.comments[-1].body' | grep "OpenTofu Plan Output"
   ```

3. **Verify Plan Output:**
   - [ ] Plan section appears in PR comment
   - [ ] Plan output is properly formatted (code block)
   - [ ] Plan shows expected resources changes
   - [ ] Truncation works correctly for large plans
   - [ ] Links to workflow logs work
   - [ ] Collapsible section expands/collapses correctly

### Activation

**Prerequisites:**
- Enhancement 1 (PR Comment Summary) must be implemented first
- Infrastructure backend access configured in GitHub Actions
- Secrets configured: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` (if using R2)

```bash
# Add plan generation step and update comment step
git add .github/workflows/renovate-manifest-regen.yaml
git commit -m "feat(ci): add OpenTofu plan output to Renovate workflow"
git push
```

### Troubleshooting

| Issue | Cause | Solution |
| ------- | ------- | ---------- |
| Plan step fails | Backend not initialized | Verify R2 credentials in GitHub secrets |
| Plan output empty | task infra:plan not generating output | Check task definition, verify working directory |
| Plan truncated | Output >60KB | View full plan in workflow logs, link provided |
| Sensitive data exposed | Plan includes secrets | Add sanitization step before posting |

### Rollback

```bash
# Remove plan generation step and revert comment step
git revert <commit-hash>
git push
```

### Monitoring

After activation:
- [ ] Plan generation succeeds on all infrastructure changes
- [ ] Plan output appears correctly formatted in PR comments
- [ ] No secrets or sensitive data exposed in plans
- [ ] Workflow runtime remains acceptable (<10 minutes)

---

## Enhancement 3: Slack/Discord Notifications

### Description

Send notifications to Slack or Discord when the workflow fails, allowing the team to respond quickly to issues.

### Benefits

- **Immediate Alerts:** Know right away when regeneration fails
- **Team Visibility:** Entire team aware of workflow issues
- **Faster Response:** Reduce time to resolution
- **Context Rich:** Notification includes PR link, error details

### Risk Assessment

**Risk Level:** üü¢ Low

**Risks:**
- Notification noise if workflow fails frequently
- Webhook URL is a secret (must be protected)
- External dependency (Slack/Discord must be available)

**Mitigations:**
- Only notify on failure (not success)
- Store webhook URL as GitHub secret
- Make notification step optional (continue-on-error)
- Include rate limiting if needed

### Implementation

#### Step 1: Create Webhook URL

**For Slack:**
1. Go to https://api.slack.com/messaging/webhooks
2. Create new Incoming Webhook for your workspace
3. Choose channel (e.g., `#infrastructure-alerts`)
4. Copy webhook URL (format: `https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXX`)

**For Discord:**
1. Go to Server Settings ‚Üí Integrations ‚Üí Webhooks
2. Create New Webhook
3. Choose channel (e.g., `#infrastructure-alerts`)
4. Copy webhook URL (format: `https://discord.com/api/webhooks/123456789/XXXXXXXXXXXX`)

#### Step 2: Add Webhook Secret to GitHub

```bash
# Add secret via GitHub CLI
gh secret set SLACK_WEBHOOK_URL --body "https://hooks.slack.com/services/..."

# OR for Discord
gh secret set DISCORD_WEBHOOK_URL --body "https://discord.com/api/webhooks/..."

# Verify secret is set
gh secret list | grep WEBHOOK
```

#### Step 3: Add Notification Step to Workflow

Add this step at the end of the `regenerate-manifests` job (after all other steps):

```yaml
      # ------------------------------------------------------------------------
      # Step 9: Notify on Failure (Slack/Discord)
      # ------------------------------------------------------------------------
      - name: Notify on failure
        if: failure()
        continue-on-error: true  # Don't fail workflow if notification fails
        run: |
          # Determine which webhook to use (prefer Slack, fall back to Discord)
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          NOTIFICATION_TYPE="slack"

          if [[ -z "$WEBHOOK_URL" ]]; then
            WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            NOTIFICATION_TYPE="discord"
          fi

          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "No webhook URL configured, skipping notification"
            exit 0
          fi

          # Build notification payload
          PR_NUMBER="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url || format('https://github.com/{0}/pull/{1}', github.repository, github.event.inputs.pr_number) }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [[ "$NOTIFICATION_TYPE" == "slack" ]]; then
            # Slack webhook payload
            curl -X POST "$WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d @- <<EOF
          {
            "text": "üö® Renovate Manifest Regeneration Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Renovate Manifest Regeneration Failed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*PR:*\n<${PR_URL}|#${PR_NUMBER}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.head_ref }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "The workflow failed while regenerating infrastructure manifests. This may be due to template errors, missing dependencies, or configuration issues."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow Logs"
                    },
                    "url": "${WORKFLOW_URL}",
                    "style": "danger"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Pull Request"
                    },
                    "url": "${PR_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          else
            # Discord webhook payload
            curl -X POST "$WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d @- <<EOF
          {
            "embeds": [
              {
                "title": "üö® Renovate Manifest Regeneration Failed",
                "description": "The workflow failed while regenerating infrastructure manifests.",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  },
                  {
                    "name": "Pull Request",
                    "value": "[#${PR_NUMBER}](${PR_URL})",
                    "inline": true
                  },
                  {
                    "name": "Triggered by",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "${{ github.head_ref }}",
                    "inline": true
                  }
                ],
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "footer": {
                  "text": "Renovate Manifest Regeneration"
                }
              }
            ],
            "components": [
              {
                "type": 1,
                "components": [
                  {
                    "type": 2,
                    "style": 5,
                    "label": "View Workflow Logs",
                    "url": "${WORKFLOW_URL}"
                  },
                  {
                    "type": 2,
                    "style": 5,
                    "label": "View Pull Request",
                    "url": "${PR_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          fi

          echo "Notification sent to $NOTIFICATION_TYPE"
```

### Testing Procedure

1. **Test Webhook URL:**
   ```bash
   # Test Slack webhook
   curl -X POST "$SLACK_WEBHOOK_URL" \
     -H 'Content-Type: application/json' \
     -d '{"text":"Test message from Renovate workflow"}'

   # OR test Discord webhook
   curl -X POST "$DISCORD_WEBHOOK_URL" \
     -H 'Content-Type: application/json' \
     -d '{"content":"Test message from Renovate workflow"}'
   ```

2. **Trigger Test Failure:**
   ```bash
   # Temporarily break workflow to test notification
   # Option A: Modify task configure to fail
   # Option B: Manually fail the workflow in GitHub Actions UI

   # Trigger workflow
   gh workflow run "Renovate Manifest Regeneration" -f pr_number=123

   # Wait for failure
   gh run watch

   # Check Slack/Discord channel for notification
   ```

3. **Verify Notification:**
   - [ ] Notification appears in correct channel
   - [ ] All fields populated correctly (repo, PR, actor, branch)
   - [ ] Links work (workflow logs, PR)
   - [ ] Formatting renders correctly
   - [ ] Timestamp is accurate

### Activation

**Prerequisites:**
- Slack or Discord webhook URL created
- Webhook URL added to GitHub secrets
- Test notification successful

```bash
# Add notification step to workflow
git add .github/workflows/renovate-manifest-regen.yaml
git commit -m "feat(ci): add Slack/Discord notifications to Renovate workflow"
git push
```

### Configuration Options

**Customize Notification Triggers:**

```yaml
# Current: Only on failure
if: failure()

# Alternative: On failure OR cancellation
if: failure() || cancelled()

# Alternative: Always (including success)
if: always()
```

**Customize Message Content:**

Edit the JSON payload in the notification step to include:
- Additional fields (commit SHA, author, etc.)
- Different emoji/styling
- @mentions for specific team members
- Links to documentation

### Rollback

```bash
# Remove notification step
git revert <commit-hash>
git push

# OR comment out the step temporarily
```

### Monitoring

After activation:
- [ ] Notifications received for all workflow failures
- [ ] No false positives or notification spam
- [ ] Links in notifications are correct and accessible
- [ ] Team finds notifications useful

---

## Enhancement 4: Metrics Dashboard

### Description

Create a metrics dashboard that tracks workflow performance over time, including success rate, runtime, failure reasons, and trends.

### Benefits

- **Visibility:** Track workflow health at a glance
- **Trends:** Identify patterns in failures or slowdowns
- **Optimization:** Data-driven decisions for improvements
- **Reporting:** Share metrics with team/stakeholders

### Risk Assessment

**Risk Level:** üü° Medium

**Risks:**
- Requires additional workflow complexity
- Data storage considerations
- Dashboard maintenance overhead
- May not provide value if workflow is stable

**Mitigations:**
- Use GitHub Actions built-in summary feature (no external storage)
- Keep metrics simple and actionable
- Make dashboard generation optional
- Review metrics monthly to assess value

### Implementation

#### Step 1: Add Metrics Collection Step

Add this step at the beginning of the `regenerate-manifests` job (before checkout):

```yaml
      # ------------------------------------------------------------------------
      # Step 0: Initialize Metrics
      # ------------------------------------------------------------------------
      - name: Initialize metrics
        id: metrics
        run: |
          # Record start time
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "workflow_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
```

#### Step 2: Add Metrics Finalization Step

Add this step at the very end of the `regenerate-manifests` job (after notification):

```yaml
      # ------------------------------------------------------------------------
      # Step 10: Finalize Metrics
      # ------------------------------------------------------------------------
      - name: Finalize metrics
        if: always()
        id: finalize-metrics
        run: |
          # Calculate duration
          START_TIME="${{ steps.metrics.outputs.start_time }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT

          # Determine status
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif [[ "${{ job.status }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
          fi

          # Check if changes were made
          echo "changes_made=${{ steps.configure.outputs.changed }}" >> $GITHUB_OUTPUT

          # Check if plan was generated
          echo "plan_generated=${{ steps.tofu-plan.outputs.plan_generated }}" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------------
      # Step 11: Generate Metrics Dashboard
      # ------------------------------------------------------------------------
      - name: Generate metrics dashboard
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'

          ---

          ## üìä Workflow Metrics

          ### This Run

          | Metric | Value |
          |--------|-------|
          | **Status** | ${{ steps.finalize-metrics.outputs.status }} |
          | **Duration** | ${{ steps.finalize-metrics.outputs.duration }}s |
          | **Changes Made** | ${{ steps.finalize-metrics.outputs.changes_made }} |
          | **Plan Generated** | ${{ steps.finalize-metrics.outputs.plan_generated }} |
          | **PR Number** | #${{ steps.metrics.outputs.pr_number }} |
          | **Workflow ID** | ${{ steps.metrics.outputs.workflow_id }} |
          | **Triggered By** | ${{ github.actor }} |
          | **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

          ### Historical Trends

          View historical metrics in [Actions tab](https://github.com/${{ github.repository }}/actions/workflows/renovate-manifest-regen.yaml).

          **Quick Stats (Last 30 Days):**
          - View via GitHub CLI: \`gh run list --workflow="Renovate Manifest Regeneration" --limit 30 --json conclusion,durationMs,createdAt\`

          **Calculate Success Rate:**
          \`\`\`bash
          gh run list --workflow="Renovate Manifest Regeneration" --limit 30 --json conclusion \
            | jq '[.[] | select(.conclusion == "success")] | length'
          \`\`\`

          **Average Duration:**
          \`\`\`bash
          gh run list --workflow="Renovate Manifest Regeneration" --limit 30 --json durationMs \
            | jq '[.[] | .durationMs] | add / length / 1000'
          \`\`\`

          EOF
```

#### Step 3: Create Monthly Metrics Report (Optional)

Create a separate workflow that generates a monthly metrics report:

**File:** `.github/workflows/renovate-metrics-report.yaml`

```yaml
---
name: Renovate Workflow Monthly Metrics Report

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  actions: read
  contents: write  # To create issue with report

jobs:
  generate-report:
    name: Generate Monthly Metrics Report
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate metrics report
        id: report
        run: |
          # Fetch last 30 days of workflow runs
          gh run list \
            --workflow="Renovate Manifest Regeneration" \
            --limit 100 \
            --json conclusion,durationMs,createdAt,number,headBranch \
            > runs.json

          # Calculate metrics
          TOTAL_RUNS=$(jq 'length' runs.json)
          SUCCESS_RUNS=$(jq '[.[] | select(.conclusion == "success")] | length' runs.json)
          FAILURE_RUNS=$(jq '[.[] | select(.conclusion == "failure")] | length' runs.json)
          SUCCESS_RATE=$(jq -n "$SUCCESS_RUNS / $TOTAL_RUNS * 100" | xargs printf "%.1f")
          AVG_DURATION=$(jq '[.[] | .durationMs] | add / length / 1000' runs.json | xargs printf "%.0f")

          # Find slowest run
          SLOWEST_RUN=$(jq -r 'max_by(.durationMs) | "\(.number) (\(.durationMs / 1000)s)"' runs.json)

          # Create report
          cat > report.md <<EOF
          # Renovate Workflow Monthly Metrics Report

          **Period:** $(date -d '30 days ago' +%Y-%m-%d) to $(date +%Y-%m-%d)
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          | Metric | Value |
          |--------|-------|
          | **Total Runs** | $TOTAL_RUNS |
          | **Successful** | $SUCCESS_RUNS |
          | **Failed** | $FAILURE_RUNS |
          | **Success Rate** | $SUCCESS_RATE% |
          | **Avg Duration** | ${AVG_DURATION}s |
          | **Slowest Run** | #$SLOWEST_RUN |

          ## Detailed Analysis

          ### Success Rate Trend

          \`\`\`
          $(jq -r '.[] | "\(.createdAt | split("T")[0]) \(.conclusion)"' runs.json | uniq -c | tail -7)
          \`\`\`

          ### Performance

          - **Target:** <5 minutes average
          - **Current:** ${AVG_DURATION}s
          - **Status:** $(if [[ $AVG_DURATION -lt 300 ]]; then echo "‚úÖ On target"; else echo "‚ö†Ô∏è Needs optimization"; fi)

          ### Recommendations

          $(if [[ $(echo "$SUCCESS_RATE < 95" | bc) -eq 1 ]]; then
            echo "- ‚ö†Ô∏è Success rate below 95% - investigate common failure patterns"
          else
            echo "- ‚úÖ Success rate healthy"
          fi)

          $(if [[ $AVG_DURATION -gt 300 ]]; then
            echo "- ‚ö†Ô∏è Average duration >5min - consider optimization"
          else
            echo "- ‚úÖ Performance within target"
          fi)

          ## Recent Failures

          $(jq -r '.[] | select(.conclusion == "failure") | "- Run #\(.number) on \(.createdAt | split("T")[0]) (branch: \(.headBranch))"' runs.json | head -5)

          ---

          View full workflow history: [Actions Tab](https://github.com/${{ github.repository }}/actions/workflows/renovate-manifest-regen.yaml)
          EOF

          # Save report
          cat report.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue with report
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Renovate Workflow Metrics Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['metrics', 'automation', 'renovate']
            });
```

### Testing Procedure

1. **Test Metrics Collection:**
   ```bash
   # Run workflow and check summary
   gh workflow run "Renovate Manifest Regeneration" -f pr_number=123
   gh run watch

   # View summary (should include metrics table)
   gh run view --log | grep "Workflow Metrics"
   ```

2. **Test Monthly Report (Manual Trigger):**
   ```bash
   # Trigger monthly report manually
   gh workflow run "Renovate Workflow Monthly Metrics Report"

   # Wait for completion
   gh run watch

   # Check for created issue
   gh issue list --label metrics | head -1
   ```

3. **Verify Metrics Accuracy:**
   - [ ] Duration is calculated correctly
   - [ ] Status matches job outcome
   - [ ] Changes detected flag is accurate
   - [ ] Monthly report calculations are correct

### Activation

**Prerequisites:**
- Base workflow running for at least 2 weeks (to have meaningful data)
- Team agreement on metrics to track

```bash
# Add metrics steps to workflow
git add .github/workflows/renovate-manifest-regen.yaml

# Add monthly report workflow
git add .github/workflows/renovate-metrics-report.yaml

git commit -m "feat(ci): add metrics dashboard to Renovate workflow"
git push
```

### Customization Options

**Additional Metrics to Track:**
- Number of files changed
- Size of plan output
- Template rendering time
- Git push time
- Most frequently regenerated apps

**Alternative Reporting:**
- Send metrics to external service (Datadog, Grafana)
- Store in GitHub repo (metrics.json file)
- Create GitHub Pages dashboard

### Rollback

```bash
# Remove metrics steps
git revert <commit-hash>
git push

# Disable monthly report workflow
gh workflow disable "Renovate Workflow Monthly Metrics Report"
```

### Monitoring

After activation:
- [ ] Metrics appear in workflow summaries
- [ ] Monthly reports generated successfully
- [ ] Metrics provide actionable insights
- [ ] Team reviews and uses metrics

---

## Implementation Roadmap

### Phase 1: Foundation (Weeks 1-2)
**Goal:** Test and enable base workflow

- [ ] Test base workflow via manual trigger (3-5 test PRs)
- [ ] Enable automatic execution (uncomment pull_request trigger)
- [ ] Monitor first 5-10 automatic runs
- [ ] Collect team feedback
- [ ] Verify no workflow loops or failures

**Success Criteria:** 95%+ success rate, <5min average runtime, positive team feedback

### Phase 2: Visibility (Weeks 3-4)
**Goal:** Improve PR review experience

- [ ] Implement Enhancement 1 (PR Comment Summary)
- [ ] Test on 3-5 Renovate PRs
- [ ] Collect reviewer feedback
- [ ] Refine comment format based on feedback

**Success Criteria:** Reviewers find comments helpful, no formatting issues

### Phase 3: Infrastructure Review (Weeks 5-6)
**Goal:** Enable in-PR infrastructure change review

- [ ] Configure infrastructure backend access in GitHub Actions
- [ ] Implement Enhancement 2 (Tofu Plan Output)
- [ ] Test with real infrastructure changes
- [ ] Verify plan output is accurate and useful

**Success Criteria:** Reviewers can approve infrastructure changes from PR without local setup

### Phase 4: Alerting (Weeks 7-8)
**Goal:** Proactive failure detection

- [ ] Choose notification platform (Slack or Discord)
- [ ] Configure webhook
- [ ] Implement Enhancement 3 (Notifications)
- [ ] Test failure scenarios
- [ ] Tune notification content

**Success Criteria:** Team notified within 1 minute of workflow failure

### Phase 5: Metrics (Weeks 9-10)
**Goal:** Data-driven optimization

- [ ] Implement Enhancement 4 (Metrics Dashboard)
- [ ] Run for 30 days to collect baseline data
- [ ] Generate first monthly report
- [ ] Review metrics with team
- [ ] Identify optimization opportunities

**Success Criteria:** Monthly report provides actionable insights

---

## Decision Framework

### Should You Implement an Enhancement?

Use this decision tree:

```
Is the base workflow stable? (>95% success rate for 2+ weeks)
‚îú‚îÄ No ‚Üí WAIT, focus on stabilizing base workflow
‚îî‚îÄ Yes ‚Üí Continue

Is this enhancement solving a real problem the team experiences?
‚îú‚îÄ No ‚Üí SKIP this enhancement
‚îî‚îÄ Yes ‚Üí Continue

Does the team have capacity to implement and maintain this?
‚îú‚îÄ No ‚Üí DEFER to future sprint
‚îî‚îÄ Yes ‚Üí Continue

Is the risk level acceptable? (Low or Medium with mitigations)
‚îú‚îÄ No ‚Üí RE-EVALUATE or REDESIGN
‚îî‚îÄ Yes ‚Üí IMPLEMENT

After implementation, is the enhancement providing value?
‚îú‚îÄ No ‚Üí REMOVE enhancement
‚îî‚îÄ Yes ‚Üí KEEP and iterate
```

### When to Pause Enhancements

Stop adding enhancements if:
- Base workflow success rate drops below 90%
- Workflow runtime exceeds 10 minutes
- Team reports confusion or friction with current features
- Maintenance burden becomes significant

**Remember:** A simple, reliable workflow is better than a complex, feature-rich workflow that fails frequently.

---

## Rollback Plan

### Emergency Disable (Any Enhancement)

```bash
# Option 1: Revert specific enhancement commit
git log --oneline | grep "feat(ci):"  # Find commit hash
git revert <commit-hash>
git push

# Option 2: Comment out enhancement steps in workflow file
# Edit .github/workflows/renovate-manifest-regen.yaml
# Add # before each line of the enhancement step

# Option 3: Disable entire workflow temporarily
gh workflow disable "Renovate Manifest Regeneration"
```

### Validation After Rollback

```bash
# Verify workflow still works
gh workflow run "Renovate Manifest Regeneration" -f pr_number=123
gh run watch

# Check for errors
gh run view --log
```

---

## Support and Documentation

### Additional Resources

- **Base Workflow Documentation:** `docs/workflows/RENOVATE_MANIFEST_REGENERATION.md`
- **Implementation Summary:** `claudedocs/renovate_manifest_workflow_implementation_2026-01-14.md`
- **Research Report:** `claudedocs/research_renovate_opentofu_best_practices_2026-01-14.md`
- **Validation Report:** `claudedocs/implementation_validation_report_2026-01-14.md`

### Getting Help

**Workflow Issues:**
- Check workflow logs: `gh run view <run-id> --log`
- Review troubleshooting guide in base workflow documentation
- Check GitHub Actions status page

**Enhancement Issues:**
- Refer to specific enhancement troubleshooting section in this document
- Test enhancement in isolation on a feature branch
- Review GitHub Actions documentation for specific action issues

---

## Changelog

### Version 1.0.0 (January 14, 2026)

**Created:**
- Enhancement 1: PR Comment Summary (Low risk, High priority)
- Enhancement 2: Tofu Plan Output (Medium risk, High priority)
- Enhancement 3: Slack/Discord Notifications (Low risk, Medium priority)
- Enhancement 4: Metrics Dashboard (Medium risk, Low priority)
- Implementation roadmap (5 phases, 10 weeks)
- Decision framework for enhancement adoption
- Rollback procedures for all enhancements

**Status:** Ready for implementation after base workflow testing

---

**Document Created By:** Claude Sonnet 4.5
**Creation Date:** January 14, 2026
**Document Status:** ‚úÖ Complete and Ready for Use
**Implementation Status:** ‚è∏Ô∏è **PENDING BASE WORKFLOW VALIDATION**
