#% if cilium_bgp_enabled %#
! =============================================================================
! BGP Configuration for #{ repository_name }#
! Generated by: makejinja template
! Upload to UniFi: Settings -> Routing -> BGP -> Add Configuration
!
! Requirements:
! - UniFi OS 4.1.13+ (or UXG-Enterprise 4.1.8+)
! - BGP configuration enabled in cluster.yaml
!
! REF: https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/
! REF: https://help.ui.com/hc/en-us/articles/16271338193559-UniFi-Border-Gateway-Protocol-BGP
! =============================================================================

router bgp #{ cilium_bgp_router_asn }#
  bgp router-id #{ cilium_bgp_router_addr }#
  no bgp ebgp-requires-policy
  no bgp default ipv4-unicast
  no bgp network import-check
  !
  ! ECMP - Enable multi-path routing for load distribution across advertising nodes
  bgp bestpath as-path multipath-relax
  maximum-paths #{ cilium_bgp_ecmp_max_paths | default(3) }#
  !
  ! Peer group for Kubernetes nodes
  neighbor TALOS peer-group
  neighbor TALOS remote-as #{ cilium_bgp_node_asn }#
  neighbor TALOS timers #{ cilium_bgp_keepalive_time | default(10) }# #{ cilium_bgp_hold_time | default(30) }#
#% if cilium_bgp_password is defined %#
  neighbor TALOS password #{ cilium_bgp_password }#
#% endif %#
#% if cilium_bgp_graceful_restart | default(false) %#
  neighbor TALOS graceful-restart
  neighbor TALOS graceful-restart-helper
#% endif %#
  !
  ! Add each Kubernetes node as a neighbor
  ! Node IPs from nodes.yaml:
#% for node in nodes %#
  neighbor #{ node.address }# peer-group TALOS
#% endfor %#
  !
  address-family ipv4 unicast
    neighbor TALOS activate
    neighbor TALOS next-hop-self
    neighbor TALOS soft-reconfiguration inbound
    neighbor TALOS route-map ACCEPT-K8S in
  exit-address-family
!
exit
!
! =============================================================================
! Prefix List - Only accept LoadBalancer IPs from the cluster
! =============================================================================
#% if cilium_lb_pool_cidr is defined %#
! Dedicated LoadBalancer IP pool
ip prefix-list K8S-LOADBALANCER seq 5 permit #{ cilium_lb_pool_cidr }# ge 32
#% else %#
! Using node network for LoadBalancer IPs
ip prefix-list K8S-LOADBALANCER seq 5 permit #{ node_cidr }# ge 32
#% endif %#
!
route-map ACCEPT-K8S permit 10
  match ip address prefix-list K8S-LOADBALANCER
exit
#% else %#
! =============================================================================
! BGP is not enabled
! =============================================================================
! To enable BGP, add these to cluster.yaml:
!
!   cilium_bgp_router_addr: "192.168.x.1"  # Your gateway IP
!   cilium_bgp_router_asn: "64513"         # Gateway ASN (private: 64512-65534)
!   cilium_bgp_node_asn: "64514"           # Kubernetes ASN (must differ)
!
! Then run: task configure
! =============================================================================
#% endif %#
