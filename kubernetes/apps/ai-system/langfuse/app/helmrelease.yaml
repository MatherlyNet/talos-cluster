---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
  namespace: ai-system
spec:
  chart:
    spec:
      chart: langfuse
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: langfuse
        namespace: ai-system
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    langfuse:
      nextauth:
        url: "https://langfuse.matherly.net"
        secret:
          value: ""
          secretKeyRef:
            name: langfuse-credentials
            key: NEXTAUTH_SECRET
      salt:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: SALT
      encryptionKey:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: ENCRYPTION_KEY

      logging:
        level: "info"
        format: "json"

      features:
        signUpDisabled: true

      additionalEnv:
        - name: NEXTAUTH_COOKIE_DOMAIN
          value: "langfuse.matherly.net"
        - name: AUTH_DISABLE_USERNAME_PASSWORD
          value: "true"
        - name: LANGFUSE_INIT_ORG_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_ID
        - name: LANGFUSE_INIT_ORG_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_NAME
        - name: LANGFUSE_INIT_USER_EMAIL
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_EMAIL
        - name: LANGFUSE_INIT_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_PASSWORD
        - name: LANGFUSE_INIT_USER_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_NAME
        - name: LANGFUSE_INIT_PROJECT_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_ID
        - name: LANGFUSE_INIT_PROJECT_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_NAME
        - name: LANGFUSE_INIT_PROJECT_RETENTION
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_RETENTION
        - name: LANGFUSE_INIT_PROJECT_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_PUBLIC_KEY
        - name: LANGFUSE_INIT_PROJECT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_SECRET_KEY
        - name: LANGFUSE_DEFAULT_ORG_ID
          value: "matherly-net"
        - name: LANGFUSE_DEFAULT_ORG_ROLE
          value: "VIEWER"
        - name: AUTH_KEYCLOAK_CLIENT_ID
          value: "langfuse"
        - name: AUTH_KEYCLOAK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: langfuse-keycloak-credentials
              key: client-secret
        - name: AUTH_KEYCLOAK_ISSUER
          value: "https://sso.matherly.net/realms/matherlynet"
        - name: AUTH_KEYCLOAK_ALLOW_ACCOUNT_LINKING
          value: "true"
        - name: AUTH_KEYCLOAK_CHECKS
          value: "pkce,state"

    postgresql:
      deploy: false
      host: "langfuse-postgresql-rw.ai-system.svc.cluster.local"
      port: 5432
      auth:
        username: "langfuse"
        existingSecret: "langfuse-postgresql-credentials"
        secretKeys:
          userPasswordKey: "password"
        database: "langfuse"

    redis:
      deploy: false
      host: "dragonfly.cache.svc.cluster.local"
      port: 6379
      auth:
        username: "langfuse"
        existingSecret: "langfuse-redis-credentials"
        existingSecretPasswordKey: "password"

    clickhouse:
      deploy: true
      replicaCount: 1
      clusterEnabled: false
      persistence:
        enabled: true
        size: "20Gi"
        storageClass: "proxmox-zfs"
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          memory: "4Gi"
      auth:
        existingSecret: "langfuse-clickhouse-credentials"
        existingSecretKey: "password"
      zookeeper:
        persistence:
          enabled: true
          size: "8Gi"
          storageClass: "proxmox-zfs"

    s3:
      deploy: false
      bucket: "langfuse-events"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
      concurrentWrites: 50
      concurrentReads: 50

    mediaUpload:
      enabled: true
      bucket: "langfuse-media"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
      maxContentLength: 1000000000
      downloadUrlExpirySeconds: 3600

    batchExport:
      enabled: true
      bucket: "langfuse-exports"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY

    ingress:
      enabled: false

    web:
      replicaCount: 1
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          memory: "2Gi"

    worker:
      replicaCount: 1
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          memory: "2Gi"

    otel:
      enabled: true
      endpoint: "http://tempo.monitoring.svc.cluster.local:4318"
      serviceName: "langfuse"
      samplingRatio: "0.1"
