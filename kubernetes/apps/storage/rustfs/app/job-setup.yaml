---
apiVersion: batch/v1
kind: Job
metadata:
  name: rustfs-bucket-setup
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-rustfs
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for RustFS to be ready..."
              until wget -q --spider http://rustfs.storage.svc:9000/minio/health/ready; do
                echo "RustFS not ready, waiting..."
                sleep 10
              done
              echo "RustFS is ready!"
      containers:
        - name: setup
          image: minio/mc:latest
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Configuring mc alias for RustFS..."
              mc alias set rustfs http://rustfs.storage.svc:9000 "$RUSTFS_ROOT_USER" "$RUSTFS_ROOT_PASSWORD"

              echo "Creating buckets..."
              # Loki buckets
              mc mb --ignore-existing rustfs/loki-chunks
              mc mb --ignore-existing rustfs/loki-ruler
              mc mb --ignore-existing rustfs/loki-admin
              echo "Loki buckets created."

              # Create Loki service account
              echo "Creating Loki service account..."
              mc admin user add rustfs "$LOKI_ACCESS_KEY" "$LOKI_SECRET_KEY" || echo "Loki user may already exist"

              # Create and attach Loki policy
              cat > /tmp/loki-policy.json << 'EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": ["s3:*"],
                    "Resource": [
                      "arn:aws:s3:::loki-*",
                      "arn:aws:s3:::loki-*/*"
                    ]
                  }
                ]
              }
              EOF
              mc admin policy create rustfs loki-policy /tmp/loki-policy.json 2>/dev/null || echo "Loki policy may already exist"
              mc admin policy attach rustfs loki-policy --user "$LOKI_ACCESS_KEY" 2>/dev/null || echo "Loki policy may already be attached"
              echo "Loki service account configured."

              # Tempo bucket
              mc mb --ignore-existing rustfs/tempo
              echo "Tempo bucket created."

              # Create Tempo service account
              echo "Creating Tempo service account..."
              mc admin user add rustfs "$TEMPO_ACCESS_KEY" "$TEMPO_SECRET_KEY" || echo "Tempo user may already exist"

              # Create and attach Tempo policy
              cat > /tmp/tempo-policy.json << 'EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": ["s3:*"],
                    "Resource": [
                      "arn:aws:s3:::tempo",
                      "arn:aws:s3:::tempo/*"
                    ]
                  }
                ]
              }
              EOF
              mc admin policy create rustfs tempo-policy /tmp/tempo-policy.json 2>/dev/null || echo "Tempo policy may already exist"
              mc admin policy attach rustfs tempo-policy --user "$TEMPO_ACCESS_KEY" 2>/dev/null || echo "Tempo policy may already be attached"
              echo "Tempo service account configured."

              # General backup bucket
              mc mb --ignore-existing rustfs/backups
              echo "Backup bucket created."

              echo "Bucket setup complete!"
              mc ls rustfs/
          env:
            - name: RUSTFS_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: root-user
            - name: RUSTFS_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: root-password
            - name: LOKI_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: loki-s3-credentials
                  key: access-key
            - name: LOKI_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: loki-s3-credentials
                  key: secret-key
            - name: TEMPO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: tempo-s3-credentials
                  key: access-key
            - name: TEMPO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: tempo-s3-credentials
                  key: secret-key
