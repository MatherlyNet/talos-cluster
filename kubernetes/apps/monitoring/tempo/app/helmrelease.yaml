---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
spec:
  chart:
    spec:
      chart: tempo
      version: "1.24.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: monitoring
  interval: 1h
  timeout: 10m
  values:
    tempo:
      metricsGenerator:
        enabled: true
        remoteWriteUrl: "http://kube-prometheus-stack-prometheus:9090/api/v1/write"

    config: |
      multitenancy_enabled: false
      usage_report:
        reporting_enabled: false
      compactor:
        compaction:
          block_retention: 72h
      distributor:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "0.0.0.0:4317"
              http:
                endpoint: "0.0.0.0:4318"
          zipkin:
            endpoint: "0.0.0.0:9411"
      ingester:
        max_block_duration: 5m
      server:
        http_listen_port: 3200
        grpc_listen_port: 9095
      storage:
        trace:
          backend: local
          local:
            path: /var/tempo/traces
          wal:
            path: /var/tempo/wal
      querier:
        max_concurrent_queries: 20
      query_frontend:
        search:
          max_duration: 0
      metrics_generator:
        processor:
          local_blocks:
            filter_server_spans: false
            flush_to_storage: true
          service_graphs:
            histogram_buckets: [0.1, 0.2, 0.4, 0.8, 1.6, 3.2, 6.4, 12.8]
            dimensions: []
          span_metrics:
            histogram_buckets: [0.002, 0.004, 0.008, 0.016, 0.032, 0.064, 0.128, 0.256, 0.512, 1.024, 2.048, 4.096, 8.192, 16.384]
            dimensions: []
        registry:
          collection_interval: 15s
          stale_duration: 15m
        storage:
          path: /var/tempo/generator/wal
          remote_write:
            - url: http://kube-prometheus-stack-prometheus:9090/api/v1/write
              send_exemplars: true
        traces_storage:
          path: /var/tempo/generator/traces
      overrides:
        defaults:
          metrics_generator:
            processors:
              - local-blocks
              - service-graphs
              - span-metrics

    persistence:
      enabled: true
      storageClassName: "proxmox-zfs"
      size: "10Gi"

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

    readinessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 15
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 45
      periodSeconds: 30
      timeoutSeconds: 5

    serviceMonitor:
      enabled: true
