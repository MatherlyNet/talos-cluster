#| Generated by makejinja - DO NOT EDIT directly #|
#| To modify, edit the template and run: task configure #|
# Main OpenTofu Configuration
#
# This file provisions Talos Linux VMs on Proxmox VE.

#% if infrastructure_enabled %#
# -----------------------------------------------------------------------------
# Local Values
# -----------------------------------------------------------------------------

locals {
  # Extract unique schematic+secureboot combinations for ISO downloads
  # SecureBoot nodes require a different ISO (nocloud-amd64-secureboot.iso)
  # This ensures we download each unique combination once
  schematic_secureboot_list = distinct([
    for node in var.nodes : {
      schematic_id = node.schematic_id
      secureboot   = node.secureboot
    }
  ])

  # Create a map keyed by "schematic_id-secureboot" for for_each
  schematic_secureboot_map = {
    for combo in local.schematic_secureboot_list :
    "${combo.schematic_id}-${combo.secureboot}" => combo
  }

  # Create node map for for_each
  nodes_map = { for node in var.nodes : node.name => node }

  # Talos Image Factory URL base
  talos_factory_url = "https://factory.talos.dev/image"
}

# -----------------------------------------------------------------------------
# Talos ISO Download from Image Factory
# -----------------------------------------------------------------------------
# Downloads Talos ISOs from Image Factory using schematic IDs.
# Each unique (schematic_id, secureboot) combination results in one ISO download.
# SecureBoot nodes use nocloud-amd64-secureboot.iso, others use nocloud-amd64.iso.
# REF: https://www.talos.dev/latest/talos-guides/install/bare-metal-platforms/secureboot/

resource "proxmox_virtual_environment_download_file" "talos_iso" {
  for_each = local.schematic_secureboot_map

  content_type = "iso"
  datastore_id = var.proxmox_iso_storage
  node_name    = var.proxmox_node

  # Talos Image Factory URL format:
  # Standard:   https://factory.talos.dev/image/{schematic_id}/v{version}/nocloud-amd64.iso
  # SecureBoot: https://factory.talos.dev/image/{schematic_id}/v{version}/nocloud-amd64-secureboot.iso
  url = each.value.secureboot ? (
    "${local.talos_factory_url}/${each.value.schematic_id}/v${var.talos_version}/nocloud-amd64-secureboot.iso"
  ) : (
    "${local.talos_factory_url}/${each.value.schematic_id}/v${var.talos_version}/nocloud-amd64.iso"
  )

  # Use schematic ID prefix for filename (first 12 chars for readability)
  # Append -secureboot suffix for SecureBoot ISOs
  file_name = each.value.secureboot ? (
    "talos-v${var.talos_version}-${substr(each.value.schematic_id, 0, 12)}-secureboot.iso"
  ) : (
    "talos-v${var.talos_version}-${substr(each.value.schematic_id, 0, 12)}.iso"
  )

  # Overwrite if ISO already exists with different content
  overwrite = true

  # 10 minute timeout for large ISOs
  upload_timeout = 600
}

# -----------------------------------------------------------------------------
# Talos Node VMs
# -----------------------------------------------------------------------------
# Creates VMs for each node defined in nodes.yaml.
# VMs boot from the Talos ISO and enter maintenance mode.

resource "proxmox_virtual_environment_vm" "talos_node" {
  for_each = local.nodes_map

  # VM ID: use specified value or let Proxmox auto-assign
  vm_id       = each.value.vm_id
  name        = each.value.name
  node_name   = var.proxmox_node
  description = "Talos Linux ${each.value.controller ? "control plane" : "worker"} node"

  # Tags for organization
  tags = concat(
    var.vm_advanced.tags,
    [each.value.controller ? "controller" : "worker"]
  )

  # VM should start after creation
  started = true
  on_boot = true

  # BIOS and Machine Type (Talos requires OVMF/UEFI)
  bios    = var.vm_advanced.bios
  machine = var.vm_advanced.machine

  # Guest OS type
  operating_system {
    type = var.vm_advanced.ostype
  }

  # Startup/Shutdown order
  startup {
    order      = each.value.vm_startup_order
    up_delay   = each.value.vm_startup_delay
    down_delay = each.value.vm_shutdown_delay
  }

  # CPU Configuration
  cpu {
    cores   = each.value.vm_cores
    sockets = each.value.vm_sockets
    type    = var.vm_advanced.cpu_type
    numa    = var.vm_advanced.numa
  }

  # Memory Configuration (no ballooning for Kubernetes)
  memory {
    dedicated = each.value.vm_memory
    floating  = var.vm_advanced.balloon
  }

  # QEMU Guest Agent
  agent {
    enabled = var.vm_advanced.qemu_agent
  }

  # EFI Disk (required for OVMF BIOS)
  # NOTE: pre_enrolled_keys must be false for Talos SecureBoot
  # Talos uses its own signing keys, not Microsoft's pre-enrolled keys
  efi_disk {
    datastore_id      = var.proxmox_disk_storage
    type              = "4m"
    pre_enrolled_keys = false
  }

  # Boot ISO (Talos nocloud image - standard or secureboot variant)
  # Note: 'enabled' attribute is deprecated in bpg/proxmox provider - set file_id to "none" to leave empty
  cdrom {
    file_id   = proxmox_virtual_environment_download_file.talos_iso["${each.value.schematic_id}-${each.value.secureboot}"].id
    interface = "ide2"
  }

  # Primary disk
  disk {
    datastore_id = var.proxmox_disk_storage
    interface    = "scsi0"
    size         = each.value.vm_disk_size
    file_format  = "raw"
    ssd          = var.vm_advanced.disk_ssd
    discard      = var.vm_advanced.disk_discard ? "on" : "ignore"
    backup       = var.vm_advanced.disk_backup
    replicate    = var.vm_advanced.disk_replicate
    iothread     = false
  }

  # SCSI Controller
  scsi_hardware = var.vm_advanced.scsi_hw

  # Network Device
  network_device {
    bridge      = var.vm_advanced.network_bridge
    mac_address = upper(each.value.mac_addr)
    model       = "virtio"
    queues      = var.vm_advanced.net_queues
    vlan_id     = var.node_vlan_tag
    mtu         = each.value.mtu
  }

  # Serial device (required for console access)
  serial_device {}

  # VGA (std for Proxmox console access, serial0 available via serial_device)
  vga {
    type = "std"
  }

  # Boot order: disk first (scsi0), then CD-ROM (ide2) for initial install
  # This ensures VMs boot from installed disk after Talos installation completes,
  # preventing the "halt_if_installed" error when ISO is still attached.
  # Initial boot: empty disk fails → falls back to ISO → Talos installs
  # After install: boots from disk automatically
  boot_order = ["scsi0", "ide2"]

  # Lifecycle: Ignore changes to started state after creation
  lifecycle {
    ignore_changes = [
      started,
      cdrom, # ISO may be detached after Talos install
    ]
  }

  # Wait for ISO download
  depends_on = [proxmox_virtual_environment_download_file.talos_iso]
}

#% else %#
# -----------------------------------------------------------------------------
# Infrastructure provisioning not enabled
# -----------------------------------------------------------------------------
# To enable Proxmox VM provisioning, add to cluster.yaml:
#   proxmox_api_url: "https://pve.example.com:8006/api2/json"
#   proxmox_node: "pve"
#
# Then run: task configure
#% endif %#
