#% if keycloak_enabled | default(false) %#
---
#| HTTPRoute for Keycloak via Envoy Gateway (external only)                     #|
#| All traffic routes through Cloudflare Tunnel for consistent OIDC behavior:   #|
#| - External users: Cloudflare DNS → Cloudflare Tunnel → envoy-external        #|
#| - Internal pods: CoreDNS → Cloudflare DNS → Cloudflare Tunnel → envoy-external #|
#| This eliminates hairpin NAT issues and ensures OIDC issuer consistency.      #|
#| Internal clients on LAN will also route via Cloudflare (no split-horizon).   #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: keycloak
  namespace: identity
spec:
  parentRefs:
    #| External gateway only: all traffic via Cloudflare Tunnel #|
    - name: envoy-external
      namespace: network
  hostnames:
    - "#{ keycloak_subdomain | default('auth') }#.${SECRET_DOMAIN}"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        #| Service created by Keycloak operator: keycloak-service #|
        - name: keycloak-service
          port: 8080
---
#| Headless service for JGroups DNS discovery (HA clustering) #|
#% if (keycloak_replicas | default(1)) > 1 %#
apiVersion: v1
kind: Service
metadata:
  name: keycloak-discovery
  namespace: identity
  labels:
    app.kubernetes.io/name: keycloak
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 7800
      name: jgroups
  selector:
    app.kubernetes.io/name: keycloak
#% endif %#
#% endif %#
