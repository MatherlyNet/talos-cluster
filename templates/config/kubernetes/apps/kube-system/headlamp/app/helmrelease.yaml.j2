#% if headlamp_enabled | default(false) %#
---
#| ============================================================================= #|
#| HEADLAMP - Kubernetes Web UI with OIDC Authentication                         #|
#| Modern web interface for Kubernetes cluster management                        #|
#| REF: https://headlamp.dev/                                                     #|
#| REF: https://headlamp.dev/docs/latest/installation/in-cluster/oidc/           #|
#| REF: https://headlamp.dev/docs/latest/installation/in-cluster/keycloak/       #|
#| ============================================================================= #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headlamp
  namespace: kube-system
spec:
  chart:
    spec:
      chart: headlamp
      version: #{ headlamp_chart_version | default('0.39.0') }#
      sourceRef:
        kind: HelmRepository
        name: headlamp
        namespace: kube-system
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    #| ========================================================================= #|
    #| Image Configuration                                                        #|
    #| ========================================================================= #|
    image:
      registry: ghcr.io
      repository: headlamp-k8s/headlamp
      tag: v#{ headlamp_version | default('0.39.0') }#
      pullPolicy: IfNotPresent

    #| ========================================================================= #|
    #| Deployment Configuration                                                   #|
    #| ========================================================================= #|
    replicaCount: #{ headlamp_replicas | default(2) }#

    #| ========================================================================= #|
    #| OIDC Configuration - Keycloak Authentication                               #|
    #| Chart will create secret from these values                                #|
    #| ========================================================================= #|
    config:
      oidc:
        #| SHARED CLIENT ARCHITECTURE #|
        #| Uses "kubernetes" client (shared with kubectl/kubelogin) #|
        #| CRITICAL: Headlamp MUST use kubernetes client because: #|
        #|   - Headlamp passes OIDC tokens to Kubernetes API Server #|
        #|   - API Server only accepts tokens with aud: ["kubernetes"] #|
        #|   - Separate client would cause 401 Unauthorized errors #|
        #| REF: docs/research/kubernetes-api-server-oidc-authentication-jan-2026.md #|
        clientID: #{ kubernetes_oidc_client_id | default('kubernetes') }#

        #| Client secret - value from cluster.yaml (SOPS encrypted) #|
        clientSecret: "#{ kubernetes_oidc_client_secret }#"

        #| Keycloak issuer URL #|
        issuerURL: https://#{ keycloak_subdomain | default('sso') }#.${SECRET_DOMAIN}/realms/#{ keycloak_realm | default('matherlynet') }#

        #| Scopes to request during authentication #|
        #| Includes "groups" scope for Kubernetes RBAC integration #|
        scopes: "openid,profile,email,groups"

        #| Let the chart create the secret from config.oidc values #|
        secret:
          create: true
          name: headlamp-oidc

    #| ========================================================================= #|
    #| Plugin Configuration                                                      #|
    #| ========================================================================= #|
    plugins:
      # Prometheus
      - name: prometheus
        source: https://github.com/headlamp-k8s/plugins/releases/download/prometheus-0.8.1/prometheus-0.8.1.tar.gz
        version: 0.8.1

      # Flux GitOps Visualization
      - name: flux
        source: https://github.com/headlamp-k8s/plugins/releases/download/flux-0.5.0/headlamp-k8s-flux-0.5.0.tar.gz
        version: 0.5.0

      # Certificate Management UI
      - name: cert-manager
        source: https://github.com/headlamp-k8s/plugins/releases/download/cert-manager-0.1.0/headlamp-k8s-cert-manager-0.1.0.tar.gz
        version: 0.1.0

      # AI Assistant
      - name: ai-assistant
        source: https://github.com/headlamp-k8s/plugins/releases/download/ai-assistant-0.1.0-alpha/headlamp-k8s-ai-assistant-0.1.0-alpha.tar.gz
        version: 0.1.0-alpha

    # Enable plugin watching for auto-updates
    pluginWatching:
      enabled: true
      interval: 5m

    #| ========================================================================= #|
    #| Environment Configuration                                                  #|
    #| Suppress informational kubeconfig loading errors (expected in-cluster)    #|
    #| ========================================================================= #|
    env:
      - name: HEADLAMP_LOG_LEVEL
        value: "warn"

    #| ========================================================================= #|
    #| Service Configuration                                                      #|
    #| ========================================================================= #|
    service:
      type: ClusterIP
      port: 80

    #| Disable built-in ingress - use Gateway API HTTPRoute instead #|
    ingress:
      enabled: false

    #| ========================================================================= #|
    #| Service Account and RBAC                                                   #|
    #| Headlamp needs cluster-wide read access to display resources              #|
    #| ========================================================================= #|
    serviceAccount:
      create: true
      name: headlamp

    #| ClusterRole with read-only access to cluster resources #|
    clusterRoleBinding:
      create: true

    #| ========================================================================= #|
    #| Resource Configuration                                                     #|
    #| ========================================================================= #|
    resources:
      requests:
        cpu: #{ headlamp_cpu_request | default('50m') }#
        memory: #{ headlamp_memory_request | default('128Mi') }#
      limits:
        cpu: #{ headlamp_cpu_limit | default('500m') }#
        memory: #{ headlamp_memory_limit | default('512Mi') }#

    #| ========================================================================= #|
    #| Security Context                                                           #|
    #| ========================================================================= #|
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 100
      runAsGroup: 101
      fsGroup: 101
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    #| ========================================================================= #|
    #| Health Probes                                                              #|
    #| ========================================================================= #|
    livenessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    readinessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 10
      periodSeconds: 5
      failureThreshold: 3
      timeoutSeconds: 3

    #| ========================================================================= #|
    #| Persistence - Temporary directory for writable filesystem                 #|
    #| Required because readOnlyRootFilesystem: true                             #|
    #| ========================================================================= #|
    persistentVolumeClaim:
      enabled: false

    #| Use emptyDir for tmp and config directories #|
    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: config
        mountPath: /home/headlamp/.config
    volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        emptyDir: {}

#% if network_policies_enabled | default(false) %#
    #| ========================================================================= #|
    #| Network Policy Labels                                                      #|
    #| ========================================================================= #|
    podLabels:
      network.cilium.io/api-access: "true"
#% endif %#
#% endif %#
