---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headlamp
  namespace: kube-system
spec:
  chart:
    spec:
      chart: headlamp
      version: 0.39.0
      sourceRef:
        kind: HelmRepository
        name: headlamp
        namespace: kube-system
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    image:
      registry: ghcr.io
      repository: headlamp-k8s/headlamp
      tag: v0.39.0
      pullPolicy: IfNotPresent

    replicaCount: 2

    config:
      oidc:
        clientID: kubernetes

        clientSecret: "840480f0e9446b2254967e4fdbf773d8afc46192d921298be7a7cb69c05789ae"

        issuerURL: https://sso.${SECRET_DOMAIN}/realms/matherlynet

        scopes: "openid,profile,email,groups"

        secret:
          create: true
          name: headlamp-oidc

      watchPlugins: true

    pluginsManager:
      enabled: true
      configContent: |
        plugins:
          - name: prometheus
            source: https://github.com/headlamp-k8s/plugins/releases/download/prometheus-0.8.1/prometheus-0.8.1.tar.gz
            version: 0.8.1

          - name: flux
            source: https://github.com/headlamp-k8s/plugins/releases/download/flux-0.5.0/headlamp-k8s-flux-0.5.0.tar.gz
            version: 0.5.0

          - name: cert-manager
            source: https://github.com/headlamp-k8s/plugins/releases/download/cert-manager-0.1.0/headlamp-k8s-cert-manager-0.1.0.tar.gz
            version: 0.1.0

          - name: ai-assistant
            source: https://github.com/headlamp-k8s/plugins/releases/download/ai-assistant-0.1.0-alpha/headlamp-k8s-ai-assistant-0.1.0-alpha.tar.gz
            version: 0.1.0-alpha
        installOptions:
          parallel: true
          maxConcurrent: 2

      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        runAsGroup: 101
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        capabilities:
          drop:
            - ALL

    env:
      - name: HEADLAMP_LOG_LEVEL
        value: "warn"

    service:
      type: ClusterIP
      port: 80

    ingress:
      enabled: false

    serviceAccount:
      create: true
      name: headlamp

    clusterRoleBinding:
      create: true

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 100
      runAsGroup: 101
      fsGroup: 101
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    livenessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    readinessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 10
      periodSeconds: 5
      failureThreshold: 3
      timeoutSeconds: 3

    persistentVolumeClaim:
      enabled: false

    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: config
        mountPath: /home/headlamp/.config
    volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        emptyDir: {}

    podLabels:
      network.cilium.io/api-access: "true"
