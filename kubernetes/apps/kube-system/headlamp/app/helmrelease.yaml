---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headlamp
  namespace: kube-system
spec:
  chart:
    spec:
      chart: headlamp
      version: 0.39.0
      sourceRef:
        kind: HelmRepository
        name: headlamp
        namespace: kube-system
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    image:
      registry: ghcr.io
      repository: headlamp-k8s/headlamp
      tag: v0.39.0
      pullPolicy: IfNotPresent

    replicaCount: 2

    config:
      oidc:
        clientID: headlamp

        clientSecret: "6a2ea6bb7c6918cf6ea960d5f158cf2a44a38d2dc0957b6337e75e1a0ab6c711"

        issuerURL: https://sso.${SECRET_DOMAIN}/realms/matherlynet

        scopes: "openid,profile,email"

        secret:
          create: true
          name: headlamp-oidc

    env:
      - name: HEADLAMP_LOG_LEVEL
        value: "warn"

    service:
      type: ClusterIP
      port: 80

    ingress:
      enabled: false

    serviceAccount:
      create: true
      name: headlamp

    clusterRoleBinding:
      create: true

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 100
      runAsGroup: 101
      fsGroup: 101
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    livenessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    readinessProbe:
      httpGet:
        path: /
        port: 4466
      initialDelaySeconds: 10
      periodSeconds: 5
      failureThreshold: 3
      timeoutSeconds: 3

    persistentVolumeClaim:
      enabled: false

    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: config
        mountPath: /home/headlamp/.config
    volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        emptyDir: {}

    podLabels:
      network.cilium.io/api-access: "true"
