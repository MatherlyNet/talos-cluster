#% if keycloak_enabled | default(false) %#
---
#| ============================================================================= #|
#| ADMIN CREDENTIALS - GitOps-managed bootstrap admin secret                     #|
#| ============================================================================= #|
#| This secret is referenced by spec.bootstrapAdmin.user.secret in the Keycloak  #|
#| CR. Using a DIFFERENT name than the operator's default (keycloak-initial-admin)#|
#| avoids GitHub Issue #35862 where the operator tries to CREATE a secret that   #|
#| already exists instead of adopting it.                                        #|
#| REF: https://www.keycloak.org/operator/advanced-configuration                 #|
#| REF: https://github.com/keycloak/keycloak/issues/35862                        #|
#| ============================================================================= #|
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-admin-credentials
  namespace: identity
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: admin-credentials
type: Opaque
stringData:
  username: "admin"
  password: "#{ keycloak_admin_password }#"
---
#| ============================================================================= #|
#| DATABASE CREDENTIALS - PostgreSQL connection                                  #|
#| Used by CNPG Cluster bootstrap and managed.roles for password rotation        #|
#| REF: docs/research/cnpg-managed-roles-password-rotation-jan-2026.md           #|
#| ============================================================================= #|
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-db-secret
  namespace: identity
  labels:
    app.kubernetes.io/name: keycloak-postgres
    app.kubernetes.io/component: database-credentials
    #| CRITICAL: Required for CNPG to detect password changes and trigger rotation #|
    cnpg.io/reload: "true"
#| Type must be kubernetes.io/basic-auth for CNPG managed roles #|
type: kubernetes.io/basic-auth
stringData:
  username: "#{ keycloak_db_user | default('keycloak') }#"
  password: "#{ keycloak_db_password }#"
#% if keycloak_backup_enabled | default(false) %#
---
#| ============================================================================= #|
#| KEYCLOAK BACKUP CREDENTIALS - RustFS S3 storage for PostgreSQL backups       #|
#| ============================================================================= #|
#| Keycloak-specific credentials with access to keycloak-backups bucket only.   #|
#| Create via RustFS Console: user + keycloak-storage policy (see docs).        #|
#| Used by CNPG barmanObjectStore or embedded mode pg_dump CronJob.             #|
#| REF: docs/guides/keycloak-implementation.md#backup-strategy                  #|
#| ============================================================================= #|
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-backup-credentials
  namespace: identity
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: backup-credentials
type: Opaque
stringData:
  ACCESS_KEY_ID: "#{ keycloak_s3_access_key }#"
  SECRET_ACCESS_KEY: "#{ keycloak_s3_secret_key }#"
#% endif %#
#% endif %#
