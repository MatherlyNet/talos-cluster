#% if langfuse_enabled | default(false) %#
---
#| ============================================================================= #|
#| LANGFUSE HELM RELEASE                                                         #|
#| LLM observability platform - tracing, prompts, evaluation, analytics          #|
#| REF: https://langfuse.com/self-hosting/deployment/kubernetes-helm            #|
#| REF: https://github.com/langfuse/langfuse-k8s/blob/main/charts/langfuse      #|
#| REF: docs/research/langfuse-llm-observability-integration-jan-2026.md        #|
#| ============================================================================= #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
  namespace: ai-system
spec:
  chart:
    spec:
      chart: langfuse
      version: "#{ langfuse_chart_version | default('*') }#"
      sourceRef:
        kind: HelmRepository
        name: langfuse
        namespace: ai-system
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    #| ========================================================================= #|
    #| Core Application Configuration                                           #|
    #| ========================================================================= #|
    langfuse:
      nextauth:
        url: "https://#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#"
        secret:
          value: ""
          secretKeyRef:
            name: langfuse-credentials
            key: NEXTAUTH_SECRET
      salt:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: SALT
      encryptionKey:
        value: ""
        secretKeyRef:
          name: langfuse-credentials
          key: ENCRYPTION_KEY

      #| ======================================================================= #|
      #| Logging Configuration (via Helm chart values, not additionalEnv)       #|
      #| REF: https://langfuse.com/self-hosting/configuration                   #|
      #| ======================================================================= #|
      logging:
        level: "#{ langfuse_log_level | default('info') }#"
        format: "#{ langfuse_log_format | default('text') }#"

      #| ======================================================================= #|
      #| Feature Flags (via Helm chart values, not additionalEnv)               #|
      #| ======================================================================= #|
      features:
        signUpDisabled: #{ langfuse_disable_signup | default(false) | lower }#

      #| ======================================================================= #|
      #| Additional Environment Variables                                       #|
      #| Only for variables NOT supported by Helm chart values                  #|
      #| ======================================================================= #|
      additionalEnv:
        #| ===================================================================== #|
        #| Authentication Configuration                                         #|
        #| Cookie domain isolation prevents session collision with Gateway OIDC #|
        #| REF: docs/research/langfuse-seamless-sso-integration-jan-2026.md     #|
        #| ===================================================================== #|
        - name: NEXTAUTH_COOKIE_DOMAIN
          value: "#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#"
#% if langfuse_session_max_age | default('') %#
        - name: AUTH_SESSION_MAX_AGE
          value: "#{ langfuse_session_max_age }#"
#% endif %#
#% if langfuse_disable_password_auth | default(false) %#
        #| Disable username/password auth (SSO-only mode) #|
        - name: AUTH_DISABLE_USERNAME_PASSWORD
          value: "true"
#% endif %#
#% if langfuse_sso_domain_enforcement | default('') %#
        #| Force SSO for specific email domains #|
        - name: AUTH_DOMAINS_WITH_SSO_ENFORCEMENT
          value: "#{ langfuse_sso_domain_enforcement }#"
#% endif %#
#% if langfuse_cache_api_key_enabled is defined %#
        #| ===================================================================== #|
        #| Caching Configuration                                                #|
        #| REF: https://langfuse.com/self-hosting/configuration/caching         #|
        #| ===================================================================== #|
        - name: LANGFUSE_CACHE_API_KEY_ENABLED
          value: "#{ langfuse_cache_api_key_enabled | lower }#"
#% endif %#
#% if langfuse_cache_api_key_ttl | default('') %#
        - name: LANGFUSE_CACHE_API_KEY_TTL_SECONDS
          value: "#{ langfuse_cache_api_key_ttl }#"
#% endif %#
#% if langfuse_cache_prompt_enabled is defined %#
        - name: LANGFUSE_CACHE_PROMPT_ENABLED
          value: "#{ langfuse_cache_prompt_enabled | lower }#"
#% endif %#
#% if langfuse_cache_prompt_ttl | default('') %#
        - name: LANGFUSE_CACHE_PROMPT_TTL_SECONDS
          value: "#{ langfuse_cache_prompt_ttl }#"
#% endif %#
#% if langfuse_init_user_email | default('') and langfuse_init_user_password | default('') and langfuse_init_org_id | default('') %#
        #| ===================================================================== #|
        #| Headless Initialization - Bootstrap Initial Admin                    #|
        #| Creates admin account on first startup; credentials used only once   #|
        #| REF: https://langfuse.com/self-hosting/headless-initialization       #|
        #| ===================================================================== #|
        - name: LANGFUSE_INIT_ORG_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_ID
        - name: LANGFUSE_INIT_ORG_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_ORG_NAME
        - name: LANGFUSE_INIT_USER_EMAIL
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_EMAIL
        - name: LANGFUSE_INIT_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_PASSWORD
        - name: LANGFUSE_INIT_USER_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_USER_NAME
#% if langfuse_init_project_id | default('') %#
        #| Project initialization - create initial project alongside organization #|
        - name: LANGFUSE_INIT_PROJECT_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_ID
        - name: LANGFUSE_INIT_PROJECT_NAME
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_NAME
#% if langfuse_init_project_retention | default('') %#
        - name: LANGFUSE_INIT_PROJECT_RETENTION
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_RETENTION
#% endif %#
#% if langfuse_init_project_public_key | default('') and langfuse_init_project_secret_key | default('') %#
        - name: LANGFUSE_INIT_PROJECT_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_PUBLIC_KEY
        - name: LANGFUSE_INIT_PROJECT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-init-credentials
              key: LANGFUSE_INIT_PROJECT_SECRET_KEY
#% endif %#
#% endif %#
#% endif %#
#% if langfuse_default_org_role | default('') %#
        #| ===================================================================== #|
        #| Auto-Provisioning - Default access for new SSO users                 #|
        #| Assigns new users to default org/project with specified roles        #|
        #| REF: https://langfuse.com/self-hosting/automated-provisioning        #|
        #| ===================================================================== #|
        - name: LANGFUSE_DEFAULT_ORG_ID
          value: "#{ langfuse_default_org_id | default(langfuse_init_org_id) }#"
        - name: LANGFUSE_DEFAULT_ORG_ROLE
          value: "#{ langfuse_default_org_role }#"
#% endif %#
#% if langfuse_default_project_role | default('') %#
        - name: LANGFUSE_DEFAULT_PROJECT_ID
          value: "#{ langfuse_default_project_id | default(langfuse_init_project_id) }#"
        - name: LANGFUSE_DEFAULT_PROJECT_ROLE
          value: "#{ langfuse_default_project_role }#"
#% endif %#
#% if langfuse_sso_enabled | default(false) %#
        #| ===================================================================== #|
        #| Keycloak SSO Configuration                                           #|
        #| Configures native Langfuse authentication via Keycloak OIDC          #|
        #| REF: https://langfuse.com/self-hosting/authentication-and-sso        #|
        #| REF: docs/research/langfuse-seamless-sso-integration-jan-2026.md     #|
        #| ===================================================================== #|
        #| NOTE: Uses internal Keycloak URL for OIDC discovery (backchannel)    #|
        #| Keycloak's backchannelDynamic:true returns:                          #|
        #|   - External issuer URL in tokens (https://sso.domain.com)           #|
        #|   - Internal URLs for token/userinfo endpoints in OIDC config        #|
        #| This allows pods to reach Keycloak without external DNS hairpinning  #|
        #| ===================================================================== #|
        - name: AUTH_KEYCLOAK_CLIENT_ID
          value: "langfuse"
        - name: AUTH_KEYCLOAK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: langfuse-keycloak-credentials
              key: client-secret
        - name: AUTH_KEYCLOAK_ISSUER
          value: "#{ keycloak_internal_issuer_url }#"
        - name: AUTH_KEYCLOAK_ALLOW_ACCOUNT_LINKING
          value: "true"
        #| ===================================================================== #|
        #| PKCE Configuration (adds security layer to confidential client)      #|
        #| Keycloak client has: pkce.code.challenge.method: S256                #|
        #| NOTE: Confidential client = uses client_secret + PKCE (both)         #|
        #| AUTH_KEYCLOAK_CLIENT_AUTH_METHOD omitted = default client_secret_basic #|
        #| ===================================================================== #|
        - name: AUTH_KEYCLOAK_CHECKS
          value: "pkce,state"
#% endif %#

    #| ========================================================================= #|
    #| PostgreSQL - Use External CNPG Cluster                                   #|
    #| ========================================================================= #|
    postgresql:
      deploy: false
      host: "langfuse-postgresql-rw.ai-system.svc.cluster.local"
      port: 5432
      auth:
        username: "langfuse"
        existingSecret: "langfuse-postgresql-credentials"
        secretKeys:
          userPasswordKey: "password"
        database: "langfuse"

    #| ========================================================================= #|
    #| Redis - Use External Dragonfly                                           #|
    #| ========================================================================= #|
    redis:
      deploy: false
#% if dragonfly_enabled | default(false) %#
      host: "dragonfly.cache.svc.cluster.local"
      port: 6379
#% if dragonfly_acl_enabled | default(false) %#
      auth:
        username: "langfuse"
        existingSecret: "langfuse-redis-credentials"
        existingSecretPasswordKey: "password"
#% endif %#
#% endif %#

    #| ========================================================================= #|
    #| ClickHouse - Bundled for Analytics                                       #|
    #| ========================================================================= #|
    clickhouse:
      deploy: true
      replicaCount: #{ langfuse_clickhouse_replicas | default(1) }#
      #| Cluster mode: set to false for single-node deployments #|
      clusterEnabled: #{ langfuse_clickhouse_cluster_enabled | default(false) | lower }#
      persistence:
        enabled: true
        size: "#{ langfuse_clickhouse_storage | default('20Gi') }#"
        storageClass: "#{ cnpg_storage_class | default(storage_class) | default('local-path') }#"
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          memory: "4Gi"
      auth:
        existingSecret: "langfuse-clickhouse-credentials"
        existingSecretKey: "password"
      #| ZooKeeper persistence for ClickHouse cluster coordination #|
      zookeeper:
        persistence:
          enabled: true
          size: "#{ langfuse_zookeeper_storage | default('8Gi') }#"
          storageClass: "#{ cnpg_storage_class | default(storage_class) | default('local-path') }#"

    #| ========================================================================= #|
    #| S3 Storage - Use External RustFS                                         #|
    #| Multi-bucket configuration: events, media, batch exports                 #|
    #| REF: https://langfuse.com/self-hosting/deployment/infrastructure/blob    #|
    #| ========================================================================= #|
#% if rustfs_enabled | default(false) %#
    s3:
      deploy: false
      #| Primary S3 settings (used as defaults for event upload) #|
      bucket: "langfuse-events"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
#% if langfuse_s3_concurrent_writes | default('') or langfuse_s3_concurrent_reads | default('') %#
      #| S3 connection pool settings for high-throughput #|
#% if langfuse_s3_concurrent_writes | default('') %#
      concurrentWrites: #{ langfuse_s3_concurrent_writes }#
#% endif %#
#% if langfuse_s3_concurrent_reads | default('') %#
      concurrentReads: #{ langfuse_s3_concurrent_reads }#
#% endif %#
#% endif %#

    #| ======================================================================= #|
    #| Media Upload - Separate bucket for user uploads, images, files          #|
    #| ======================================================================= #|
    mediaUpload:
      enabled: true
      bucket: "#{ langfuse_media_bucket | default('langfuse-media') }#"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
#% if langfuse_media_max_size | default('') %#
      maxContentLength: #{ langfuse_media_max_size }#
#% endif %#
#% if langfuse_media_download_url_expiry | default('') %#
      downloadUrlExpirySeconds: #{ langfuse_media_download_url_expiry }#
#% endif %#

    #| ======================================================================= #|
    #| Batch Export - Separate bucket for data exports                         #|
    #| ======================================================================= #|
    batchExport:
      enabled: #{ langfuse_batch_export_enabled | default(true) | lower }#
      bucket: "#{ langfuse_export_bucket | default('langfuse-exports') }#"
      region: "us-east-1"
      endpoint: "http://rustfs-svc.storage.svc.cluster.local:9000"
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-s3-credentials
          key: AWS_SECRET_ACCESS_KEY
#% else %#
    s3:
      deploy: true
#% endif %#

    #| ========================================================================= #|
    #| Ingress / Gateway API                                                    #|
    #| ========================================================================= #|
    ingress:
      enabled: false

    #| ========================================================================= #|
    #| Resource Allocation                                                      #|
    #| ========================================================================= #|
    web:
      replicaCount: #{ langfuse_web_replicas | default(1) }#
      resources:
        requests:
          cpu: "#{ langfuse_web_cpu_request | default('200m') }#"
          memory: "#{ langfuse_web_memory_request | default('512Mi') }#"
        limits:
          memory: "#{ langfuse_web_memory_limit | default('2Gi') }#"

    worker:
      replicaCount: #{ langfuse_worker_replicas | default(1) }#
      resources:
        requests:
          cpu: "#{ langfuse_worker_cpu_request | default('200m') }#"
          memory: "#{ langfuse_worker_memory_request | default('512Mi') }#"
        limits:
          memory: "#{ langfuse_worker_memory_limit | default('2Gi') }#"

#% if langfuse_tracing_enabled | default(false) %#
    #| ========================================================================= #|
    #| OpenTelemetry Observability                                              #|
    #| ========================================================================= #|
    otel:
      enabled: true
      endpoint: "http://tempo.monitoring.svc.cluster.local:4318"
      serviceName: "langfuse"
      samplingRatio: "#{ langfuse_trace_sampling_ratio | default('0.1') }#"
#% endif %#
#% endif %#
