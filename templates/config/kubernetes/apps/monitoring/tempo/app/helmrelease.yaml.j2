#% if monitoring_enabled | default(false) and tracing_enabled | default(false) %#
---
#| ============================================================================= #|
#| TEMPO HELM RELEASE - Single Binary Mode with TraceQL Metrics                  #|
#| ============================================================================= #|
#| Note: Tempo's Helm chart does not support OCI registry (GitHub Issue #3068).  #|
#| Using HelmRepository (grafana) from Alloy deployment.                         #|
#|                                                                               #|
#| IMPORTANT: The Helm chart's default config template does NOT include          #|
#| processor.local_blocks configuration needed for TraceQL metrics queries.      #|
#| We override the entire 'config' value to include the required settings.       #|
#| Reference: https://grafana.com/docs/tempo/latest/metrics-from-traces/         #|
#| ============================================================================= #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
spec:
  chart:
    spec:
      chart: tempo
      version: "1.24.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: monitoring
  interval: 1h
  timeout: 10m
  values:
    #| ========================================================================= #|
    #| tempo: key - these values are used by the chart's config template,       #|
    #| BUT we override config entirely below to include processor.local_blocks  #|
    #| ========================================================================= #|
    tempo:
      metricsGenerator:
        enabled: true
        remoteWriteUrl: "http://kube-prometheus-stack-prometheus:9090/api/v1/write"

    #| ========================================================================= #|
    #| CUSTOM CONFIG OVERRIDE                                                   #|
    #| The Helm chart template only adds basic metrics_generator section.       #|
    #| We provide complete config with processor.local_blocks for TraceQL.      #|
    #| Reference: https://github.com/grafana/tempo/blob/main/example/docker-compose/local/tempo.yaml #|
    #| ========================================================================= #|
    config: |
      multitenancy_enabled: false
      usage_report:
        reporting_enabled: false
      compactor:
        compaction:
          block_retention: #{ trace_retention | default('72h') }#
      distributor:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "0.0.0.0:4317"
              http:
                endpoint: "0.0.0.0:4318"
          zipkin:
            endpoint: "0.0.0.0:9411"
      ingester:
        max_block_duration: 5m
      server:
        http_listen_port: 3200
        grpc_listen_port: 9095
      storage:
        trace:
          backend: local
          local:
            path: /var/tempo/traces
          wal:
            path: /var/tempo/wal
      querier:
        max_concurrent_queries: 20
      query_frontend:
        search:
          max_duration: 0
      #| ===================================================================== #|
      #| METRICS GENERATOR with local-blocks processor                        #|
      #| Required for TraceQL metrics queries like { } | rate()               #|
      #| ===================================================================== #|
      metrics_generator:
        processor:
          local_blocks:
            #| filter_server_spans: false retains all spans, not just server spans #|
            filter_server_spans: false
            #| flush_to_storage: true enables historical TraceQL metrics queries #|
            flush_to_storage: true
          service_graphs:
            histogram_buckets: [0.1, 0.2, 0.4, 0.8, 1.6, 3.2, 6.4, 12.8]
            dimensions: []
          span_metrics:
            histogram_buckets: [0.002, 0.004, 0.008, 0.016, 0.032, 0.064, 0.128, 0.256, 0.512, 1.024, 2.048, 4.096, 8.192, 16.384]
            dimensions: []
        registry:
          collection_interval: 15s
          stale_duration: 15m
        storage:
          path: /var/tempo/generator/wal
          remote_write:
            - url: http://kube-prometheus-stack-prometheus:9090/api/v1/write
              send_exemplars: true
        traces_storage:
          path: /var/tempo/generator/traces
      #| ===================================================================== #|
      #| OVERRIDES: Enable processors for TraceQL metrics                     #|
      #| Must use new format (defaults.metrics_generator.processors)          #|
      #| ===================================================================== #|
      overrides:
        defaults:
          metrics_generator:
            processors:
              - local-blocks
              - service-graphs
              - span-metrics

    #| ========================================================================= #|
    #| Persistence - enabled for trace data durability                         #|
    #| ========================================================================= #|
    persistence:
      enabled: true
      storageClassName: "#{ storage_class | default('local-path') }#"
      size: "#{ trace_storage_size | default('10Gi') }#"

    #| ========================================================================= #|
    #| Resources - homelab-appropriate sizing                                   #|
    #| ========================================================================= #|
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

    #| ========================================================================= #|
    #| Health probes for reliability                                           #|
    #| ========================================================================= #|
    readinessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 15
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /ready
        port: 3200
      initialDelaySeconds: 45
      periodSeconds: 30
      timeoutSeconds: 5

    #| ========================================================================= #|
    #| ServiceMonitor for Prometheus to scrape Tempo metrics                   #|
    #| ========================================================================= #|
    serviceMonitor:
      enabled: true
#% endif %#