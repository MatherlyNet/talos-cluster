#% if keycloak_enabled | default(false) %#
---
#| HTTPRoute for Keycloak via Envoy Gateway #|
#| Attached to BOTH gateways for split-horizon DNS (prevents asymmetric routing) #|
#| - External users: Cloudflare DNS → envoy-external (192.168.22.90) → Keycloak #|
#| - Internal users: UniFi DNS → envoy-internal (192.168.22.80) → Keycloak #|
#| Both paths are symmetric; DNS determines the complete request/response path #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: keycloak
  namespace: identity
spec:
  parentRefs:
    #| External gateway: cloudflare-dns creates Cloudflare record (public access via tunnel) #|
    - name: envoy-external
      namespace: network
    #| Internal gateway: unifi-dns creates UniFi record (direct LAN access) #|
    - name: envoy-internal
      namespace: network
  hostnames:
    - "#{ keycloak_subdomain | default('auth') }#.${SECRET_DOMAIN}"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        #| Service created by Keycloak operator: keycloak-service #|
        - name: keycloak-service
          port: 8080
---
#| Headless service for JGroups DNS discovery (HA clustering) #|
#% if (keycloak_replicas | default(1)) > 1 %#
apiVersion: v1
kind: Service
metadata:
  name: keycloak-discovery
  namespace: identity
  labels:
    app.kubernetes.io/name: keycloak
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 7800
      name: jgroups
  selector:
    app.kubernetes.io/name: keycloak
#% endif %#
#% endif %#
