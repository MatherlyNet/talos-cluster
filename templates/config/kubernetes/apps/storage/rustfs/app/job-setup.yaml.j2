#% if rustfs_enabled | default(false) %#
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rustfs-bucket-setup
  annotations:
    #| Prevent Flux from deleting the job after bucket setup completes #|
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-rustfs
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for RustFS to be ready..."
              #| RustFS uses /health endpoint, not MinIO's /minio/health/ready #|
              until wget -q --spider http://rustfs-svc.storage.svc:9000/health; do
                echo "RustFS not ready, waiting..."
                sleep 10
              done
              echo "RustFS is ready!"
      containers:
        - name: setup
          #| Pin mc version for reproducibility - RELEASE.2024-11-21T17-21-54Z #|
          image: minio/mc:RELEASE.2024-11-21T17-21-54Z
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Configuring mc alias for RustFS..."
              mc alias set rustfs http://rustfs-svc.storage.svc:9000 "$RUSTFS_ACCESS_KEY" "$RUSTFS_SECRET_KEY"

              echo "Creating buckets..."
#% if loki_enabled | default(false) %#
              #| Loki buckets - access keys must be created manually in RustFS UI #|
              #| See: https://docs.rustfs.com/administration/iam/access-token.html #|
              mc mb --ignore-existing rustfs/loki-chunks
              mc mb --ignore-existing rustfs/loki-ruler
              mc mb --ignore-existing rustfs/loki-admin
              echo "Loki buckets created."
              echo "NOTE: Create Loki access keys in RustFS Console (port 9001) and update cluster.yaml"
#% endif %#

              #| General backup bucket #|
              mc mb --ignore-existing rustfs/backups
              echo "Backup bucket created."

              echo ""
              echo "============================================="
              echo "Bucket setup complete!"
              echo "============================================="
              mc ls rustfs/
              echo ""
              echo "NEXT STEPS:"
              echo "1. Access RustFS Console at https://rustfs.#{ cloudflare_domain }#"
              echo "2. Login with RUSTFS_ACCESS_KEY / RUSTFS_SECRET_KEY"
#% if loki_enabled | default(false) %#
              echo "3. Navigate to Identity -> Users -> Create Access Key for Loki"
              echo "4. Update loki_s3_access_key/loki_s3_secret_key in cluster.yaml"
              echo "5. Run 'task configure' and 'task reconcile' to apply changes"
#% else %#
              echo "3. RustFS is ready for use!"
#% endif %#
              echo "============================================="
          env:
            #| Fix for mc permission denied: mc needs writable HOME for config #|
            - name: HOME
              value: "/tmp"
            - name: MC_CONFIG_DIR
              value: "/tmp/.mc"
            #| Secret keys use 'access_key'/'secret_key' per RustFS Helm chart convention #|
            #| REF: https://github.com/rustfs/rustfs/blob/main/helm/README.md #|
            - name: RUSTFS_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: access_key
            - name: RUSTFS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: secret_key
#% endif %#
