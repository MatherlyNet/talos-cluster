# Infrastructure Secrets Consolidation Research

**Date:** January 2026
**Status:** Research Complete - Ready for Implementation
**Priority:** High (Workflow Inconsistency)

## Executive Summary

The current infrastructure workflow requires manual `task infra:secrets-edit` steps that are inconsistent with the rest of the project's pattern where secrets are defined in `cluster.yaml` (gitignored) and templated into SOPS-encrypted files.

This document identifies all files requiring changes and provides a comprehensive implementation plan to consolidate infrastructure secrets into `cluster.yaml`.

## Problem Statement

### Current Workflow (Inconsistent)

```bash
task configure              # 1. Renders templates with placeholder values
task infra:secrets-edit     # 2. MANUAL: User must edit secrets.sops.yaml
task infra:init             # 3. Initialize OpenTofu backend
```

### Expected Workflow (Consistent with Project)

```bash
# User edits cluster.yaml with all values (including secrets)
task configure              # 1. Renders templates with ACTUAL values
                            # 2. Auto-runs infra:init if infrastructure_enabled
```

### Root Cause

The `secrets.sops.yaml.j2` template generates placeholder values like `"CHANGE-ME-..."` instead of reading from `cluster.yaml`, unlike every other secret in the project.

## Impact Analysis

### Files Requiring Changes

#### 1. Schema Files (2 files)

| File | Change Required |
|------|-----------------|
| `.taskfiles/template/resources/cluster.schema.cue` | Add 5 new optional fields |
| `.taskfiles/template/resources/cluster.schema.json` | Auto-generated from CUE |

**New Fields to Add:**

```cue
// Cloudflare Account (for R2 state backend)
cf_account_id?: string & !=""

// OpenTofu R2 State Backend
tfstate_username?: *"terraform" | string & !=""
tfstate_password?: string & !=""

// Infrastructure (OpenTofu) API Token
// NOTE: Separate from proxmox_csi_token and proxmox_ccm_token for least-privilege
proxmox_api_token_id?:     string & =~"^.+@.+!.+$"
proxmox_api_token_secret?: string & !=""
```

#### 2. Sample Configuration (1 file)

| File | Change Required |
|------|-----------------|
| `cluster.sample.yaml` | Add new fields in Infrastructure section |

**Add to Infrastructure Section (lines ~255-275):**

```yaml
# =============================================================================
# INFRASTRUCTURE CREDENTIALS (OpenTofu/R2 State Backend)
# =============================================================================

# -- Cloudflare Account ID (Dashboard → Overview → right sidebar)
#    (OPTIONAL) / Required for R2 state backend
# cf_account_id: ""

# -- tfstate-worker Basic Auth credentials
#    (OPTIONAL) / Must match secrets in your tfstate-worker deployment
# tfstate_username: "terraform"
# tfstate_password: ""

# -- Proxmox API token for OpenTofu VM provisioning
#    (OPTIONAL) / Create at: Datacenter → Permissions → API Tokens → Add
#    Format: user@realm!token-name (e.g., root@pam!terraform)
#    NOTE: Separate from CSI/CCM tokens for least-privilege
# proxmox_api_token_id: ""
# proxmox_api_token_secret: ""
```

#### 3. Template Files (2 files)

| File | Change Required |
|------|-----------------|
| `templates/config/infrastructure/secrets.sops.yaml.j2` | Use cluster.yaml values instead of placeholders |
| `templates/config/infrastructure/tofu/providers.tf.j2` | Remove "Use task infra:secrets-edit" comment |

**Updated `secrets.sops.yaml.j2`:**

```yaml
#| Generated by makejinja from cluster.yaml - DO NOT EDIT directly #|
---
# Infrastructure Secrets for OpenTofu R2 Backend
# Source: cluster.yaml (gitignored)

# Cloudflare Account
cf_account_id: "#{ cf_account_id | default('') }#"

# R2 State Backend Authentication
tfstate_username: "#{ tfstate_username | default('terraform') }#"
tfstate_password: "#{ tfstate_password | default('') }#"

#% if infrastructure_enabled %#
# Proxmox API Credentials
proxmox_api_token_id: "#{ proxmox_api_token_id }#"
proxmox_api_token_secret: "#{ proxmox_api_token_secret }#"
#% endif %#
```

#### 4. Taskfile Changes (1 file)

| File | Change Required |
|------|-----------------|
| `.taskfiles/template/Taskfile.yaml` | Add conditional infra:init step |

**Add after `validate-talos-config` in `:configure`:**

```yaml
:configure:
  cmds:
    - task: validate-schemas
    - task: schema
    - task: render-configs
    - task: encrypt-secrets
    - task: validate-kubernetes-config
    - task: validate-talos-config
    - task: maybe-init-infra  # NEW

maybe-init-infra:
  internal: true
  cmds:
    - |
      if [ -f {{.INFRASTRUCTURE_DIR}}/tofu/backend.tf ]; then
        # Check if tfstate_password is configured (not empty/placeholder)
        PASS=$(sops -d {{.INFRASTRUCTURE_DIR}}/secrets.sops.yaml 2>/dev/null | yq -r '.tfstate_password // ""')
        if [ -n "$PASS" ] && [[ "$PASS" != "CHANGE-ME"* ]] && [[ "$PASS" != "" ]]; then
          echo "Infrastructure credentials configured, initializing OpenTofu..."
          cd {{.INFRASTRUCTURE_DIR}}/tofu
          export TF_HTTP_USERNAME=$(sops -d {{.INFRASTRUCTURE_DIR}}/secrets.sops.yaml | yq -r '.tfstate_username')
          export TF_HTTP_PASSWORD="$PASS"
          tofu init -input=false -no-color || echo "Note: Run 'task infra:init' manually if backend is not yet deployed"
        else
          echo "Infrastructure secrets not configured, skipping infra:init"
          echo "To enable: add tfstate_password to cluster.yaml"
        fi
      fi
  status:
    - test ! -f {{.INFRASTRUCTURE_DIR}}/tofu/backend.tf
```

#### 5. Documentation Files (12 files)

| File | Lines | Change Required |
|------|-------|-----------------|
| `README.md` | 262-276, 307 | Remove/update secrets-edit steps |
| `CLAUDE.md` | 52-57, 268 | Update command reference |
| `AGENTS.md` | 74-79 | Update command reference |
| `PROJECT_INDEX.md` | 89-92 | Update command list |
| `PROJECT_INDEX.json` | 94-97 | Update command list |
| `docs/CLI_REFERENCE.md` | 100, 127 | Update or remove secrets-edit |
| `docs/CONFIGURATION.md` | ~246 | Add new fields documentation |
| `docs/ai-context/infrastructure-opentofu.md` | 289-300, 402 | Update workflow |
| `docs/guides/opentofu-r2-state-backend.md` | 198-222 | Update workflow |
| `templates/config/infrastructure/README.md` | 51-72, 89, 139, 193, 208, 231 | Update workflow |
| `templates/config/infrastructure/tofu/backend.tf.j2` | 9-10 | Remove secrets-edit reference |
| `docs/TESTING_AND_DOCUMENTATION_COVERAGE_REPORT.md` | 637, 661, 671 | Update coverage |

#### 6. Plugin File (1 file)

| File | Change Required |
|------|-----------------|
| `templates/scripts/plugin.py` | No changes needed - infrastructure_enabled logic already exists |

## Implementation Plan

### Phase 1: Schema and Sample Updates

1. Update `.taskfiles/template/resources/cluster.schema.cue`:
   - Add `cf_account_id`, `tfstate_username`, `tfstate_password`
   - Add `proxmox_api_token_id`, `proxmox_api_token_secret`

2. Run `task template:schema` to regenerate JSON schema

3. Update `cluster.sample.yaml`:
   - Add new fields in Infrastructure section with documentation

### Phase 2: Template Updates

4. Update `templates/config/infrastructure/secrets.sops.yaml.j2`:
   - Replace placeholder values with template variables
   - Remove "Edit with task infra:secrets-edit" comments

5. Update `templates/config/infrastructure/tofu/providers.tf.j2`:
   - Remove line 6 comment about secrets-edit

6. Update `templates/config/infrastructure/tofu/backend.tf.j2`:
   - Remove lines 9-10 about secrets-edit

### Phase 3: Workflow Automation

7. Update `.taskfiles/template/Taskfile.yaml`:
   - Add `maybe-init-infra` internal task
   - Add to `:configure` command list

### Phase 4: Documentation Updates

8. Update all 12 documentation files:
   - Remove `task infra:secrets-edit` from required steps
   - Update workflow descriptions
   - Note that secrets now come from `cluster.yaml`

9. Keep `task infra:secrets-edit` available but document as:
   - "For credential rotation"
   - "For troubleshooting"
   - Not required for initial setup

## Backwards Compatibility

### Migration Path for Existing Users

Users who have already configured `infrastructure/secrets.sops.yaml`:

1. Their existing encrypted secrets continue to work
2. The template will overwrite with cluster.yaml values on next `task configure`
3. They should migrate values to `cluster.yaml` before running `task configure`

**Migration Steps:**

```bash
# 1. Decrypt current secrets
sops -d infrastructure/secrets.sops.yaml > /tmp/secrets.yaml

# 2. Copy values to cluster.yaml
# cf_account_id, tfstate_username, tfstate_password, etc.

# 3. Delete old secrets file (will be regenerated)
rm infrastructure/secrets.sops.yaml

# 4. Regenerate from cluster.yaml
task configure
```

### Deprecation Notice

Add to release notes:

> **Breaking Change:** Infrastructure secrets are now configured in `cluster.yaml` instead of `infrastructure/secrets.sops.yaml`.
>
> The `task infra:secrets-edit` command remains available for credential rotation but is no longer required for initial setup.
>
> **Migration Required:** Copy values from `infrastructure/secrets.sops.yaml` to `cluster.yaml` before running `task configure`.

## Testing Checklist

- [ ] New fields validate correctly in CUE schema
- [ ] `task configure` generates valid secrets.sops.yaml with actual values
- [ ] `task configure` auto-runs `infra:init` when credentials present
- [ ] `task configure` skips `infra:init` when credentials missing
- [ ] `task infra:plan` works after configure
- [ ] Existing users can migrate successfully
- [ ] Documentation accurately reflects new workflow

## Summary of Changes

| Category | Files | Additions | Modifications |
|----------|-------|-----------|---------------|
| Schema | 2 | 5 new fields | - |
| Sample Config | 1 | ~20 lines | - |
| Templates | 2 | - | Replace placeholders |
| Taskfile | 1 | 1 new task | - |
| Documentation | 12 | - | Update workflows |
| **Total** | **18** | - | - |

## Recommendation

**Proceed with implementation.** This change:

1. **Reduces friction** - Eliminates manual secrets-edit step
2. **Improves consistency** - Matches project's established pattern
3. **Enables automation** - `task configure` becomes truly one-command
4. **Maintains security** - `cluster.yaml` is already gitignored
5. **Low risk** - Backwards compatible with migration path

## References

- Current workflow: `README.md` lines 262-276
- Infrastructure README: `templates/config/infrastructure/README.md`
- Secrets template: `templates/config/infrastructure/secrets.sops.yaml.j2`
- R2 Backend Guide: `docs/guides/opentofu-r2-state-backend.md`
