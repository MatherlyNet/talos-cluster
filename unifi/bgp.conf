! =============================================================================
! BGP Configuration for MatherlyNet/talos-cluster
! Generated by: makejinja template
! Upload to UniFi: Settings -> Routing -> BGP -> Add Configuration
!
! Requirements:
! - UniFi OS 4.1.13+ (or UXG-Enterprise 4.1.8+)
! - BGP configuration enabled in cluster.yaml
!
! REF: https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/
! REF: https://help.ui.com/hc/en-us/articles/16271338193559-UniFi-Border-Gateway-Protocol-BGP
! =============================================================================

router bgp 65533
  bgp router-id 192.168.23.254
  no bgp ebgp-requires-policy
  no bgp default ipv4-unicast
  no bgp network import-check
  !
  ! ECMP - Enable multi-path routing for load distribution across advertising nodes
  bgp bestpath as-path multipath-relax
  maximum-paths 3
  !
  ! Peer group for Kubernetes nodes
  neighbor TALOS peer-group
  neighbor TALOS remote-as 64513
  neighbor TALOS timers 10 30
  neighbor TALOS password 3ElCb9VsGg291MJ0fqeZWQQXufdntXux
  !
  ! Add each Kubernetes node as a neighbor
  ! Node IPs from nodes.yaml:
  neighbor 192.168.22.101 peer-group TALOS
  neighbor 192.168.22.102 peer-group TALOS
  neighbor 192.168.22.103 peer-group TALOS
  neighbor 192.168.22.111 peer-group TALOS
  neighbor 192.168.22.112 peer-group TALOS
  neighbor 192.168.22.113 peer-group TALOS
  !
  address-family ipv4 unicast
    neighbor TALOS activate
    neighbor TALOS next-hop-self
    neighbor TALOS soft-reconfiguration inbound
    neighbor TALOS route-map ACCEPT-K8S in
  exit-address-family
!
exit
!
! =============================================================================
! Prefix List - Only accept LoadBalancer IPs from the cluster
! =============================================================================
! Using node network for LoadBalancer IPs
ip prefix-list K8S-LOADBALANCER seq 5 permit 192.168.20.0/22 ge 32
!
route-map ACCEPT-K8S permit 10
  match ip address prefix-list K8S-LOADBALANCER
exit
