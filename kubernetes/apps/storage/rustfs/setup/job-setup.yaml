---
apiVersion: batch/v1
kind: Job
metadata:
  name: rustfs-bucket-setup
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-rustfs
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for RustFS to be ready..."
              until wget -q --spider http://rustfs-svc.storage.svc:9000/health; do
                echo "RustFS not ready, waiting..."
                sleep 10
              done
              echo "RustFS is ready!"
      containers:
        - name: setup
          image: minio/mc:RELEASE.2024-11-21T17-21-54Z
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Configuring mc alias for RustFS..."
              mc alias set rustfs http://rustfs-svc.storage.svc:9000 "$RUSTFS_ACCESS_KEY" "$RUSTFS_SECRET_KEY"

              echo "Creating buckets..."
              mc mb --ignore-existing rustfs/loki-chunks
              mc mb --ignore-existing rustfs/loki-ruler
              mc mb --ignore-existing rustfs/loki-admin
              echo "Loki buckets created."
              echo "NOTE: Create Loki access keys in RustFS Console (port 9001) and update cluster.yaml"

              mc mb --ignore-existing rustfs/etcd-backups
              echo "etcd-backups bucket created."
              echo "NOTE: Create Talos backup access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/cnpg-backups
              echo "cnpg-backups bucket created."
              echo "NOTE: Create CNPG backup access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/keycloak-backups
              echo "keycloak-backups bucket created."
              echo "NOTE: Create Keycloak backup access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/dragonfly-backups
              echo "dragonfly-backups bucket created."
              echo "NOTE: Create Dragonfly backup access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/litellm-backups
              echo "litellm-backups bucket created."
              echo "NOTE: Create LiteLLM backup access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/langfuse-events
              mc mb --ignore-existing rustfs/langfuse-media
              mc mb --ignore-existing rustfs/langfuse-exports
              echo "Langfuse S3 buckets created (events, media, exports)."
              echo "NOTE: Create Langfuse S3 access keys in RustFS Console and update cluster.yaml"

              mc mb --ignore-existing rustfs/langfuse-postgres-backups
              echo "langfuse-postgres-backups bucket created."
              echo "NOTE: Create Langfuse backup access keys in RustFS Console and update cluster.yaml"


              echo ""
              echo "============================================="
              echo "Bucket setup complete!"
              echo "============================================="
              mc ls rustfs/
              echo ""
              echo "NEXT STEPS:"
              echo "1. Access RustFS Console at https://rustfs.matherly.net"
              echo "2. Login with RUSTFS_ACCESS_KEY / RUSTFS_SECRET_KEY"
              echo ""
              echo "For each service, create a scoped policy, group, and user:"
              echo "(See: docs/guides/talos-backup-rustfs-implementation.md)"
              echo ""
              echo "LOKI (monitoring group):"
              echo "  - Create 'loki-storage' policy scoped to loki-* buckets"
              echo "  - Create 'monitoring' group with policy attached"
              echo "  - Create 'loki' user in monitoring group"
              echo "  - Update loki_s3_access_key/loki_s3_secret_key in cluster.yaml"
              echo ""
              echo "TALOS BACKUP (backups group):"
              echo "  - Create 'backup-storage' policy scoped to etcd-backups bucket"
              echo "  - Create 'backups' group with policy attached"
              echo "  - Create 'talos-backup' user in backups group"
              echo "  - Update backup_s3_access_key/backup_s3_secret_key in cluster.yaml"
              echo ""
              echo "CNPG BACKUP (databases group):"
              echo "  - Create 'database-storage' policy scoped to cnpg-backups bucket"
              echo "  - Create 'databases' group with policy attached"
              echo "  - Create 'cnpg-backup' user in databases group"
              echo "  - Update cnpg_s3_access_key/cnpg_s3_secret_key in cluster.yaml"
              echo "  - See: docs/guides/cnpg-implementation.md"
              echo ""
              echo "KEYCLOAK BACKUP (identity group):"
              echo "  - Create 'keycloak-storage' policy scoped to keycloak-backups bucket"
              echo "  - Create 'identity' group with policy attached"
              echo "  - Create 'keycloak-backup' user in identity group"
              echo "  - Update keycloak_s3_access_key/keycloak_s3_secret_key in cluster.yaml"
              echo "  - See: docs/guides/keycloak-implementation.md"
              echo ""
              echo "DRAGONFLY BACKUP (cache group):"
              echo "  - Create 'dragonfly-storage' policy scoped to dragonfly-backups bucket"
              echo "  - Create 'cache' group with policy attached"
              echo "  - Create 'dragonfly-backup' user in cache group"
              echo "  - Update dragonfly_s3_access_key/dragonfly_s3_secret_key in cluster.yaml"
              echo "  - See: docs/research/dragonfly-redis-alternative-integration-jan-2026.md"
              echo ""
              echo "LITELLM BACKUP (ai-system group):"
              echo "  - Create 'litellm-storage' policy scoped to litellm-backups bucket"
              echo "  - Create 'ai-system' group with policy attached"
              echo "  - Create 'litellm-backup' user in ai-system group"
              echo "  - Update litellm_s3_access_key/litellm_s3_secret_key in cluster.yaml"
              echo "  - See: docs/research/litellm-proxy-gateway-integration-jan-2026.md"
              echo ""
              echo "LANGFUSE S3 (ai-system group):"
              echo "  - Create 'langfuse-storage' policy scoped to langfuse-* buckets"
              echo "  - Create 'ai-system' group with policy attached (if not exists)"
              echo "  - Create 'langfuse-s3' user in ai-system group"
              echo "  - Update langfuse_s3_access_key/langfuse_s3_secret_key in cluster.yaml"
              echo "  - See: docs/research/langfuse-llm-observability-integration-jan-2026.md"
              echo ""
              echo "LANGFUSE BACKUP (ai-system group):"
              echo "  - Create 'langfuse-backup-storage' policy scoped to langfuse-postgres-backups bucket"
              echo "  - Create 'langfuse-backup' user in ai-system group"
              echo "  - Update langfuse_backup_s3_access_key/langfuse_backup_s3_secret_key in cluster.yaml"
              echo "  - See: docs/research/langfuse-llm-observability-integration-jan-2026.md"
              echo ""
              echo "Then run: task configure && task reconcile"
              echo "============================================="
          env:
            - name: HOME
              value: "/tmp"
            - name: MC_CONFIG_DIR
              value: "/tmp/.mc"
            - name: RUSTFS_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: RUSTFS_ACCESS_KEY
            - name: RUSTFS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-credentials
                  key: RUSTFS_SECRET_KEY
