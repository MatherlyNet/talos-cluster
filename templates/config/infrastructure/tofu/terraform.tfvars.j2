#| Generated by makejinja from cluster.yaml and nodes.yaml - DO NOT EDIT #|
#| To modify, edit cluster.yaml/nodes.yaml and run: task configure #|

#% if infrastructure_enabled %#
# =============================================================================
# Proxmox Configuration
# =============================================================================

proxmox_api_url = "#{ proxmox_api_url }#"
proxmox_node    = "#{ proxmox_node }#"
#% if proxmox_insecure is defined %#
proxmox_insecure = #{ proxmox_insecure | lower }#
#% endif %#

# Storage Configuration
proxmox_iso_storage  = "#{ proxmox_iso_storage }#"
proxmox_disk_storage = "#{ proxmox_disk_storage }#"

# =============================================================================
# VM Default Settings
# =============================================================================
# Global defaults (fallback for all nodes)
vm_defaults = {
  cores     = #{ proxmox_vm_defaults.cores }#
  sockets   = #{ proxmox_vm_defaults.sockets }#
  memory    = #{ proxmox_vm_defaults.memory }#
  disk_size = #{ proxmox_vm_defaults.disk_size }#
}

# Controller node defaults (optimized for etcd and control plane)
vm_controller_defaults = {
  cores     = #{ proxmox_vm_controller_defaults.cores }#
  sockets   = #{ proxmox_vm_controller_defaults.sockets }#
  memory    = #{ proxmox_vm_controller_defaults.memory }#
  disk_size = #{ proxmox_vm_controller_defaults.disk_size }#
}

# Worker node defaults (optimized for running workloads)
vm_worker_defaults = {
  cores     = #{ proxmox_vm_worker_defaults.cores }#
  sockets   = #{ proxmox_vm_worker_defaults.sockets }#
  memory    = #{ proxmox_vm_worker_defaults.memory }#
  disk_size = #{ proxmox_vm_worker_defaults.disk_size }#
}

# =============================================================================
# VM Advanced Settings (Talos-optimized)
# =============================================================================

vm_advanced = {
  bios           = "#{ proxmox_vm_advanced.bios }#"
  machine        = "#{ proxmox_vm_advanced.machine }#"
  cpu_type       = "#{ proxmox_vm_advanced.cpu_type }#"
  scsi_hw        = "#{ proxmox_vm_advanced.scsi_hw }#"
  balloon        = #{ proxmox_vm_advanced.balloon }#
  numa           = #{ proxmox_vm_advanced.numa | lower }#
  qemu_agent     = #{ proxmox_vm_advanced.qemu_agent | lower }#
  net_queues     = #{ proxmox_vm_advanced.net_queues }#
  disk_discard   = #{ proxmox_vm_advanced.disk_discard | lower }#
  disk_ssd       = #{ proxmox_vm_advanced.disk_ssd | lower }#
  tags           = [#% for tag in proxmox_vm_advanced.tags %#"#{ tag }#"#% if not loop.last %#, #% endif %##% endfor %#]
  # Network configuration
  network_bridge = "#{ proxmox_vm_advanced.network_bridge }#"
  # Guest OS configuration
  ostype         = "#{ proxmox_vm_advanced.ostype }#"
  # Storage flags
  disk_backup    = #{ proxmox_vm_advanced.disk_backup | lower }#
  disk_replicate = #{ proxmox_vm_advanced.disk_replicate | lower }#
}

# =============================================================================
# Network Configuration
# =============================================================================

node_cidr            = "#{ node_cidr }#"
node_default_gateway = "#{ node_default_gateway }#"
#% if node_vlan_tag is defined %#
node_vlan_tag        = "#{ node_vlan_tag }#"
#% else %#
node_vlan_tag        = null
#% endif %#

# =============================================================================
# Node Definitions
# =============================================================================

nodes = [
#% for node in nodes %#
#| Role-based defaults: controller uses proxmox_vm_controller_defaults, worker uses proxmox_vm_worker_defaults #|
#% set role_defaults = proxmox_vm_controller_defaults if node.controller else proxmox_vm_worker_defaults %#
  {
    name             = "#{ node.name }#"
    address          = "#{ node.address }#"
    controller       = #{ node.controller | lower }#
    mac_addr         = "#{ node.mac_addr }#"
    schematic_id     = "#{ node.schematic_id }#"
    disk             = "#{ node.disk }#"
    # VM resource overrides (fallback chain: per-node -> role-defaults -> global-defaults)
    vm_cores         = #{ node.vm_cores | default(role_defaults.cores) }#
    vm_sockets       = #{ node.vm_sockets | default(role_defaults.sockets) }#
    vm_memory        = #{ node.vm_memory | default(role_defaults.memory) }#
    vm_disk_size     = #{ node.vm_disk_size | default(role_defaults.disk_size) }#
    # Startup/shutdown configuration
    vm_startup_order  = #{ node.vm_startup_order | default(loop.index + 3) }#
    vm_startup_delay  = #{ node.vm_startup_delay | default(15) }#
    vm_shutdown_delay = #{ node.vm_shutdown_delay | default(60) }#
    # Optional node settings
#% if node.mtu is defined %#
    mtu              = #{ node.mtu }#
#% else %#
    mtu              = null
#% endif %#
#% if node.secureboot is defined %#
    secureboot       = #{ node.secureboot | lower }#
#% else %#
    secureboot       = false
#% endif %#
  },
#% endfor %#
]

# =============================================================================
# Cluster Network Configuration (for reference in VM provisioning)
# =============================================================================

cluster_api_addr = "#{ cluster_api_addr }#"
cluster_pod_cidr = "#{ cluster_pod_cidr }#"
cluster_svc_cidr = "#{ cluster_svc_cidr }#"

# =============================================================================
# Talos Version (for ISO download from Image Factory)
# =============================================================================

talos_version = "#{ talos_version }#"

#% else %#
# =============================================================================
# Infrastructure provisioning not configured
# =============================================================================
#
# To enable Proxmox VM provisioning, add the following to cluster.yaml:
#
#   proxmox_api_url: "https://pve.example.com:8006/api2/json"
#   proxmox_node: "pve"
#
# See cluster.sample.yaml for full configuration options.
#
#% endif %#
