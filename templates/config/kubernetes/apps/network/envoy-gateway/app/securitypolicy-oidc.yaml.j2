#% if oidc_sso_enabled %#
---
# SecurityPolicy for OIDC-based Web SSO authentication
# REF: https://gateway.envoyproxy.io/docs/tasks/security/oidc/
# REF: docs/guides/native-oidc-securitypolicy-implementation.md
# REF: docs/research/envoy-gateway-keycloak-oidc-integration-jan-2026.md
#
# NOTE: This cluster uses Envoy Gateway v0.0.0-latest for Kubernetes 1.35 support.
# API Version: gateway.envoyproxy.io/v1alpha1 (SecurityPolicy has not graduated to v1)
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-sso
  namespace: network
spec:
  # Target HTTPRoutes with the security: oidc-protected label
  # NOTE: SecurityPolicy can only target resources in the same namespace
  targetSelectors:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      matchLabels:
        security: oidc-protected
  oidc:
    provider:
      issuer: "#{ oidc_issuer_url }#"
      #% if oidc_authorization_endpoint is defined %#
      authorizationEndpoint: "#{ oidc_authorization_endpoint }#"
      #% endif %#
      #% if oidc_token_endpoint is defined %#
      tokenEndpoint: "#{ oidc_token_endpoint }#"
      #% endif %#
    clientID: "#{ oidc_client_id }#"
    clientSecret:
      name: oidc-client-secret
    redirectURL: "#{ oidc_redirect_url }#"
    logoutPath: "#{ oidc_logout_path | default('/logout') }#"
    #% if oidc_cookie_domain is defined %#
    cookieDomain: "#{ oidc_cookie_domain }#"
    #% endif %#
    #| =========================================================================== #|
    #| OIDC COOKIE SETTINGS (v1.5+/v1.6+ features)                                 #|
    #| =========================================================================== #|
    #| refreshToken: Auto-refresh tokens when expired (v1.6+ defaults to true)     #|
    #| cookieSameSite: SameSite attribute for cookies (v1.5+)                      #|
    #| =========================================================================== #|
    #% if oidc_refresh_token is defined %#
    refreshToken: #{ oidc_refresh_token }#
    #% endif %#
    #% if oidc_cookie_samesite is defined %#
    cookieSameSite: "#{ oidc_cookie_samesite }#"
    #% endif %#
    scopes:
    #% for scope in oidc_scopes | default(['openid', 'profile', 'email']) %#
      - "#{ scope }#"
    #% endfor %#
    # Forward access token to backend services
    forwardAccessToken: true
#% endif %#
