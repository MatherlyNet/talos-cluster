#% if keycloak_enabled | default(false) %#
#| ============================================================================= #|
#| KEYCLOAK REALM CONFIGURATION - ConfigMap for keycloak-config-cli             #|
#| Contains full realm configuration in Keycloak export format                  #|
#| Sensitive values use $(env:VAR) substitution - actual secrets in secrets.sops.yaml #|
#| REF: https://github.com/adorsys/keycloak-config-cli#variable-substitution    #|
#| ============================================================================= #|
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
  namespace: identity
data:
  realm.yaml: |
    realm: #{ keycloak_realm | default('matherlynet') }#
    enabled: true
    displayName: "#{ keycloak_realm | default('matherlynet') | title }# Realm"

    #| =========================================================================== #|
    #| SESSION SETTINGS                                                            #|
    #| =========================================================================== #|
    ssoSessionIdleTimeout: 1800
    ssoSessionMaxLifespan: 36000
    accessTokenLifespan: 300
    accessTokenLifespanForImplicitFlow: 900

    #| =========================================================================== #|
    #| LOGIN SETTINGS                                                              #|
    #| =========================================================================== #|
    registrationAllowed: false
    resetPasswordAllowed: true
    rememberMe: true
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false

    #| =========================================================================== #|
    #| BRUTE FORCE PROTECTION                                                      #|
    #| =========================================================================== #|
    bruteForceProtected: true
    permanentLockout: false
    maxFailureWaitSeconds: 900
    minimumQuickLoginWaitSeconds: 60
    waitIncrementSeconds: 60
    quickLoginCheckMilliSeconds: 1000
    maxDeltaTimeSeconds: 43200
    failureFactor: 5

    #| =========================================================================== #|
    #| REALM ROLES - Including auto-added IdP mapper roles                         #|
    #| =========================================================================== #|
#% set configured_role_names = [] %#
#% if keycloak_realm_roles is defined and keycloak_realm_roles %#
#%   for role in keycloak_realm_roles %#
#%     set _ = configured_role_names.append(role.name) %#
#%   endfor %#
#% endif %#
#% set idp_mapper_roles = [] %#
#% if google_default_role is defined and google_default_role %#
#%   if google_default_role not in configured_role_names and google_default_role not in idp_mapper_roles %#
#%     set _ = idp_mapper_roles.append(google_default_role) %#
#%   endif %#
#% endif %#
#% if google_domain_role_mapping is defined and google_domain_role_mapping.role is defined %#
#%   if google_domain_role_mapping.role not in configured_role_names and google_domain_role_mapping.role not in idp_mapper_roles %#
#%     set _ = idp_mapper_roles.append(google_domain_role_mapping.role) %#
#%   endif %#
#% endif %#
#% if github_default_role is defined and github_default_role %#
#%   if github_default_role not in configured_role_names and github_default_role not in idp_mapper_roles %#
#%     set _ = idp_mapper_roles.append(github_default_role) %#
#%   endif %#
#% endif %#
#% if github_org_role_mapping is defined and github_org_role_mapping.role is defined %#
#%   if github_org_role_mapping.role not in configured_role_names and github_org_role_mapping.role not in idp_mapper_roles %#
#%     set _ = idp_mapper_roles.append(github_org_role_mapping.role) %#
#%   endif %#
#% endif %#
#% if microsoft_default_role is defined and microsoft_default_role %#
#%   if microsoft_default_role not in configured_role_names and microsoft_default_role not in idp_mapper_roles %#
#%     set _ = idp_mapper_roles.append(microsoft_default_role) %#
#%   endif %#
#% endif %#
#% if microsoft_group_role_mappings is defined and microsoft_group_role_mappings %#
#%   for mapping in microsoft_group_role_mappings %#
#%     if mapping.role not in configured_role_names and mapping.role not in idp_mapper_roles %#
#%       set _ = idp_mapper_roles.append(mapping.role) %#
#%     endif %#
#%   endfor %#
#% endif %#
#% set has_roles = (keycloak_realm_roles is defined and keycloak_realm_roles | length > 0) or (idp_mapper_roles | length > 0) %#
#% if has_roles %#
    roles:
      realm:
#%   if keycloak_realm_roles is defined and keycloak_realm_roles %#
#%     for role in keycloak_realm_roles %#
        - name: "#{ role.name }#"
          description: "#{ role.description | default('Custom realm role') }#"
#%     endfor %#
#%   endif %#
#%   for role in idp_mapper_roles %#
        - name: "#{ role }#"
          description: "IdP mapper role (auto-added from *_default_role/*_role_mapping)"
#%   endfor %#
#% endif %#

    #| =========================================================================== #|
    #| OIDC CLIENTS                                                                #|
    #| =========================================================================== #|
#% if keycloak_bootstrap_oidc_client | default(false) or grafana_oidc_enabled | default(false) or litellm_oidc_enabled | default(false) %#
    clients:
#% if keycloak_bootstrap_oidc_client | default(false) %#
      #| Envoy Gateway SSO Client #|
      #| clientId and secret use $(env:VAR) substitution from keycloak-realm-secrets #|
      - clientId: "$(env:OIDC_CLIENT_ID)"
        name: "Envoy Gateway SSO"
        description: "OIDC client for Envoy Gateway SecurityPolicy - enables browser SSO across all protected applications"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:OIDC_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        #| =========================================================================== #|
        #| Redirect URIs - Explicit per-service (Keycloak does NOT support subdomain   #|
        #| wildcards like https://*.domain.com - only path wildcards are supported)    #|
        #| =========================================================================== #|
        redirectUris:
#% if hubble_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ hubble_subdomain | default('hubble') }#.#{ cloudflare_domain }#/oauth2/callback"
#% endif %#
#% if monitoring_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ grafana_subdomain | default('grafana') }#.#{ cloudflare_domain }#/oauth2/callback"
#% endif %#
#% if rustfs_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ rustfs_subdomain | default('rustfs') }#.#{ cloudflare_domain }#/oauth2/callback"
#% endif %#
#% if oidc_additional_redirect_uris is defined and oidc_additional_redirect_uris %#
#%   for uri in oidc_additional_redirect_uris %#
          - "#{ uri }#"
#%   endfor %#
#% endif %#
        #| Web origins for CORS - explicit per-service #|
        webOrigins:
#% if hubble_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ hubble_subdomain | default('hubble') }#.#{ cloudflare_domain }#"
#% endif %#
#% if monitoring_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ grafana_subdomain | default('grafana') }#.#{ cloudflare_domain }#"
#% endif %#
#% if rustfs_enabled | default(false) and oidc_sso_enabled | default(false) %#
          - "https://#{ rustfs_subdomain | default('rustfs') }#.#{ cloudflare_domain }#"
#% endif %#
#% if oidc_additional_web_origins is defined and oidc_additional_web_origins %#
#%   for origin in oidc_additional_web_origins %#
          - "#{ origin }#"
#%   endfor %#
#% endif %#
        #| Security: Require PKCE for authorization code flow #|
        attributes:
          pkce.code.challenge.method: "S256"
          #| Post-logout redirect URIs - explicit per-service #|
          post.logout.redirect.uris: >-
#% set logout_uris = [] %#
#% if hubble_enabled | default(false) and oidc_sso_enabled | default(false) %#
#%   set _ = logout_uris.append('https://' ~ (hubble_subdomain | default('hubble')) ~ '.' ~ cloudflare_domain ~ '/*') %#
#% endif %#
#% if monitoring_enabled | default(false) and oidc_sso_enabled | default(false) %#
#%   set _ = logout_uris.append('https://' ~ (grafana_subdomain | default('grafana')) ~ '.' ~ cloudflare_domain ~ '/*') %#
#% endif %#
#% if rustfs_enabled | default(false) and oidc_sso_enabled | default(false) %#
#%   set _ = logout_uris.append('https://' ~ (rustfs_subdomain | default('rustfs')) ~ '.' ~ cloudflare_domain ~ '/*') %#
#% endif %#
            #{ logout_uris | join('##') }#
        #| Default scopes for this client #|
        #| NOTE: 'openid' is implicit in OIDC protocol, not a configurable scope in Keycloak #|
        defaultClientScopes:
          - "profile"
          - "email"
        optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
#% endif %#
#% if grafana_oidc_enabled | default(false) %#
      #| =========================================================================== #|
      #| GRAFANA OIDC CLIENT - Native OAuth for Grafana RBAC                         #|
      #| Auto-created when grafana_oidc_enabled + grafana_oidc_client_secret set     #|
      #| Provides role-based access control via JMESPath role mapping                #|
      #| clientId and secret use $(env:VAR) substitution from keycloak-realm-secrets #|
      #| REF: docs/research/grafana-sso-authentication-integration-jan-2026.md       #|
      #| =========================================================================== #|
      - clientId: "$(env:GRAFANA_CLIENT_ID)"
        name: "Grafana"
        description: "OIDC client for Grafana native OAuth - provides RBAC and role-based access control"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:GRAFANA_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://#{ grafana_subdomain | default('grafana') }#.#{ cloudflare_domain }#/login/generic_oauth"
        webOrigins:
          - "https://#{ grafana_subdomain | default('grafana') }#.#{ cloudflare_domain }#"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://#{ grafana_subdomain | default('grafana') }#.#{ cloudflare_domain }#/*"
        #| NOTE: 'openid' is implicit in OIDC protocol, not a configurable scope in Keycloak #|
        defaultClientScopes:
          - "profile"
          - "email"
        optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
        #| Protocol mappers for role and group claims #|
        protocolMappers:
          #| Map realm roles to 'roles' claim for JMESPath role_attribute_path #|
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          #| Map groups to 'groups' claim for organization mapping #|
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
#% endif %#
#% if litellm_oidc_enabled | default(false) %#
      #| =========================================================================== #|
      #| LITELLM OIDC CLIENT - Native SSO for LiteLLM Proxy UI                       #|
      #| Auto-created when litellm_oidc_enabled + litellm_oidc_client_secret set     #|
      #| Provides role-based access control via OIDC claims                          #|
      #| clientId and secret use $(env:VAR) substitution from keycloak-realm-secrets #|
      #| REF: docs/research/litellm-proxy-gateway-integration-jan-2026.md            #|
      #| =========================================================================== #|
      - clientId: "$(env:LITELLM_CLIENT_ID)"
        name: "LiteLLM"
        description: "OIDC client for LiteLLM Proxy - enables SSO for Admin UI and API authentication"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:LITELLM_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://#{ litellm_subdomain | default('litellm') }#.#{ cloudflare_domain }#/*"
          - "https://#{ litellm_subdomain | default('litellm') }#.#{ cloudflare_domain }#/sso/callback"
        webOrigins:
          - "https://#{ litellm_subdomain | default('litellm') }#.#{ cloudflare_domain }#"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://#{ litellm_subdomain | default('litellm') }#.#{ cloudflare_domain }#/*"
        #| NOTE: 'openid' is implicit in OIDC protocol, not a configurable scope in Keycloak #|
        defaultClientScopes:
          - "profile"
          - "email"
        optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
        #| Protocol mappers for role and group claims #|
        protocolMappers:
          #| Map realm roles to 'roles' claim for LiteLLM team/role mapping #|
          - name: "realm-roles"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            consentRequired: false
            config:
              claim.name: "roles"
              jsonType.label: "String"
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          #| Map groups to 'groups' claim for team assignment #|
          - name: "groups"
            protocol: "openid-connect"
            protocolMapper: "oidc-group-membership-mapper"
            consentRequired: false
            config:
              claim.name: "groups"
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
#% endif %#
#% if langfuse_sso_enabled | default(false) %#
      #| =========================================================================== #|
      #| LANGFUSE OIDC CLIENT - SSO for LLM Observability Platform                  #|
      #| Auto-created when langfuse_sso_enabled + langfuse_keycloak_client_secret   #|
      #| Provides authentication for Langfuse web UI and API                        #|
      #| clientId and secret use $(env:VAR) substitution from keycloak-realm-secrets #|
      #| REF: docs/research/langfuse-llm-observability-integration-jan-2026.md      #|
      #| =========================================================================== #|
      - clientId: "$(env:LANGFUSE_CLIENT_ID)"
        name: "Langfuse"
        description: "OIDC client for Langfuse LLM Observability - enables SSO for tracing, prompts, and evaluation"
        enabled: true
        publicClient: false
        clientAuthenticatorType: "client-secret"
        secret: "$(env:LANGFUSE_CLIENT_SECRET)"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: "openid-connect"
        redirectUris:
          - "https://#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#/api/auth/callback/keycloak"
        webOrigins:
          - "https://#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#"
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://#{ langfuse_subdomain | default('langfuse') }#.#{ cloudflare_domain }#/*"
        #| NOTE: 'openid' is implicit in OIDC protocol, not a configurable scope in Keycloak #|
        defaultClientScopes:
          - "profile"
          - "email"
        optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
#% endif %#
#% endif %#

#% if google_idp_enabled | default(false) or github_idp_enabled | default(false) or microsoft_idp_enabled | default(false) %#
    #| =========================================================================== #|
    #| SOCIAL IDENTITY PROVIDERS - OAuth/OIDC Federation                           #|
    #| Conditionally include IdPs based on *_idp_enabled flags in cluster.yaml     #|
    #| Users authenticate via social accounts on the Keycloak login page           #|
    #| clientId and clientSecret use $(env:VAR) substitution from keycloak-realm-secrets #|
    #| REF: docs/research/keycloak-social-identity-providers-integration-jan-2026.md #|
    #| =========================================================================== #|
    identityProviders:
#% if google_idp_enabled | default(false) %#
      - alias: "google"
        displayName: "Google"
        providerId: "google"
        enabled: true
        trustEmail: true
        storeToken: true
        linkOnly: false
        firstBrokerLoginFlowAlias: "first broker login"
        config:
          clientId: "$(env:GOOGLE_CLIENT_ID)"
          clientSecret: "$(env:GOOGLE_CLIENT_SECRET)"
          defaultScope: "openid profile email"
          syncMode: "IMPORT"
#% endif %#
#% if github_idp_enabled | default(false) %#
      - alias: "github"
        displayName: "GitHub"
        providerId: "github"
        enabled: true
        trustEmail: true
        storeToken: true
        linkOnly: false
        firstBrokerLoginFlowAlias: "first broker login"
        config:
          clientId: "$(env:GITHUB_CLIENT_ID)"
          clientSecret: "$(env:GITHUB_CLIENT_SECRET)"
          defaultScope: "user:email"
          syncMode: "IMPORT"
#% endif %#
#% if microsoft_idp_enabled | default(false) %#
      - alias: "microsoft"
        displayName: "Microsoft"
        providerId: "oidc"
        enabled: true
        trustEmail: true
        storeToken: true
        linkOnly: false
        firstBrokerLoginFlowAlias: "first broker login"
        config:
          clientId: "$(env:MICROSOFT_CLIENT_ID)"
          clientSecret: "$(env:MICROSOFT_CLIENT_SECRET)"
          authorizationUrl: "https://login.microsoftonline.com/$(env:MICROSOFT_TENANT_ID)/oauth2/v2.0/authorize"
          tokenUrl: "https://login.microsoftonline.com/$(env:MICROSOFT_TENANT_ID)/oauth2/v2.0/token"
          userInfoUrl: "https://graph.microsoft.com/oidc/userinfo"
          jwksUrl: "https://login.microsoftonline.com/$(env:MICROSOFT_TENANT_ID)/discovery/v2.0/keys"
          issuer: "https://login.microsoftonline.com/$(env:MICROSOFT_TENANT_ID)/v2.0"
          defaultScope: "openid profile email"
          syncMode: "FORCE"
          validateSignature: "true"
          useJwksUrl: "true"
#% endif %#
#% endif %#

#% set has_mappers = (google_default_role is defined and google_default_role) or
                     (google_domain_role_mapping is defined and google_domain_role_mapping) or
                     (github_default_role is defined and github_default_role) or
                     (github_org_role_mapping is defined and github_org_role_mapping) or
                     (microsoft_default_role is defined and microsoft_default_role) or
                     (microsoft_group_role_mappings is defined and microsoft_group_role_mappings) %#
#% if has_mappers %#
    #| =========================================================================== #|
    #| IDENTITY PROVIDER MAPPERS - Automatic Role Assignment                       #|
    #| Maps IdP attributes/claims to Keycloak roles during user login              #|
    #| REF: docs/research/keycloak-social-identity-providers-integration-jan-2026.md #|
    #| =========================================================================== #|
    identityProviderMappers:
#% if google_idp_enabled | default(false) %#
#% if google_default_role is defined and google_default_role %#
      #| Google: Hardcoded role for all Google users #|
      - name: "google-default-role"
        identityProviderAlias: "google"
        identityProviderMapper: "oidc-hardcoded-role-idp-mapper"
        config:
          syncMode: "INHERIT"
          role: "#{ google_default_role }#"
#% endif %#
#% if google_domain_role_mapping is defined and google_domain_role_mapping %#
      #| Google: Map hosted domain (hd claim) to role #|
      - name: "google-domain-#{ google_domain_role_mapping.domain | replace('.', '-') }#"
        identityProviderAlias: "google"
        identityProviderMapper: "oidc-role-idp-mapper"
        config:
          syncMode: "INHERIT"
          claim: "hd"
          claim.value: "#{ google_domain_role_mapping.domain }#"
          role: "#{ google_domain_role_mapping.role }#"
#% endif %#
#% endif %#
#% if github_idp_enabled | default(false) %#
#% if github_default_role is defined and github_default_role %#
      #| GitHub: Hardcoded role for all GitHub users #|
      - name: "github-default-role"
        identityProviderAlias: "github"
        identityProviderMapper: "oidc-hardcoded-role-idp-mapper"
        config:
          syncMode: "INHERIT"
          role: "#{ github_default_role }#"
#% endif %#
#% if github_org_role_mapping is defined and github_org_role_mapping %#
      #| GitHub: Map organization membership to role (requires read:org scope) #|
      - name: "github-org-#{ github_org_role_mapping.org }#"
        identityProviderAlias: "github"
        identityProviderMapper: "oidc-advanced-role-idp-mapper"
        config:
          syncMode: "FORCE"
          claims: "[{\"key\":\"organizations_url\",\"value\":\".*#{ github_org_role_mapping.org }#.*\"}]"
          are.claim.values.regex: "true"
          role: "#{ github_org_role_mapping.role }#"
#% endif %#
#% endif %#
#% if microsoft_idp_enabled | default(false) %#
#% if microsoft_default_role is defined and microsoft_default_role %#
      #| Microsoft: Hardcoded role for all Microsoft users #|
      - name: "microsoft-default-role"
        identityProviderAlias: "microsoft"
        identityProviderMapper: "oidc-hardcoded-role-idp-mapper"
        config:
          syncMode: "INHERIT"
          role: "#{ microsoft_default_role }#"
#% endif %#
#% if microsoft_group_role_mappings is defined and microsoft_group_role_mappings %#
#% for mapping in microsoft_group_role_mappings %#
      #| Microsoft: Map Entra ID group to role #|
      - name: "microsoft-group-#{ mapping.role | replace('.', '-') }#"
        identityProviderAlias: "microsoft"
        identityProviderMapper: "oidc-advanced-role-idp-mapper"
        config:
          syncMode: "FORCE"
          claims: "[{\"key\":\"groups\",\"value\":\".*#{ mapping.group_id }#.*\"}]"
          are.claim.values.regex: "true"
          role: "#{ mapping.role }#"
#% endfor %#
#% endif %#
#% endif %#
#% endif %#
#% endif %#
