---
# yamllint disable rule:line-length
name: Markdown Link Check

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: "0 0 * * 1"
  push:
    branches:
      - main
    paths:
      - "docs/**/*.md"
      - "*.md"
      - ".github/workflows/markdown-link-check.yaml"
  pull_request:
    paths:
      - "docs/**/*.md"
      - "*.md"
      - ".github/workflows/markdown-link-check.yaml"

jobs:
  markdown-link-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create file list excluding archived content
        id: file-list
        run: |
          # Find all markdown files excluding archived directories
          # Archived content represents frozen snapshots and doesn't need link validation
          FILES=$(find docs/ -name "*.md" \
            -not -path "*/archived/*" \
            -not -path "*/archive/*" \
            -not -path "*/serena-archive/*" | tr '\n' ',' | sed 's/,$//')
          # Add root markdown files
          FILES="./README.md,./CLAUDE.md,./PROJECT_INDEX.md,$FILES"
          echo "file-list=$FILES" >> $GITHUB_OUTPUT
          echo "Found $(echo $FILES | tr ',' '\n' | wc -l) markdown files (excluding archived content)"

      - name: Check links in markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "no"
          config-file: ".github/workflows/markdown-link-check-config.json"
          file-path: "${{ steps.file-list.outputs.file-list }}"
          check-modified-files-only: "no"

      - name: Report results
        if: failure()
        run: |
          echo "::error::Broken links detected in markdown files"
          echo "Please check the workflow logs for details"
          exit 1
