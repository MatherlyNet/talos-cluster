---
version: "3"

vars:
  TOFU_DIR: "{{.INFRASTRUCTURE_DIR}}/tofu"
  SECRETS_FILE: "{{.INFRASTRUCTURE_DIR}}/secrets.sops.yaml"

env:
  # R2 checksum workaround for OpenTofu 1.11+
  AWS_REQUEST_CHECKSUM_CALCULATION: when_required
  AWS_RESPONSE_CHECKSUM_VALIDATION: when_required

tasks:
  init:
    desc: Initialize OpenTofu with R2 backend
    dir: "{{.TOFU_DIR}}"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        tofu init {{.CLI_ARGS}}
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which tofu sops yq

  plan:
    desc: Run OpenTofu plan
    dir: "{{.TOFU_DIR}}"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu plan -out=tfplan {{.CLI_ARGS}}
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which tofu sops yq

  apply:
    desc: Apply OpenTofu plan
    dir: "{{.TOFU_DIR}}"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu apply {{.CLI_ARGS}} tfplan
    preconditions:
      - test -f {{.TOFU_DIR}}/tfplan
      - test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which tofu sops yq

  apply-auto:
    desc: Apply OpenTofu changes without plan file (auto-approve)
    dir: "{{.TOFU_DIR}}"
    prompt: "This will apply changes without a saved plan. Continue?"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu apply -auto-approve {{.CLI_ARGS}}
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which tofu sops yq

  destroy:
    desc: Destroy OpenTofu-managed resources
    dir: "{{.TOFU_DIR}}"
    prompt: "This will DESTROY all managed infrastructure. Continue?"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu destroy {{.CLI_ARGS}}
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which tofu sops yq

  output:
    desc: Show OpenTofu outputs
    dir: "{{.TOFU_DIR}}"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu output {{.CLI_ARGS}}
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - which tofu sops yq

  state-list:
    desc: List resources in OpenTofu state
    dir: "{{.TOFU_DIR}}"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        export TF_VAR_proxmox_api_token_id=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_id // ""')
        export TF_VAR_proxmox_api_token_secret=$(sops -d {{.SECRETS_FILE}} | yq -r '.proxmox_api_token_secret // ""')
        tofu state list
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - which tofu sops yq

  force-unlock:
    desc: Force unlock the state [LOCK_ID=required]
    dir: "{{.TOFU_DIR}}"
    prompt: "Force unlocking state can be dangerous. Continue?"
    cmds:
      - |
        export TF_HTTP_USERNAME=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_username')
        export TF_HTTP_PASSWORD=$(sops -d {{.SECRETS_FILE}} | yq -r '.tfstate_password')
        tofu force-unlock {{.LOCK_ID}}
    requires:
      vars: [LOCK_ID]
    preconditions:
      - test -f {{.SECRETS_FILE}}
      - which tofu sops yq

  validate:
    desc: Validate OpenTofu configuration
    dir: "{{.TOFU_DIR}}"
    cmd: tofu validate
    preconditions:
      - which tofu

  fmt:
    desc: Format OpenTofu configuration
    dir: "{{.TOFU_DIR}}"
    cmd: tofu fmt -recursive
    preconditions:
      - which tofu

  fmt-check:
    desc: Check OpenTofu formatting
    dir: "{{.TOFU_DIR}}"
    cmd: tofu fmt -check -recursive
    preconditions:
      - which tofu

  secrets-edit:
    desc: Edit infrastructure secrets
    cmd: sops {{.SECRETS_FILE}}
    preconditions:
      - msg: "Secrets file not found. Run 'task configure' first to generate it."
        sh: test -f {{.SECRETS_FILE}}
      - test -f {{.SOPS_AGE_KEY_FILE}}
      - which sops

  verify-nodes:
    desc: Verify all nodes are accessible in Talos maintenance mode
    vars:
      NODES_FILE: "{{.ROOT_DIR}}/nodes.yaml"
    cmds:
      - |
        echo "Verifying node accessibility (maintenance mode port 50000)..."
        failed=0
        for ip in $(yq -r '.nodes[].address' {{.NODES_FILE}}); do
          name=$(yq -r ".nodes[] | select(.address == \"$ip\") | .name" {{.NODES_FILE}})
          if talosctl -n "$ip" disks --insecure >/dev/null 2>&1; then
            echo "✓ $name ($ip) - ready"
          else
            echo "✗ $name ($ip) - not accessible"
            failed=$((failed + 1))
          fi
        done
        if [ $failed -gt 0 ]; then
          echo ""
          echo "ERROR: $failed node(s) not accessible. Check:"
          echo "  - VMs are powered on in Proxmox"
          echo "  - Network connectivity to node VLAN"
          echo "  - Firewall allows port 50000"
          exit 1
        fi
        echo ""
        echo "All nodes ready for bootstrap!"
    preconditions:
      - msg: "nodes.yaml not found. Run 'task init' first."
        sh: test -f {{.NODES_FILE}}
      - msg: "No nodes defined in nodes.yaml"
        sh: "[ $(yq '.nodes | length' {{.NODES_FILE}}) -gt 0 ]"
      - which talosctl yq