#% if monitoring_enabled is defined and monitoring_enabled and loki_enabled | default(false) %#
---
# CRITICAL COHESION: Grafana is disabled here - it's deployed by VictoriaMetrics stack only.
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  chartRef:
    kind: OCIRepository
    name: loki
  interval: 1h
  values:
    deploymentMode: SingleBinary
    loki:
      auth_enabled: false
      commonConfig:
        replication_factor: 1
      schemaConfig:
        configs:
          - from: 2024-01-01
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h
      storage:
        type: filesystem
      limits_config:
        retention_period: "#{ logs_retention | default('7d') }#"
        ingestion_rate_mb: 10
        ingestion_burst_size_mb: 20
    singleBinary:
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi
      persistence:
        enabled: true
        size: "#{ logs_storage_size | default('50Gi') }#"
    gateway:
      enabled: false
    # COHESION: Disable components deployed by victoria-metrics-k8s-stack
    # Grafana is deployed by VictoriaMetrics stack - DO NOT enable here
    grafana:
      enabled: false
    # Promtail is deprecated - use Alloy instead
    promtail:
      enabled: false
    # Chunk cache
    chunksCache:
      enabled: false
    resultsCache:
      enabled: false
    # Monitoring - ServiceMonitor for VictoriaMetrics to scrape
    monitoring:
      dashboards:
        enabled: true
        namespace: monitoring
      serviceMonitor:
        enabled: true
#% endif %#