#% if oidc_sso_enabled %#
---
# SecurityPolicy for OIDC-based Web SSO authentication
# REF: https://gateway.envoyproxy.io/docs/tasks/security/oidc/
# REF: docs/guides/native-oidc-securitypolicy-implementation.md
# REF: docs/research/envoy-gateway-keycloak-oidc-integration-jan-2026.md
#
# NOTE: This cluster uses Envoy Gateway v0.0.0-latest for Kubernetes 1.35 support.
# API Version: gateway.envoyproxy.io/v1alpha1 (SecurityPolicy has not graduated to v1)
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-sso
  namespace: network
spec:
  # Target HTTPRoutes with the security: oidc-protected label
  # NOTE: SecurityPolicy can only target resources in the same namespace
  targetSelectors:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      matchLabels:
        security: oidc-protected
  oidc:
    provider:
      issuer: "#{ oidc_issuer_url }#"
      #| ======================================================================= #|
      #| OIDC Endpoints Configuration                                           #|
      #| External authorizationEndpoint for user browser redirects              #|
      #| Internal tokenEndpoint for server-to-server token exchange             #|
      #| ======================================================================= #|
      #% if keycloak_enabled | default(false) %#
      #| User-facing authorization - always external via Cloudflare Tunnel #|
      authorizationEndpoint: "https://#{ keycloak_hostname }#/realms/#{ keycloak_realm }#/protocol/openid-connect/auth"
      #| Server-to-server token exchange - use internal service to avoid TLS issues with Cloudflare #|
      tokenEndpoint: "http://keycloak-service.identity.svc.cluster.local:8080/realms/#{ keycloak_realm }#/protocol/openid-connect/token"
      #| Specify backend for internal OIDC provider connections #|
      backendRefs:
        - name: keycloak-service
          namespace: identity
          port: 8080
      #% else %#
      #% if oidc_authorization_endpoint is defined %#
      authorizationEndpoint: "#{ oidc_authorization_endpoint }#"
      #% endif %#
      #% if oidc_token_endpoint is defined %#
      tokenEndpoint: "#{ oidc_token_endpoint }#"
      #% endif %#
      #% endif %#
    clientID: "#{ oidc_client_id }#"
    clientSecret:
      name: oidc-client-secret
    #| =========================================================================== #|
    #| REDIRECT URL CONFIGURATION                                                  #|
    #| If oidc_redirect_url is NOT specified, Envoy Gateway uses the dynamic      #|
    #| default: %REQ(x-forwarded-proto)%://%REQ(:authority)%/oauth2/callback      #|
    #| This allows multi-subdomain SSO without hardcoding each hostname           #|
    #| =========================================================================== #|
    #% if oidc_redirect_url is defined and oidc_redirect_url and '*' not in oidc_redirect_url %#
    redirectURL: "#{ oidc_redirect_url }#"
    #% endif %#
    logoutPath: "#{ oidc_logout_path | default('/logout') }#"
    #% if oidc_cookie_domain is defined %#
    cookieDomain: "#{ oidc_cookie_domain }#"
    #% endif %#
    #| =========================================================================== #|
    #| OIDC COOKIE SETTINGS (v1.5+/v1.6+ features)                                 #|
    #| =========================================================================== #|
    #| refreshToken: Auto-refresh tokens when expired (v1.6+ defaults to true)     #|
    #| cookieSameSite: SameSite attribute for cookies (v1.5+)                      #|
    #| =========================================================================== #|
    #% if oidc_refresh_token is defined %#
    refreshToken: #{ oidc_refresh_token }#
    #% endif %#
    #% if oidc_cookie_samesite is defined %#
    cookieSameSite: "#{ oidc_cookie_samesite }#"
    #% endif %#
    scopes:
    #% for scope in oidc_scopes | default(['openid', 'profile', 'email']) %#
      - "#{ scope }#"
    #% endfor %#
    # Forward access token to backend services
    forwardAccessToken: true
#% endif %#
