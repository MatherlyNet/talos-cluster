apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: matherlynet-realm
  namespace: identity
spec:
  keycloakCRName: keycloak
  realm:
    realm: matherlynet
    enabled: true
    displayName: Matherlynet Realm
    ssoSessionIdleTimeout: 1800
    ssoSessionMaxLifespan: 36000
    accessTokenLifespan: 300
    accessTokenLifespanForImplicitFlow: 900
    registrationAllowed: false
    resetPasswordAllowed: true
    rememberMe: true
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false
    bruteForceProtected: true
    permanentLockout: false
    maxFailureWaitSeconds: 900
    minimumQuickLoginWaitSeconds: 60
    waitIncrementSeconds: 60
    quickLoginCheckMilliSeconds: 1000
    maxDeltaTimeSeconds: 43200
    failureFactor: 5
    roles:
      realm:
        - name: admin
          description: Full administrative access to all applications and settings
        - name: operator
          description: Operational access - manage services, view logs, restart pods
        - name: developer
          description: Development access - CI/CD, debugging tools, dev environments
        - name: viewer
          description: Read-only access to dashboards and status pages
        - name: user
          description: Basic authenticated user access to standard applications
    clients:
      - clientId: ENC[AES256_GCM,data:NdP6R2P77qB/VL9YOQ==,iv:wP6IACWV5j66I93qTBi16ktCZ728eOvqnmRPhKE5/l4=,tag:2Z52mfj9y+TgtoHzm10JWw==,type:str]
        name: Envoy Gateway SSO
        description: OIDC client for Envoy Gateway SecurityPolicy - enables browser SSO across all protected applications
        enabled: true
        publicClient: false
        clientAuthenticatorType: client-secret
        secret: ENC[AES256_GCM,data:iri7bBwC1OBaTMUv7sl3KuZ/KF4fkSQem2+eOaM1hX28p59aDBCEyJ5kgwHdoQaF+Bov9DityF7N0d7ijNcnxA==,iv:TnaNWkZyDbcjbZhcYsirq86m5yLyWQ10yiy02pY7S/o=,tag:dDnz8k0wosdhg4GqWd0FaA==,type:str]
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: openid-connect
        redirectUris:
          - https://hubble.matherly.net/oauth2/callback
          - https://grafana.matherly.net/oauth2/callback
          - https://rustfs.matherly.net/oauth2/callback
        webOrigins:
          - https://hubble.matherly.net
          - https://grafana.matherly.net
          - https://rustfs.matherly.net
        attributes:
          pkce.code.challenge.method: S256
          post.logout.redirect.uris: https://hubble.matherly.net/*##https://grafana.matherly.net/*##https://rustfs.matherly.net/*
        defaultClientScopes:
          - openid
          - profile
          - email
        optionalClientScopes:
          - address
          - phone
          - offline_access
      - clientId: ENC[AES256_GCM,data:Q/AZXxPozA==,iv:glpwVxBBB7aL68K6ynzPxbcBMyNT2U7T7JjfUAoC8eg=,tag:TKQVqA2qtdaZsAvRino2zg==,type:str]
        name: Grafana
        description: OIDC client for Grafana native OAuth - provides RBAC and role-based access control
        enabled: true
        publicClient: false
        clientAuthenticatorType: client-secret
        secret: ENC[AES256_GCM,data:uq9LRucRWW6/Lm83+Wo2ahu4A1Q+mpw9SCn6x4Ypul3fp0rnlVcnFOvf7QTfbwx2mlyR2zVkq+642PISektC1g==,iv:R2sp5FOFjBlqV12f2hYSAHFIhKFFV5inGbJKEqHruOA=,tag:gCJKnP2XmyCJuscjx/6lew==,type:str]
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        implicitFlowEnabled: false
        protocol: openid-connect
        redirectUris:
          - https://grafana.matherly.net/login/generic_oauth
        webOrigins:
          - https://grafana.matherly.net
        attributes:
          pkce.code.challenge.method: S256
          post.logout.redirect.uris: https://grafana.matherly.net/*
        defaultClientScopes:
          - openid
          - profile
          - email
        optionalClientScopes:
          - address
          - phone
          - offline_access
        protocolMappers:
          - name: realm-roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              claim.name: roles
              jsonType.label: String
              multivalued: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-group-membership-mapper
            consentRequired: false
            config:
              claim.name: groups
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
    identityProviders:
      - alias: google
        displayName: Google
        providerId: google
        enabled: true
        trustEmail: true
        storeToken: true
        linkOnly: false
        firstBrokerLoginFlowAlias: first broker login
        config:
          clientId: ENC[AES256_GCM,data:Zquaj0+bO/cr5hL10Vx6PUgnvRw+Jjl/g8ApOJca+C6cgdIsx2t28WbBqjBbyzoriEXsrdDsK7k5SbgzFDW4pEHhrWrTkBXu,iv:S2qCfs6LMVRZcN+HkB0by6h6P3eRTOjlTGg2RgdT0k0=,tag:4yZGZdNS1lXOSlsBDFE6eA==,type:str]
          clientSecret: ENC[AES256_GCM,data:+EqVZ17f3L7oYsquW0mxGT0ypdXD+OzvY6o/hYV9CStOTJA=,iv:Gkp4a9U6IoUapjWjGVEh6r5MXZk6ATxZDDlt2yOqZuw=,tag:uHMZYpe2Mc3ZDdhHlp6SkA==,type:str]
          defaultScope: openid profile email
          syncMode: IMPORT
    identityProviderMappers:
      - name: google-default-role
        identityProviderAlias: google
        identityProviderMapper: oidc-hardcoded-role-idp-mapper
        config:
          syncMode: INHERIT
          role: admin
sops:
  age:
    - recipient: age1rqvr6f3l6hxc5dn9q2n7edzvrklj2sz3q9djlp9rtqc8hfa6447saqpaqn
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5ek1oc0ZUV3Y1TXFZS1lQ
        WDJhZzVyeWpyVjRUSGpDbUZiRVc3UnFzV1M4CkZlWWNoVzZ2azZQZ2MrRW5lc0xh
        UmZyT2F4YjFvYXpCMXQvRXp3NDNxQjAKLS0tIG5jQkdDT0w2cHRPY2YyRmZhb1dG
        bUl3MEl1OHkrZ2MrU2Q5aGpZRjkrL1UKvvvaqjlUlvcDq5/0URzIQRBPOX0zOOp0
        hcWehWcch/IpLnk5x7z3gzd/Ysu5TuzXpi8qJZ7B+QVa1LsmIUJkug==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2026-01-08T21:04:35Z"
  mac: ENC[AES256_GCM,data:kvq+JnEG4iIdbTMV+41TZToktICKkqoBHCq61F/2KhG0oo0wJImb2DU+0JuE/kyb2iRfiAQkTUiyfaOxv82fr6Y95R8OQ8ASPYvsr+isAQBvhJDq1wMbeRaNXj4MXcHmaahoh4dVk3p2e2CNk7YhSZXLj1xbdPc6okYr2lxOvfw=,iv:duN5zF1emihIgj2hfdRD5J6fNfjWKh+0VXnxqgThG/U=,tag:wdpXMWP8VCoUoYdXbcarsw==,type:str]
  encrypted_regex: ^(clientId|clientSecret|secret)$
  mac_only_encrypted: true
  version: 3.11.0
